/*! For license information please see 136.js.LICENSE.txt */
(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[136],{42606:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>D});var n=i(97542),s=i(61864),a=i(92810),o=i(23379),r=i(83141),d=i(9037),h=i(53954),l=i(65636),c=i(93642),m=i(49219),u=i(92001),p=i(14439),g=i(96042),y=i(34029),v=i(32597),w=i(43736),b=i(71776),f=i(45786),T=i(53203);class D extends n.Y{constructor(){super(...arguments),this.name="quick-menus"}async init(e,t){this.settingsModule=await t.getModuleBySymbol(s.Ak),this.scanInfoDataModule=await t.getModuleBySymbol(a.$q),this.settingsGui=this.settingsModule.getSettingsGui();const i=await t.getModuleBySymbol(o.DeepLinksModuleKey),n=await t.market.waitForData(h.Z),D=await t.market.waitForData(y.e),C=await t.market.waitForData(d.M);this.uIndex=this.settingsGui.addPanel("Link to location",[v.R.U],{allowSubGroups:!1,width:400,ratio:90});const P=[38,38,40,40,37,39,37,39,66,65,v.R.O];this.oIndex=this.settingsGui.addPanel("Scan Info",P,{allowSubGroups:!1,width:400,ratio:75}),this.pIndex=this.settingsGui.addPanel("Quick settings",[v.R.P],{allowSubGroups:!1}),this.settingsGui.loadPromise.then((()=>{this.settingsGui.addControl(this.uIndex,"","Link",{}),this.settingsGui.addButton(this.uIndex,"","Copy to clipboard",(()=>{const e=document.createElement("input");e.type="text",e.value=this.buildLink(i),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)})),this.settingsGui.toggle(this.uIndex),this.settingsGui.addControl(this.oIndex,"","Scan ID",{}),this.settingsGui.addControl(this.oIndex,"","Anchor ID",{}),this.settingsGui.addControl(this.oIndex,"","Created",{}),this.settingsGui.addControl(this.oIndex,"","Time of Day",{}),this.settingsGui.addControl(this.oIndex,"","Alignment",{}),this.settingsGui.addControl(this.oIndex,"","Options",{}),this.settingsGui.addControl(this.oIndex,"","Camera",{}),this.settingsGui.addControl(this.oIndex,"","Camera Types",{}),this.settingsGui.addControl(this.oIndex,"","Sensor Serials",{}),this.settingsGui.addControl(this.oIndex,"","Serial Number",{}),this.settingsGui.addControl(this.oIndex,"","Mount Calibration",{}),this.settingsGui.addControl(this.oIndex,"","Software Version",{}),this.settingsGui.addButton(this.oIndex,"","Copy Scan ID",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanInfo(n.currentSweep);if(e){const t=document.createElement("input");t.type="text",t.value=e.id,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}}})),this.settingsGui.addButton(this.oIndex,"","Download Scan",(async()=>{if(n.currentSweep){const e=await this.scanInfoDataModule.getScanDownloadURL(n.currentSweep);e&&window.open(e)}})),this.settingsGui.toggle(this.oIndex);const e=c.WI*(180/Math.PI)*60;this.settingsGui.addControl(this.pIndex,"",u.U,!0),this.settingsGui.addControl(this.pIndex,"",w.s,!0),this.settingsGui.addControl(this.pIndex,"",b.re,!0),this.settingsGui.addControl(this.pIndex,"",f.b,!0),this.settingsGui.addSlider(this.pIndex,"",T.NR,T.Kb,0,100,1),this.settingsGui.addSlider(this.pIndex,"",m.lookAccelerationKey,e,.25,10,2),this.settingsGui.addSlider(this.pIndex,"",r.baseTransitionSpeedKey,l.ZP.camera.baseTransitionTime,1,5e3,0);const t=D.tryGetProperty(p.EU,p.Im);this.settingsGui.addSlider(this.pIndex,"",p.WQ,(0,g.JG)(t),.5,10,2),this.settingsGui.toggle(this.pIndex),this.settingsModule.registerSetting("Quick settings",m.lookAccelerationKey,e,!1),this.settingsModule.registerSetting("Quick settings",r.baseTransitionSpeedKey,l.ZP.camera.baseTransitionTime,!1),this.settingsModule.registerSetting("Quick settings",T.NR,T.Kb,!1),this.settingsGui.onToggle(this.uIndex,(e=>{e&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i))})),this.settingsGui.onToggle(this.oIndex,(e=>{e&&this.refreshScanInfo(n)})),C.pose.onChanged((()=>{this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.uIndex)&&this.settingsGui.updateSetting(this.uIndex,"Link",this.buildLink(i)),this.settingsGui.isLoaded&&this.settingsGui.isVisible(this.oIndex)&&this.refreshScanInfo(n)})),D.onPropertyChanged(p.WQ,(e=>{D.setProperty(p.EU,(0,g.HG)(e))}))}))}refreshScanInfo(e){e.currentSweep?this.scanInfoDataModule.getScanInfo(e.currentSweep).then((e=>{this.updateScanInfo(e)})):this.updateScanInfo(void 0)}updateScanInfo(e){this.settingsGui.updateSetting(this.oIndex,"Scan ID",e?e.id:""),this.settingsGui.updateSetting(this.oIndex,"Anchor ID",e?e.anchorId:""),this.settingsGui.updateSetting(this.oIndex,"Created",e?e.created:""),this.settingsGui.updateSetting(this.oIndex,"Time of Day",e?e.timeOfDay:""),this.settingsGui.updateSetting(this.oIndex,"Alignment",e?e.alignment:""),this.settingsGui.updateSetting(this.oIndex,"Options",e?JSON.stringify(e.options):""),this.settingsGui.updateSetting(this.oIndex,"Camera",e?`${e.camera.vendor} ${e.camera.model}`:""),this.settingsGui.updateSetting(this.oIndex,"Camera Types",e?JSON.stringify(e.camera.cameraTypes):""),this.settingsGui.updateSetting(this.oIndex,"Sensor Serials",e?JSON.stringify(e.camera.sensorSerialNumbers):""),this.settingsGui.updateSetting(this.oIndex,"Serial Number",e?e.camera.serialNumber:""),this.settingsGui.updateSetting(this.oIndex,"Mount Calibration",e?e.camera.mountCalibrationVersion:""),this.settingsGui.updateSetting(this.oIndex,"Software Version",e?e.camera.softwareVersion:"")}buildLink(e){return decodeURIComponent(e.creator.createDeepLink().href)}}},95724:(e,t,i)=>{"use strict";i.d(t,{o:()=>n});class n{constructor(e){this.config=e}serialize(e){const{serializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.serialize(n);e&&i.push(e)}return i}deserialize(e){const{deserializer:t}=this.config;if(!e||!Array.isArray(e)||!t)return null;const i=[];for(const n of e){const e=t.deserialize(n);e&&i.push(e)}return i}}},2290:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AnnotationAttachmentClickedMessage:()=>c.q,AnnotationBlockClickedMessage:()=>c.i,AnnotationType:()=>m.J,AnnotationsViewData:()=>r.A,CloseAnnotationCommand:()=>d.Aj,CloseBillboardCommand:()=>d.G5,CloseDockedAnnotationCommand:()=>d.JD,CloseOtherAnnotationsCommand:()=>d.yL,DockAnnotationCommand:()=>d.bd,PreviewAnnotationCommand:()=>d.Kw,SelectAnnotationCommand:()=>d.oM,default:()=>u});var n=i(97542),s=i(40964),a=i(54244),o=i(80742),r=i(16935),d=i(43470),h=i(96154);class l extends n.Y{constructor(){super(...arguments),this.name="annotations",this.handleDockAnnotation=async e=>{const t=this.viewData,{dockedAnnotation:i}=t,{id:n,annotationType:s,force:a}=e;(this.viewData.getCapabilities(n).dock||a)&&((null==i?void 0:i.id)!==n||(null==i?void 0:i.annotationType)!==s?t.atomic((()=>{t.setDockedAnnotation(n,s),t.setBillboardAnnotation(null)})):this.log.debug("Annotation is already docked"))},this.handleSelectAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,billboardSelected:n}=t,{id:s,annotationType:a,force:o}=e;(this.viewData.getCapabilities(s).preview||o)&&(n&&(null==i?void 0:i.id)===s&&(null==i?void 0:i.annotationType)===a?this.log.debug("Annotation is already selected"):t.atomic((()=>{t.setBillboardAnnotation(s,a,!0),t.setDockedAnnotation(null)})))},this.handlePreviewAnnotation=async e=>{this.viewData.getCapabilities(e.id).preview&&this.viewData.setBillboardAnnotation(e.id,e.annotationType,!1)},this.handleCloseBillboard=async()=>{this.viewData.setBillboardAnnotation(null)},this.handleCloseDockedAnnotation=async()=>{this.viewData.setDockedAnnotation(null)},this.handleClosingOtherAnnotations=async e=>{const{exceptType:t,exceptId:i}=e;this.closeOtherAnnotations(t,i)},this.closeOtherAnnotations=(e,t)=>{const i=this.viewData,{billboardAnnotation:n,dockedAnnotation:s}=i,a=n&&!this.isMatchingAnnotation(n,e,t),o=s&&!this.isMatchingAnnotation(s,e,t);i.atomic((()=>{n&&a&&i.setBillboardAnnotation(null),s&&o&&i.setDockedAnnotation(null)}))},this.handleCloseAnnotation=async e=>{const t=this.viewData,{billboardAnnotation:i,dockedAnnotation:n}=t,{id:s,annotationType:a}=e;t.atomic((()=>{s===(null==i?void 0:i.id)&&a===(null==i?void 0:i.annotationType)&&t.setBillboardAnnotation(null),s===(null==n?void 0:n.id)&&a===(null==n?void 0:n.annotationType)&&t.setDockedAnnotation(null)}))},this.handleDockedAnnotationChanged=()=>{this.viewData.dockedAnnotation?this.engine.broadcast(new s.ro):this.engine.broadcast(new s.A)}}async init(e,t){this.viewData=new r.A,this.engine=t,[this.applicationData,this.layersData]=await Promise.all([t.market.waitForData(a.pu),t.market.waitForData(o.R)]),this.bindings.push(t.commandBinder.addBinding(d.bd,this.handleDockAnnotation),t.commandBinder.addBinding(d.oM,this.handleSelectAnnotation),t.commandBinder.addBinding(d.Kw,this.handlePreviewAnnotation),t.commandBinder.addBinding(d.Aj,this.handleCloseAnnotation),t.commandBinder.addBinding(d.G5,this.handleCloseBillboard),t.commandBinder.addBinding(d.JD,this.handleCloseDockedAnnotation),t.commandBinder.addBinding(d.yL,this.handleClosingOtherAnnotations),t.subscribe(h.oR,this.handleCloseBillboard),this.applicationData.onPropertyChanged("application",this.closeOtherAnnotations),this.layersData.onPropertyChanged("currentViewId",this.handleCloseBillboard),this.viewData.onDockedAnnotationChanged(this.handleDockedAnnotationChanged)),t.market.register(this,r.A,this.viewData)}dispose(e){this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],super.dispose(e)}onUpdate(){}isMatchingAnnotation(e,t,i){return!(!i&&!t)&&((!i||i===e.id)&&(!t||t===e.annotationType))}}var c=i(5604),m=i(86283);const u=l},49671:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Attachment:()=>o.P,AttachmentCategory:()=>r.G$,AttachmentEmbedStatus:()=>r._V,AttachmentUploadDoneMessage:()=>d.RE,AttachmentUploadError:()=>r.kV,AttachmentUploadProgressMessage:()=>d.Vj,AttachmentViewerCommand:()=>x.xW,AttachmentsData:()=>M.b,AttachmentsStore:()=>b,CancelAttachmentChangesCommand:()=>x.Ze,CancelAttachmentUploadCommand:()=>x.sE,CloseAttachmentViewerMessage:()=>d.Rd,ConfirmAttachmentChangesCommand:()=>x.iu,DeleteAttachmentCommand:()=>x.ZT,EmbedMediaCommand:()=>x.wu,EmbeddingDoneMessage:()=>d.v8,ExternalAttachmentDeserializer:()=>p.d,ExternalAttachmentSerializer:()=>u,FileAttachmentDeserializer:()=>g.O,FileAttachmentStorage:()=>N,FileUploadDeserializer:()=>I,FileUploadSerializer:()=>E,LoadEmbeddedMediaCommand:()=>x.st,MediaType:()=>r.DD,RemoveAttachmentCommand:()=>x.$T,RemoveFailureCommand:()=>x.Rh,ResetAttachmentChangesCommand:()=>x.x9,UploadAttachmentsCommand:()=>x.It,ViewAttachmentsMessage:()=>d.O,default:()=>j,makeExternalAttachmentDeserializer:()=>p.n,makeFileAttachmentDeserializer:()=>g.f});var n=i(97542),s=i(92558),a=i(5823),o=i(71608),r=i(32347),d=i(13794),h=i(17788),l=i(73123),c=i(97998),m=i(21149);class u{constructor(){this.getAttachmentDetails=e=>e.mediaType?{mediaType:(0,m.m)(e.mediaType),srcUrl:e.src,thumbnailUrl:e.src,width:e.width,height:e.height}:null,this.validate=e=>!!e&&void 0!==e.mediaType}serialize(e){const t=this.getAttachmentDetails(e);return t&&this.validate(t)?t:null}}var p=i(63665),g=i(65222),y=i(36159),v=i(63437);const w=new c.Z("AttachmentsStore");class b extends h.u{constructor(e){super(e),this.embedSerializer=new u,this.embedDeserializer=new p.d,this.fileDeserializer=new g.O}create(e){if(0===e.length)return Promise.resolve(null);const t=e[0].parentId,i=e[0].parentType;if(e.find((e=>e.parentId!==t||e.parentType!==i)))throw new Error("Cannot attach to different parents in one request");const n=this.getViewId(),s=[],o=[];let d,h;if(e.forEach((e=>{if(e.category===r.G$.EXTERNAL){const t=this.embedSerializer.serialize(e);if(!t)throw w.error("Failure attaching external attachment:",e),new Error("Could not attach External Attachment");s.push(t)}else e.category===r.G$.UPLOAD&&o.push(e.id)})),i!==a.ud.COMMENT)throw new Error(`Cannot attach to attachment to a ${i}`);return d=y.AddCommentAttachments,h="addCommentAttachments",this.mutate(d,{modelId:n,parentId:t,externalAttachments:s,fileAttachments:o}).then((e=>{const t=[],i=(0,l.q)(e,`data.${h}.externalAttachments`);if(i&&Array.isArray(i))for(const e of i){const i=this.embedDeserializer.deserialize(e);i&&t.push(i)}const n=(0,l.q)(e,`data.${h}.fileAttachments`);if(n&&Array.isArray(n))for(const e of n){const i=this.fileDeserializer.deserialize(e);i&&t.push(i)}return t.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async remove(e){const{id:t,parentId:i,parentType:n}=e,s=this.getViewId(),a=await this.mutate(v.RemoveFileAttachment,{modelId:s,attachmentId:t,parentType:n,parentId:i}),o=(0,l.q)(a,"data.removeFileAttachment")||!1;return o||w.error("remove file attachment failed!"),o}async delete(e,t,i){const n=this.getViewId();return Promise.all(e.map((e=>this.mutate(v.DeleteExternalAttachment,{modelId:n,attachmentId:e,parentType:i,parentId:t}))))}getViewId(){if(!this.viewId)throw new Error("Invalid valid id!");return this.viewId}}var f=i(66746),T=i(27553),D=i(95548),C=i(63422);var P=i(44602),A=i(9133),S=i(56367);const k=new c.Z("file-upload-deserializer");class I{deserialize(e){if(!e||!this.validate(e))return k.debug("Deserialized invalid file attachment data from MDS",e),null;const t=new o.P;return t.id=e.id,t.created=(0,A.p)(e.created),e.mimeType&&(t.mimeType=e.mimeType,t.mediaType=(0,m.id)(e.mimeType)),t.thumbnailUrl=new S.n(e.url||"",(0,A.p)(e.validUntil,null)),t.url=new S.n(e.url||"",(0,A.p)(e.validUntil,null)),t.filename=e.filename||"",t.bytes=e.bytes||0,t.category=r.G$.UPLOAD,t.width=e.imageWidth||0,t.height=e.imageHeight||0,t}validate(e){return["id","created","url","filename","mimeType","validUntil"].every((t=>t in e))}}class E{constructor(){}serialize(e){return{filename:e.file.name,contents:{filename:e.file.name,blob:e.file}}}}const O=new c.Z("FileAttachmentStorage");class N extends class{constructor(e){const{baseUrl:t}=e;this.config=e,this.context=e.context,this.client=new T.w({baseUrl:t,server:C.wO})}get readonly(){return this.config.readonly}async create(...e){throw new f.n}async read(e={}){throw new f.n}async update(...e){throw new f.n}async delete(...e){throw new f.n}async query(e,t,i={}){if(!this.context.baseViewId)throw new D.SN("Cannot read Attachments, no model view configured");return this.client.query(e,t,i)}async mutate(e,t,i){const{readonly:n}=this.config;if(n)throw new D.pp("Cannot write Attachments, model is in read-only mode");if(!this.context.baseViewId)throw new D.SN("Cannot write Attachments, no model view configured");return this.client.mutate(e,t,i)}}{constructor(e){super(e),this.uploadDeserializer=new I,this.uploadSerializer=new E,this.attachmentDeserializer=new g.O}async create(e,t){const i=this.context.baseViewId,n=this.uploadSerializer.serialize(e);let s;try{s=await this.client.upload(P.UploadFileAttachmentToModel,"UploadFileAttachmentToModel",Object.assign(Object.assign({},n),{modelId:i,organizationId:this.config.organizationId}),t,e.xhr)}catch(t){return O.error(t),t.code.includes("quota.exceeded")?e.error=r.kV.OVER_QUOTA:e.error=r.kV.UPLOAD_FAILED,e.progress=100,e}if(s.errors&&s.errors.length>0)O.error(s.errors),e.error=r.kV.UPLOAD_FAILED;else{const t=(0,l.q)(s,"data.uploadFileAttachmentToModel")||null;if(t){const i=this.uploadDeserializer.deserialize(t);i?(O.info("upload successful!"),e.attachment=i):(O.error("cannot create attachment"),e.error=r.kV.UPLOAD_FAILED)}else O.error("upload failed!"),e.error=r.kV.UPLOAD_FAILED}return e.progress=100,e}async delete(e){const t=await this.client.mutate(P.DeleteFileAttachment,{id:e}),i=(0,l.q)(t,"data.deleteFileAttachment")||!1;return i?O.info("upload deleted!"):O.error("upload deletion failed!"),i}async read(){var e,t,i;const n=this.context.baseViewId;if(!n)return O.error("Missing model ID"),[];const s=null!==(i=null===(t=null===(e=(await this.client.query(P.FileAttachments,{modelId:n})).data)||void 0===e?void 0:e.fileAttachmentsByModelId)||void 0===t?void 0:t.results)&&void 0!==i?i:[],a=[];return s.forEach((e=>{const t=this.attachmentDeserializer.deserialize(e);t&&a.push(t)})),a}}var M=i(97163),x=i(35446),B=i(36892),V=i(56382);function R(e){switch(e){case V.ht.PHOTO:return r.DD.IMAGE;case V.ht.VIDEO:return r.DD.VIDEO;case V.ht.RICH:return r.DD.RICH;default:return}}function L(e){const{height:t,width:i,thumbnail_height:n,thumbnail_width:s,cache_age:a}=e,o=(void 0===t||void 0===i)&&(s&&n),r=e.type===V.ht.PHOTO?e.url:void 0,d=e.thumbnail_url||r,h=a?new Date(Date.now()+1e3*a):null;return{width:o?s:i,height:o?n:t,mediaType:R(e.type),url:new S.n(r||"",h),thumbnailUrl:new S.n(d||"",h)}}var F=i(80742);class H extends n.Y{constructor(){super(...arguments),this.name="attachments-module",this.loadEmbeddedAttachment=async e=>this.getUpdatedEmbed(e.attachment),this.embedMedia=async e=>{let t,i=null;const n=await this.oEmbedConsumer.getOEmbedData(e.src);return n?(i=new o.P,i.id=(0,s.fV)(),i.parentType=e.parentType,i.parentId=e.parentId,i.src=e.src,i.category=r.G$.EXTERNAL,Object.assign(i,L(n)),this.attachmentsData.addPending(i),t=r._V.EMBED_SUCCESS):t=r._V.EMBED_FAIL,this.engine.broadcast(new d.v8(i,t,e.parentId,e.parentType)),i},this.uploadAttachments=async e=>{const{parentType:t,parentId:i,files:n}=e,s=this.attachmentsData;n.forEach((e=>{this.uploadAttachment(e,i,t).then((e=>{s.atomic((()=>{e.error?(s.removeUpload(e.id),s.addFailure(e)):e.attachment&&(e.attachment.parentId=i,e.attachment.parentType=t,s.removeUpload(e.id),s.addPending(e.attachment))})),this.engine.broadcast(new d.RE(e))}))}))},this.onProgress=(e,t)=>{if(!e.lengthComputable)return;const i=e.total>0?Math.floor(e.loaded/e.total*100):100,n=Object.assign(Object.assign({},t),{progress:i});this.attachmentsData.updateUpload(n),this.engine.broadcast(new d.Vj(n))},this.removeFailure=async e=>{this.attachmentsData.removeFailure(e.id)},this.removeAttachment=async e=>{if(this.fileAttachmentStorage.readonly)return void this.log.error("File attachment storage is readonly");const{attachment:t}=e,i=this.attachmentsData,n=i.getPendingAttachment(t.id);n?(n.category===r.G$.UPLOAD&&await this.fileAttachmentStorage.delete(t.id),i.removePendingAttachment(t.id)):i.markAttachmentForDelete(t)},this.confirmAttachmentChanges=async e=>{const t=this.attachmentsData,{pendings:i,removals:n}=t,{parentId:s,parentType:o,prevParentId:d}=e,h=i.length>0||n.length>0;if(i.length>0){const e=d||s;t.iteratePending((t=>{d&&t.parentId===e&&t.parentType===o&&(t.parentId=s)}));const n=o!==a.ud.MATTERTAG?i.values:i.values.filter((e=>e.category===r.G$.UPLOAD));await this.attachmentsStore.create(n)}if(n.length>0){const e=o!==a.ud.MATTERTAG?n.values:n.values.filter((e=>e.category===r.G$.UPLOAD));e.length>0&&await this.deleteAttachments(e,s,o)}return this.resetAttachmentData(),h},this.cancelAttachmentUpload=async e=>{const{uploads:t}=this.attachmentsData,i=null==t?void 0:t.get(e.uploadId);(null==i?void 0:i.xhr)&&(i.xhr.abort(),this.attachmentsData.removeUpload(e.uploadId))},this.cancelAttachmentChanges=async()=>{const e=this.attachmentsData,{pendings:t,uploads:i,removals:n}=e;0===t.length&&0===n.length&&0===i.length||(this.fileAttachmentStorage.readonly?this.log.error("File attachment storage is readonly"):(t.values.forEach((e=>{e.category===r.G$.UPLOAD&&this.fileAttachmentStorage.delete(e.id)})),i.length&&i.values.map((e=>this.cancelAttachmentUpload({uploadId:e.id}))),this.resetAttachmentData()))},this.deleteAttachments=async(e,t,i)=>{if(this.fileAttachmentStorage.readonly)return void this.log.error("File attachment storage is readonly");if(0===e.length)return;const n=[],s=[];this.attachmentsData.atomic((()=>{e.forEach((e=>{e.category===r.G$.UPLOAD?n.push(e):e.category===r.G$.EXTERNAL&&s.push(e.id)}))})),n.length>0&&await Promise.all(n.map((e=>this.attachmentsStore.remove(e)))),s.length>0&&await this.attachmentsStore.delete(s,t,i)},this.handleAttachmentViewerCommand=async e=>{const{open:t,attachments:i,attachmentId:n}=e;t&&i?this.openAttachmentViewer(i,n):this.closeAttachmentViewer()},this.immediatelyDeleteAttachment=async e=>{this.fileAttachmentStorage.readonly?this.log.error("File attachment storage is readonly"):e.id?await this.fileAttachmentStorage.delete(e.id):this.log.error("ID required to delete attachment")}}async init(e,t){this.engine=t;const i=await t.market.waitForData(F.R),{organizationId:n,oEmbedConsumer:s}=e;this.attachmentsStore=new b({context:i.mdsContext,readonly:!1});const a=()=>{this.attachmentsStore.setStoreViewId(i.getNonworkshopViewId())};a(),this.bindings.push(i.onPropertyChanged("currentViewId",a)),this.fileAttachmentStorage=new N(Object.assign({context:i.mdsContext,readonly:!n,organizationId:n},e)),this.oEmbedConsumer=await s,this.attachmentsData=new M.b,this.bindings.push(t.commandBinder.addBinding(x.It,this.uploadAttachments),t.commandBinder.addBinding(x.wu,this.embedMedia),t.commandBinder.addBinding(x.st,this.loadEmbeddedAttachment),t.commandBinder.addBinding(x.iu,this.confirmAttachmentChanges),t.commandBinder.addBinding(x.sE,this.cancelAttachmentUpload),t.commandBinder.addBinding(x.Ze,this.cancelAttachmentChanges),t.commandBinder.addBinding(x.x9,(async()=>this.resetAttachmentData())),t.commandBinder.addBinding(x.$T,this.removeAttachment),t.commandBinder.addBinding(x.Rh,this.removeFailure),t.commandBinder.addBinding(x.xW,this.handleAttachmentViewerCommand),t.commandBinder.addBinding(x.ZT,this.immediatelyDeleteAttachment)),t.market.register(this,M.b,this.attachmentsData)}async getUpdatedEmbed(e){if(e.category===r.G$.EXTERNAL){const t=await this.oEmbedConsumer.getOEmbedData(e.src);return Object.assign(e,L(t)),t}return null}async uploadAttachment(e,t,i){const n={file:e,id:(0,s.fV)(),progress:0,error:null,attachment:null,parentId:t,parentType:i,xhr:new XMLHttpRequest};if(this.fileAttachmentStorage.readonly)return this.log.error("File attachment storage is readonly"),n.error=r.kV.PERMISSION_DENIED,Promise.resolve(n);const a=e.size;return 0===a?(n.error=r.kV.EMPTY_FILE,Promise.resolve(n)):a>B.z6?(n.error=r.kV.FILE_TOO_LARGE,Promise.resolve(n)):(this.attachmentsData.addUpload(n),this.fileAttachmentStorage.create(n,(e=>this.onProgress(e,n))))}resetAttachmentData(){const e=this.attachmentsData;e.atomic((()=>{e.clearPending(),e.clearRemovals(),e.clearUploads(),e.clearFailures()}))}openAttachmentViewer(e,t){this.viewerOpen=!0,this.engine.broadcast(new d.O(e,t))}closeAttachmentViewer(){this.viewerOpen&&(this.viewerOpen=!1,this.engine.broadcast(new d.Rd))}async getAllAttachments(){return this.fileAttachmentStorage.read()}}const j=H},66211:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var n=i(97542);class s extends n.Y{constructor(){super(...arguments),this.name="base-controls",this.inputBindings=[]}registerActiveStateChangeBinding(){this.bindings.push(this.controls.onActiveStateChanged((()=>this.onActiveStateChanged())))}updateInputBindings(){this.controls.isActive?this.inputBindings.forEach((e=>e.renew())):this.inputBindings.forEach((e=>e.cancel()))}onActiveStateChanged(){this.controls.stop(),this.updateInputBindings()}dispose(e){super.dispose(e);for(const e of this.inputBindings)e.cancel();this.inputBindings=[]}}},41835:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var n=i(37082);class s{constructor(){this.poseControllerObservable=(0,n.Y)(null)}get poseController(){return this.poseControllerObservable.value}setController(e){return this.poseControllerObservable.value=e,this}get isActive(){return null!=this.poseController}onActiveStateChanged(e){return this.poseControllerObservable.onChanged(e)}}},26702:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(97542),s=i(92810),a=i(81396),o=i(12529),r=i(77597);const d=new a.Vector3(0,1,0),h=16724312,l=[{innerRadius:0,outerRadius:.42,color:h,opacity:.7},{innerRadius:.67,outerRadius:1,color:h,opacity:.7}];class c{constructor(e,t,i){this.scene=e,this.sweepData=t,this.mesh=new r.f({radius:.25,normal:d,rings:l}),this.mesh.name="CurrentPanoMarker",this.mesh.renderOrder=o.z.panoMarker,this.mesh.layers.mask=i.mask}init(){}dispose(){this.mesh.dispose()}render(){const e=this.sweepData.currentAlignedSweepObject;e&&this.move(e.floorPosition)}activate(){this.scene.add(this.mesh)}deactivate(){this.scene.remove(this.mesh)}move(e){this.mesh.position.copy(e).setY(e.y+c.floorOffset)}}c.floorOffset=.01;var m=i(23254),u=i(53954),p=i(19663);class g extends p.m{constructor(e){super(),this.id="TOGGLE_PANO_MARKER",this.payload={enabled:e}}}var y=i(95882);class v extends n.Y{constructor(){super(...arguments),this.name="current-pano-marker",this.state={markerEnabled:!1,transitionPromise:null}}async init(e,t){const i=(await t.getModuleBySymbol(s.Aj)).getScene(),n=t.claimRenderLayer(this.name),[a,o]=await Promise.all([t.market.waitForData(u.Z),t.market.waitForData(m.O)]);this.engine=t,this.sweepData=a,this.viewmodeData=o,this.markerRenderer=new c(i,a,n),this.bindings.push(t.commandBinder.addBinding(g,(async({enabled:e})=>this.setCommandOverride(e))),this.viewmodeData.makeModeChangeSubscription((()=>this.updateMarker())),this.sweepData.makeSweepChangeSubscription((()=>this.updateMarker()))),this.updateMarker()}setCommandOverride(e){this.state.commandOverride=e,this.updateMarker()}async updateMarker(){const{commandOverride:e}=this.state,t=this.viewmodeData.currentMode,i=this.sweepData.currentAlignedSweepObject,n=!1===e||(0,y.Bw)(t)||t===y.Ey.Transition;return this.toggleMarker(!!i&&!n)}async toggleMarker(e){const{markerEnabled:t,transitionPromise:i}=this.state;if(i&&await i,t===e)return;const n=e?this.enableMarker():this.disableMarker();return this.state.transitionPromise=n.finally((()=>{this.state.markerEnabled=e,this.state.transitionPromise=null})),this.state.transitionPromise}async enableMarker(){return this.engine.addComponent(this,this.markerRenderer)}async disableMarker(){return this.engine.removeComponent(this,this.markerRenderer)}}},95512:(e,t,i)=>{"use strict";i.d(t,{y:()=>s});var n=i(19663);class s extends n.m{constructor(e){super(),this.id="DISABLE_CURSOR_MESH",this.payload={disable:e}}}},79565:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>u});var n=i(97542),s=i(92810),a=i(95882),o=i(23254),r=i(2473),d=i(5135),h=i(53954),l=i(95512),c=i(34029),m=i(45786);class u extends n.Y{constructor(){super(...arguments),this.name="cursor-controller",this.visibilityRules=[],this.disabled=!1}async init(e,t){this.bindings.push(t.commandBinder.addBinding(l.y,(async e=>{this.disabled=e.disable}))),[this.cursorMesh,this.cursorModule]=await Promise.all([t.getModuleBySymbol(s.Zp),t.getModuleBySymbol(s.tg)]),this.visibilityRules.push((()=>{const e=t.market.tryGetData(o.O);return!!e&&(0,a.Bw)(e.closestMode)}),(()=>{const e=t.market.tryGetData(h.Z);return!!e&&!e.isSweepUnaligned(e.currentSweep)}),(()=>{const e=t.market.tryGetData(r.k);return!!e&&!e.isTourActive()}),(()=>{const e=t.market.tryGetData(d.Z);return!!e&&!e.isMobile()}),(()=>{const e=t.market.tryGetData(c.e);return!!e&&e.tryGetProperty(m.b,!0)}))}onUpdate(){this.updateCursorVisibility()}addVisibilityRule(e){this.visibilityRules.push(e)}removeVisibilityRule(e){const t=this.visibilityRules.indexOf(e);-1!==t&&this.visibilityRules.splice(t,1)}setFadeProps(e){this.cursorModule.setFadeProps(e)}updateCursorVisibility(){const e=!this.disabled&&this.visibilityRules.reduce(((e,t)=>e&&t()),!0);this.cursorMesh.setVisible(e)}setTexture(e){this.cursorModule.setTexture(e)}}},45786:(e,t,i)=>{"use strict";i.d(t,{b:()=>n});const n="features/cursor"},30747:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>l});var n=i(92810),s=i(97542),a=i(81396),o=i(93411),r=i(13310),d=i(67678),h=i(85992);class l extends s.Y{constructor(){super(...arguments),this.name="cursor-data",this.fadeOutDelay=700,this.fadeOutDuration=700,this.fadeInDuration=300,this.movementThreshold=.003,this.cursorState=new r.Y,this.position=new a.Vector2,this.timeToFade=0}async init(e,t){this.input=await t.getModuleBySymbol(n.PZ),this.raycasterData=await t.market.waitForData(h.P),t.market.register(this,r.Y,this.cursorState),this.bindings.push(this.input.registerHandler(d.mE,this.onPointerMove.bind(this))),this.fadeInDuration>this.fadeOutDelay&&this.log.warn("fadeInDuration should be less than fadeOutDelay!")}onUpdate(e){let t=!1;this.timeToFade>0&&(this.timeToFade-=e,this.timeToFade<=0&&(t=!0)),this.cursorState.opacity.tick(e),this.cursorState.commit(),t&&this.cursorState.opacity.modifyAnimation(1,0,this.fadeOutDuration)}setFadeProps(e){const{fadeOut:t,fadeIn:i}=e;this.fadeOutDuration=t&&t.duration?t.duration:this.fadeOutDuration,this.fadeOutDelay=t&&t.delay?t.delay:this.fadeOutDelay,this.fadeInDuration=i&&i.duration?i.duration:this.fadeInDuration}setTexture(e){this.cursorState.texture=e}onPointerMove(){if(null!==this.raycasterData.hit&&this.raycasterData.pointerNdcPosition.distanceToSquared(this.position)>this.movementThreshold){this.position.copy(this.raycasterData.pointerNdcPosition),this.timeToFade=this.fadeOutDelay;const e=(0,o.t)(0,this.fadeInDuration,1-this.cursorState.opacity.value);this.cursorState.opacity.modifyAnimation(this.cursorState.opacity.value,1,e),this.cursorState.commit()}}dispose(e){super.dispose(e)}}},13310:(e,t,i)=>{"use strict";i.d(t,{Y:()=>a});var n=i(89557),s=i(67992);class a extends s.V{constructor(){super(),this.name="cursor",this.opacity=new n.z(0),this.texture=null}}},85042:(e,t,i)=>{"use strict";var n;i.d(t,{L:()=>n}),function(e){e[e.Reticle=0]="Reticle",e[e.GridPlane=1]="GridPlane"}(n||(n={}))},90763:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>p});var n=i(97542),s=i(92810),a=i(81396),o=i(13310),r=i(85992),d=i(17878),h=i(85042),l=i(12529),c=i(77597);const m=[{outerRadius:.977,innerRadius:.926,color:16777215,opacity:1},{outerRadius:.898,innerRadius:.648,color:16777215,opacity:.73}];class u{constructor(e,t=d.o.ALL){this.scene=e,this.layer=t,this.supportsMobile=!1,this.style=h.L.Reticle,this.bindings=[],this.onCursorDataUpdated=e=>{this.mesh.configure({opacity:e.opacity.value,texture:e.texture})},this.onPositionUpdate=e=>{if(e.hit&&e.hit.face){const t=e.hit.point.clone(),i=e.hit.face.normal;this.container.position.copy(t),this.mesh.configure({normal:i})}},this.container=new a.Group,this.container.name="cursor",this.mesh=new c.f({radius:.2,rings:m}),this.container.add(this.mesh),this.mesh.renderOrder=l.z.reticule,this.mesh.layers.mask=this.layer.mask}init(){}render(){}dispose(){this.mesh.dispose(),this.container.children.forEach((e=>{if(e.isMesh&&e!==this.mesh){e.geometry.dispose();const t=e.material;t.dispose(),t.map&&t.map.dispose()}}))}async activate(e){const t=await e.market.waitForData(o.Y),i=await e.market.waitForData(r.P);this.bindings.push(t.onChanged(this.onCursorDataUpdated),i.onChanged(this.onPositionUpdate)),this.scene.add(this.container)}deactivate(){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}setVisible(e){this.container.visible=e}}class p extends n.Y{constructor(){super(...arguments),this.name="cursor-mesh",this.setVisible=e=>{this.cursor&&this.cursor.setVisible(e)}}async init(e,t){const i=(await t.getModuleBySymbol(s.Aj)).getScene(),n=t.claimRenderLayer(this.name);this.cursor=new u(i,n),t.addComponent(this,this.cursor)}get container(){return this.cursor.container}}},95810:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>d});var n=i(97542),s=i(92810),a=i(53058),o=i(81396),r=i(90304);class d extends n.Y{constructor(){super(...arguments),this.name="fat-caster",this.rayAssembly=new Array(d.rayCount),this.rayPlaneOrientation=new o.Quaternion,this.rayVisuals=[]}async init(e,t){this.config={debug:!!e.debug},this.raycaster=await t.getModuleBySymbol(s.fQ);for(let e=0;e<d.rayCount;++e)this.rayAssembly[e]=new o.Ray;if(e.debug){const e=(await t.getModuleBySymbol(s.Aj)).getScene();for(let t=0;t<d.rayCount;++t){this.rayVisuals[t]=new o.ArrowHelper(new o.Vector3,new o.Vector3);const i=this.rayVisuals[t];i.remove(i.cone),i.setLength(1e3),e.add(this.rayVisuals[t])}}}async dispose(e){const t=(await e.getModuleBySymbol(s.Aj)).getScene();for(const e of this.rayVisuals)t.remove(e)}get ray(){return this.raycaster.pointer.pointerRay.clone()}cast(e,t,i=a.a.Filter.AVERAGE){const n=this.ray;return this.updateRayAssembly(n.origin,n.direction,e),this.castRays(t,i)}castRays(e,t){const i=[];let n=null;for(const t of this.rayAssembly){const s=this.raycaster.picking.pick(t.origin,t.direction,e);s&&(t===this.rayAssembly[0]&&(n=s),s.point.add(this.rayAssembly[0].origin).sub(t.origin),i.push(s))}return t(i,n,this.rayAssembly)}updateRayAssembly(e,t,i){for(const e of this.rayAssembly)e.direction.copy(t);if(this.rayPlaneOrientation.setFromUnitVectors(r.fU.FORWARD,t),this.rayAssembly[0].origin.copy(e),this.rayAssembly[1].origin.copy(r.fU.RIGHT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[2].origin.copy(r.fU.UP).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[3].origin.copy(r.fU.LEFT).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[4].origin.copy(r.fU.DOWN).multiplyScalar(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[5].origin.copy(r.fU.UP).add(r.fU.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[6].origin.copy(r.fU.UP).add(r.fU.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[7].origin.copy(r.fU.DOWN).add(r.fU.RIGHT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.rayAssembly[8].origin.copy(r.fU.DOWN).add(r.fU.LEFT).setLength(i).applyQuaternion(this.rayPlaneOrientation).add(e),this.config.debug)for(let e=0;e<this.rayVisuals.length;++e){const i=this.rayVisuals[e];i.setDirection(t),i.position.copy(this.rayAssembly[e].origin)}}}d.rayCount=9},53058:(e,t,i)=>{"use strict";i.d(t,{a:()=>n});var n,s=i(81396);!function(e){let t;!function(e){const t=e=>{for(const t of e)if(t.face)return{point:t.point,object:t.object,distance:t.distance,face:t.face};return null},i=(e,t)=>e.distance-t.distance;e.CENTER_FIRST=(e,i)=>i&&i.face?{point:i.point,normal:i.face.normal,object:i.object,distance:i.distance,face:i.face}:t(e),e.CLOSEST=e=>t(e.sort(i)),e.AVERAGE=e=>{if(0===e.length)return null;const t={point:new s.Vector3,face:{a:0,b:1,c:2,normal:new s.Vector3,materialIndex:0},distance:0,object:e[0].object};for(const i of e)t.face&&i.face&&(t.point.add(i.point),t.face.normal.add(i.face.normal));return t.point.divideScalar(e.length),t.face&&t.face.normal.divideScalar(e.length).normalize(),t};e.CENTER_GROUP=t=>(i,s,a)=>{if(s){const n=[s];for(let e=1;e<i.length&&e<3;++e){const o=i[e];if(o.face){const i=Math.abs(a[e].direction.dot(o.face.normal));s.point.distanceTo(o.point)*i<=t&&n.push(o)}}if(n.length>=3){const t=e.AVERAGE(n,null,a);if(t&&t.face&&s.face)return t.face.normal=s.face.normal,t}}const o=n(i,a,t);return o?e.AVERAGE(o,null,a):e.CENTER_FIRST(i,s,a)};const n=(e,t,n)=>{const s=e.slice().sort(i),a=[s[0]];let o;for(o=1;o<s.length&&a.length<3;++o){const e=s[o];if(e.face){const i=Math.abs(t[o].direction.dot(e.face.normal));a[0].point.distanceTo(e.point)*i>n&&(a.length=0),a.push(e)}}return a.length<3?null:a}}(t=e.Filter||(e.Filter={}))}(n||(n={}))},69582:(e,t,i)=>{"use strict";i.r(t),i.d(t,{GetFloorIntersectCommand:()=>n.Z,default:()=>w});var n=i(29900),s=i(97542),a=i(92810),o=i(947),r=i(9037),d=i(59370),h=i(76957),l=i(23254),c=i(95882),m=i(82814),u=i(16769),p=i(73121),g=i(81396),y=i(90304);class v extends s.Y{constructor(){super(...arguments),this.name="floor-caster",this.cameraPosition=new g.Vector3,this.forwardPosition=new g.Vector3,this.targetPlane=new g.Plane}async init(e,t){this.engine=t,[this.renderer,this.cameraData,this.viewmodeData,this.raycaster,this.floorsData,this.meshQuery]=await Promise.all([t.getModuleBySymbol(a.Aj),t.market.waitForData(r.M),t.market.waitForData(l.O),t.getModuleBySymbol(a.fQ),t.market.waitForData(h.i),t.getModuleBySymbol(a.hi)]),t.commandBinder.addBinding(n.Z,(e=>this.castToFloor(e.screenPosition,e.height,e.includeHiddenFloors)))}async castToFloor(e,t,i=!0){await this.engine.after(o.A.End);const n=this.renderer.getScene().camera,s=(0,d.z5)(e.x,e.y,this.cameraData.width,this.cameraData.height);let a,r=null;this.cameraPosition.set(s.x,s.y,-1).unproject(n),this.forwardPosition.set(s.x,s.y,1).unproject(n);const h=this.raycaster.picking.cast(this.cameraPosition,this.forwardPosition.clone().sub(this.cameraPosition).normalize(),i?u.T0:u.Pv)[0];if(h&&h.object instanceof m.S){r=h&&h.point||null;const e=this.meshQuery.floorIdFromObject(h.object);e?a=this.floorsData.getFloor(e):r&&(a=this.floorsData.getClosestFloorAtHeight(r.y))}if(void 0!==t){this.cameraPosition.copy(this.cameraData.pose.position);const e=(0,d.st)(this.cameraData,s);if(this.viewmodeData.currentMode!==c.Ey.Floorplan){const i=(0,p.n0)(this.cameraPosition,e);this.targetPlane.set(y.fU.DOWN,t),r=(0,p.Fe)(this.cameraPosition,i,this.targetPlane)||null}else e.y=t,r=e}const l=a?a.index:-1;return{position:r,floor:l,floorIndex:l}}}const w=v},74082:(e,t,i)=>{"use strict";i.d(t,{$:()=>r});var n=i(49947),s=i(7159),a=i(30643),o=i(31362);class r{constructor(e){this.capabilites={links:{enable:e.supportLinks,keepLabels:e.keepLinkLabels}}}parse(e,t){const i=[];if(!e)return[];return e.split("[").map((function(e,t){return 0===t?e:"["+e})).forEach((e=>{const n=this.findLink(e);n?-1===n.url.indexOf("javascript:")&&(this.addLinkChunk(i,n,t),this.addTextChunk(i,e.slice(n.markdown.length))):this.addTextChunk(i,e)})),i}findLink(e){const t=e.match(/\[([^\]]*)\]\((.*)\)/);if(!t)return null;const i=t[2];let n=1,s=0;for(;s<i.length&&("("===i[s]?n++:")"===i[s]&&n--,0!==n);)s++;const a=i.length-s;return{markdown:t[0].substring(0,t[0].length-a),label:t[1],url:this.conditionallyEncode(t[2].substring(0,s))}}conditionallyEncode(e){const t=e.trim();return this.needsEncoding(t)?encodeURI(t):t}needsEncoding(e){if(e.match(o.jx))return!0;let t=e;try{t=decodeURI(e)}catch(e){}return!1}addTextChunk(e,t){0!==t.length&&e.push({type:a.z.text,text:t})}addLinkChunk(e,t,i){if(!this.capabilites.links.enable)return void(this.capabilites.links.keepLabels&&this.addTextChunk(e,t.label));const o={label:t.label,url:t.url,type:n.U.EXT_LINK};-1===o.url.indexOf("://")&&(o.url="http://"+o.url);const r=-1!==o.url.indexOf("matterport.com/show"),d=-1!==o.url.indexOf(window.location.host+"/show");if(r||d){const e=-1!==o.url.indexOf(i),t=s.K.deserialize(o.url);e&&t?(o.type=n.U.NAVIGATION,o.navigationData=t):(o.type=n.U.MODEL,o.url+="&play=1")}e.push({type:a.z.link,link:o})}static getNumLinks(e){let t=0;return e.forEach((e=>{"link"===e.type&&void 0!==e.link&&t++})),t}}},84343:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>K,makeMattertagDeserializer:()=>I.a});var n=i(97542),s=i(92810),a=i(88669),o=i(39880),r=i(79728),d=i(635),h=i(71954),l=i(64567),c=i(2541),m=i(19648),u=i(47620),p=i(30643),g=i(85679),y=i(74082),v=i(97704),w=i(95724),b=i(17788),f=i(97998),T=i(73123),D=i(65222),C=i(63665),P=i(5823),A=i(40731);const S=new f.Z("mds-mattertag-serializer");class k{constructor(e,t){this.updateSerializer=e,this.mediaSerializer=t}serialize(e,t){const i=this.mediaSerializer.serialize(e),n=this.updateSerializer.serialize(e,t),s=null!==i?Object.assign(Object.assign({},i),n):n;return this.validate(s)?s:null}validate(e){if(!e)return!1;const t=["label","description","mediaUrl"].some((t=>t in e)),i=["floorId","enabled","anchorPosition"].filter((t=>!(t in e))),n=0===i.length,s=!!e.anchorPosition&&(0,A.u)(e.anchorPosition),a=n&&t&&s;return a||S.debug("Invalid MattertagDetails:",{missingFields:i,validPosition:s}),a}}var I=i(52507);class E{serialize(e){return this.validate(e)?{sid:e.sid}:null}validate(e){const t=null!==e&&!!e.mediaType&&e.mediaType===p.z.none;return null!==e&&!!e.sid&&t}}const O=new f.Z("mds-mattertag-serializer");class N{serialize(e){const t=this.extractMedia(e);return this.validate(t)?t:null}validate(e){if(!e)return!1;const t=["mediaUrl","mediaType"].every((t=>t in e)),i=void 0!==e.mediaType&&["rich","photo","video"].includes(e.mediaType),n=t&&i;return n||O.debug("invalid media",e,{hasRequiredFields:t,hasValidMediaType:i}),n}extractMedia(e){const t={};return e.mediaSrc&&(t.mediaUrl=e.mediaSrc),e.mediaType&&e.mediaType in M&&(t.mediaType=e.mediaType),t.mediaUrl&&t.mediaType?t:null}}const M={[p.z.photo]:[P.L0.PHOTO],[p.z.rich]:[P.L0.RICH],[p.z.video]:[P.L0.VIDEO]};var x=i(69984),B=i(2569);const V=new f.Z("mds-mattertag-serializer");class R{serialize(e,t){var i;if(!e)return null;const n={};return void 0!==e.enabled&&(n.enabled=e.enabled),void 0!==e.stemVisible&&(n.stemEnabled=e.stemVisible),void 0!==e.label&&(n.label=e.label),void 0!==e.description&&(n.description=e.description),void 0!==e.color&&(0,x.D5)(e.color)&&(n.color=(0,x.Ex)(e.color)),void 0!==e.anchorPosition&&(0,A.u)(e.anchorPosition)&&(n.anchorPosition=B.ep.toVisionVector(e.anchorPosition)),void 0!==e.anchorNormal&&(0,A.u)(e.anchorNormal)&&(n.stemNormal=B.ep.toVisionVector(e.anchorNormal)),void 0!==e.stemHeight&&(n.stemLength=e.stemHeight),Object.prototype.hasOwnProperty.call(e,"icon")&&(n.icon=null!==(i=e.icon)&&void 0!==i?i:""),void 0!==e.keywords&&(n.keywords=e.keywords),e.floorId&&(n.floorId=e.floorId),e.roomId&&(n.roomId=e.roomId),e.layerId&&t&&(n.layerId=e.layerId),e.objectAnnotationId&&(n.objectAnnotationId=e.objectAnnotationId),n&&this.validate(n)?n:null}validate(e){if(!e)return!1;const t=["layerId","floorId","roomId","color","label","description","enabled","stemEnabled","stemLength","stemNormal","stemDirection","anchorPosition","objectAnnotationId","keywords","icon"],i=Object.keys(e).length>0,n=Object.keys(e).every((e=>t.includes(e))),s=n&&i;return s||V.debug("Invalid MattertagPatch:",{hasContents:i,hasValidFields:n,data:e}),s}}class L{serialize(e){const t=e.fileAttachments;return void 0===t?null:{fileAttachments:t.map((e=>e.id))}}}var F=i(82686);const H=new f.Z("MdsMattertagStore");class j extends b.u{constructor(e,t){super(e),this.includeObjectTags=t,this.layeredType=P.SF.MATTERTAG,this.prefetchKey="data.model.mattertags",this.fileAttachmentDeserializer=new D.O,this.fileAttachmentSerializer=new L,this.patchSerializer=new R,this.mediaUpdateSerializer=new N,this.mediaRemovalSerializer=new E,this.createSerializer=new k(this.patchSerializer,this.mediaUpdateSerializer),this.tagDeserializer=new I.d(this.fileAttachmentDeserializer,new C.d),this.deserializer=new w.o({deserializer:this.tagDeserializer})}async read(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t,prefetchKey:this.prefetchKey,includeLayers:this.readLayerId()};return this.query(F.GetMattertags,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(!this.includeObjectTags&&t.objectAnnotationId||(e[t.sid]=t),e)),{})}))}async refreshFileAttachments(e){const{includeDisabled:t=!1}=this.config,i={modelId:this.getViewId(),includeDisabled:t};return this.query(F.RefreshTagFileAttachments,i,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.mattertags;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){if(!e.id||!e.fileAttachments)throw H.error("Failure refreshing tag file attachments"),new Error("Failure refreshing tag file attachments");e.fileAttachments.forEach((e=>{const t=this.fileAttachmentDeserializer.deserialize(e);t&&s.push(t)}))}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async create(e){const t=this.getViewId(),i=[];for(const n of e){const e=this.createSerializer.serialize(n,this.writeLayerId(n.layerId));if(!e)throw H.error("Failure saving tag:",n.sid,n),new Error("Could not save Mattertag");const s=n.sid;let o=", $data: MattertagDetails!";const r={modelId:t,mattertagId:s,data:e},d=this.fileAttachmentSerializer.serialize(n);d&&(o+=", $fileAttachments: [ID!]",r.fileAttachments=d.fileAttachments);const h=`\n        addMattertag(\n          modelId: $modelId,\n          mattertagId: "${s}",\n          mattertag: $data) {\n            id\n            created\n            modified\n          }\n        ${d?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${s}",\n            fileAttachments: $fileAttachments) {\n              id\n            }`:""}\n      `,l=v.gql`
        mutation AddMattertag($modelId: ID! ${o}) {
          ${h}
        }
      `,c=await this.mutate(l,r),m=(0,T.q)(c,"data.addMattertag"),u=(new a.U).copy(n);u.sid=m.id,u.commit(),i.push(u)}return i}async update(e,t){if(!e||0===e.length)return;let i="";const n={},s=this.getViewId();n.modelId=s;let a="";for(const t of e){const e=t.sid,s=this.mediaUpdateSerializer.serialize(t),o=this.mediaRemovalSerializer.serialize(t),r=this.patchSerializer.serialize(t,!1),d=r||o||s,h=this.fileAttachmentSerializer.serialize(t);if(!(r||s||o||h))return void H.debug(`Nothing to update for tag ${e}`,t);if(d){const t=r||{};i+=`, $patch${e}: MattertagPatch!`,o&&(t.mediaUrl=""),s&&(t.mediaUrl=s.mediaUrl,t.mediaType=s.mediaType),n[`patch${e}`]=t}h&&(i+=`, $fileAttachments${e}: [ID!]`,n[`fileAttachments${e}`]=h.fileAttachments),n[`mediaType${e}`]=s&&s.mediaType,n[`mediaUrl${e}`]=s&&s.mediaUrl;a+=`\n        update${e}:\n        ${d?`patchMattertag(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            patch: $patch${e}) {\n              id\n            }`:""}\n        ${h?`addMattertagAttachments(\n            modelId: $modelId,\n            mattertagId: "${e}",\n            fileAttachments: $fileAttachments${e}) {\n              id\n            }`:""}\n      `}for(const{attachment:e}of t)(null==e?void 0:e.id)&&(null==e?void 0:e.parentId)&&e.parentType?(i+=`, $parentType${e.id}: ParentType!`,n[`parentType${e.id}`]=e.parentType,a+=`\n        unattach${e.id}:\n        removeFileAttachment(modelId: $modelId,\n                             attachmentId: "${e.id}",\n                             parentType: $parentType${e.id},\n                             parentId: "${e.parentId}") `):H.debug("MattertagStore.update: unable to remove file attachment");const o=v.gql`
      mutation tagUpdate($modelId: ID! ${i}) {
        ${a}
      }
    `;await this.mutate(o,n)}async delete(e){if(!e||0===e.length)return;const t=this.getViewId();let i="";for(const t of e){if(!t||t&&!t.sid)throw new Error("MattertagStore.delete failed");i+=`delete${t.sid}: deleteMattertag(modelId: $modelId, mattertagId: "${t.sid}") `}const n=v.gql`
      mutation batchDeleteMattertag($modelId: ID!) {
        ${i}
      }
    `;return this.mutate(n,{modelId:t}).then((()=>{}))}}var U=i(9037),z=i(59370),G=i(81396),_=i(5666),$=i(80742);class K extends n.Y{constructor(){super(...arguments),this.name="mattertag-data",this.monitor=null,this.filesToUnattach=[],this.getDiscPositions=(()=>{const e=[],t={},i={},n=new G.Vector3;return async s=>(e.length=0,s.tags.forEach((s=>{const a=this.data.getTag(s);a&&(i[s]||(i[s]=new G.Vector3),i[s].copy(a.anchorPosition).add(a.stemVector),t[s]||(t[s]=new G.Vector2),(0,z.q9)(this.cameraData,i[s],t[s],n),e.push({sid:s,screen:n.z>1?null:t[s],world:i[s]}))})),e)})(),this.addTag=async e=>{const t=[];return this.data.atomic((()=>{for(const i of e){const{positionOptions:e,standardOptions:n,mediaOptions:s}=i,a=Object.assign(Object.assign({},e),n),r=this.createTag(i.id||(0,o.O1)(11),a,[],s);r.modified=new Date,r.commit(),t.push(r.sid)}})),t},this.editTag=async e=>{const{sid:t,positionOptions:i,standardOptions:n,mediaOptions:s}=e,a=Object.assign(Object.assign({},i),n),o=this.data.getTag(t);o&&(this.updateTag(o,a,s),o.modified=new Date,o.commit())},this.removeTag=async e=>{const t=this.data.getTag(e.sid);if(void 0!==t&&this.data.removeTag(e.sid))return t&&t.objectAnnotationId&&this.engine.commandBinder.issueCommand(new _.SO(t.objectAnnotationId)),e.sid},this.saveNewTag=async e=>{const{id:t,properties:i,embed:n,fileAttachments:s}=e,a=n?{mediaSrc:n.src,mediaType:(0,u.F5)(n.mediaType)}:void 0;return this.createTag(t,i,s,a),this.engine.commandBinder.issueCommand(new d.V({dataTypes:[r.g.MATTERTAGS]}))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.data.getTag(t);if(!o)return void this.log.debug("Cannot save non-existent tag");const h=a?(0,u.F5)(a.mediaType):p.z.none,l=a?a.src:"";void 0!==a&&(l===o.mediaSrc&&h!==o.mediaType||this.updateExternalAttachment(o,a));const c=void 0!==a?{mediaSrc:l,mediaType:h}:void 0;return this.updateTag(o,i,c),n.forEach((e=>{o.fileAttachments.push(e)})),this.removeFileAttachments(o,s),this.data.addTag(o),this.data.updateOnStaleCallbacks(t),this.engine.commandBinder.issueCommand(new d.V({dataTypes:[r.g.MATTERTAGS]}))}}async init(e,t){const{readonly:i,baseUrl:n}=e;this.engine=t,this.descParser=new y.$({supportLinks:!0,keepLinkLabels:!0}),[this.meshQueryModule,this.cameraData,this.layersData]=await Promise.all([t.getModuleBySymbol(s.hi),t.market.waitForData(U.M),t.market.waitForData($.R)]),this.store=new j({context:this.layersData.mdsContext,readonly:i,includeDisabled:!i,baseUrl:n},e.objectTagsEnabled);const a=await t.getModuleBySymbol(s.Lx);this.data=new g.n,this.bindings.push(this.store.onNewData((async i=>{this.initializeTagData(i,t.market,e.parserOptions)})),t.commandBinder.addBinding(m.cH,this.getDiscPositions),t.commandBinder.addBinding(m.Fz,this.addTag),t.commandBinder.addBinding(m.Ek,this.editTag),t.commandBinder.addBinding(m.Gn,this.removeTag)),await this.store.refresh(),i||(this.bindings.push(t.commandBinder.addBinding(m.Mm,this.saveNewTag),t.commandBinder.addBinding(m.qq,this.saveTag),a.onSave((()=>this.save()),{dataType:r.g.MATTERTAGS})),this.monitor=new l.c(this.data.collection,{aggregationType:c.E.Manual,shallow:!0})),t.market.register(this,g.n,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}async save(){if(this.monitor&&this.monitor.commitChanges(),!this.store||!this.monitor)return void this.log.warn("Mattertags changes will NOT be saved");const e=this.monitor.getDiffRecord();this.monitor.clearDiffRecord();const t=e.map((e=>{var t;const i=e.diff.layerId||(null===(t=this.data.getTag(e.index))||void 0===t?void 0:t.layerId);return Object.assign({layerId:i},e)})).filter((e=>!this.layersData.isInMemoryLayer(e.layerId))),i=t.filter((e=>e.action===h.KI.removed)).map((e=>({sid:e.index,layerId:e.layerId}))),n=t.filter((e=>e.action===h.KI.added)).map((e=>this.data.getTag(e.index))),s=t.filter((e=>e.action===h.KI.updated)).map((e=>{const t=Object.assign({sid:e.index,layerId:e.layerId},e.diff),i=this.data.getTag(e.index);return"mediaSrc"in t&&(t.mediaType=i.mediaType),t.objectAnnotationId=i.objectAnnotationId,!t.roomId&&i.roomId&&(t.roomId=i.roomId),t}));await this.store.delete(i),await this.store.create(n),await this.store.update(s,this.filesToUnattach)}clearDiffRecord(){this.monitor&&this.monitor.clearDiffRecord()}initializeTagData(e,t,i){var n;const s=i?new y.$(i):this.descParser;this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,{})})),this.data.atomic((()=>{for(const t in e){const i=e[t];i.parsedDescription=s.parse(e[t].description,this.layersData.currentViewId),this.meshQueryModule.inferMeshIdsFromPoint(i,i.anchorPosition),this.data.addTag(i)}})),this.data.onStale=()=>this.store.refreshFileAttachments(),this.data.updateOnStaleCallbacks(),null===(n=this.monitor)||void 0===n||n.clearDiffRecord()}createTag(e,t,i,n){let s=e;for(;this.data.getTag(s);)s=(0,o.O1)(11);const r=new a.U;if(r.sid=s,r.layerId=this.layersData.activeLayerId,n){const e=(0,u.gj)(n.mediaType);if(n.mediaSrc&&e){const t=(0,u.Nc)(s,n.mediaSrc,e);t&&r.externalAttachments.push(t)}}return t.objectAnnotationId&&(r.objectAnnotationId=t.objectAnnotationId),t.keywords&&(r.keywords=t.keywords),i.forEach((e=>{r.fileAttachments.push(e)})),this.updateTag(r,t,n),this.data.addTag(r),this.data.updateOnStaleCallbacks(s),r}updateTag(e,t,i){e.updateFromOptions(t,this.descParser,this.layersData.currentViewId),void 0!==(null==i?void 0:i.mediaType)&&(e.mediaType=i.mediaType),void 0!==(null==i?void 0:i.mediaSrc)&&(e.mediaSrc=i.mediaSrc.slice())}removeFileAttachments(e,t){const{fileAttachments:i}=e;t.forEach((t=>{const n=i.findIndex((e=>e.id===t.id));-1!==n?(i.splice(n,1),this.filesToUnattach.push({attachment:t,layerId:e.layerId})):this.log.debug("Attempting to remove an attachment that is not in the tag")}))}updateExternalAttachment(e,t){const{mediaSrc:i}=e;i&&e.externalAttachments.replace([]),t&&e.externalAttachments.replace([t])}}},22533:(e,t,i)=>{"use strict";var n;i.d(t,{S:()=>n}),function(e){e[e.Standard=0]="Standard",e[e.Depth=1]="Depth",e[e.Transparent=2]="Transparent",e[e.Wireframe=3]="Wireframe",e[e.UV=4]="UV"}(n||(n={}))},7402:(e,t,i)=>{"use strict";i.d(t,{g:()=>h});var n=i(81396),s=i(17878),a=i(56512),o=i(82814),r=i(12529),d=i(53203);class h extends o.S{constructor(e,t,i=s.o.ALL){super(),this._opacity=1,this._chunks=[],this.size=new n.Vector3,this.center=new n.Vector3,this.built=!1,this.layers.mask=i.mask,this.name=`RoomMesh:${e}-${t}`,this.meshGroup=e,this.meshSubgroup=t,this.renderOrder=r.z.default,this.onBeforeRender=(e,t,i,n,s,a)=>{this.updateUniforms(s,a)}}dispose(){this.reset()}reset(){this._chunks.length=0,this.geometry.dispose(),delete this.onBuild,delete this.onOpacityUpdate,this.built=!1}addChunk(e){-1===this._chunks.indexOf(e)&&this._chunks.push(e)}getChunk(e){return this._chunks[e]}build(){if(this.built)throw new Error("build() should only be called once");if(!this._chunks.length)return;const e=(0,a.qf)(this._chunks.map((e=>e.geometry)));e.clearGroups();let t=0;this.material=[],this._chunks.forEach(((i,n)=>{i.geometry&&i.geometry.index&&(e.addGroup(t,i.geometry.index.count,n),t+=i.geometry.index.count,i.geometry.dispose(),i.geometry=e,i.notifyOnMaterialUpdated((e=>{Array.isArray(this.material)&&(this.material[n]=e),this.onMaterialUpdate&&this.onMaterialUpdate()})),i.onOpacityUpdate=e=>{this.opacity=e})})),this.geometry=e,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.material=this._chunks.map((e=>e.material)),this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}buildWithTileChunk(e){if(this.built)return;const{meshGroup:t,meshSubgroup:i,lod:n}=e;this.name=`RoomMesh:${n}-${t}-${i}-${e.chunkIndex}`,this.meshGroup=t,this.meshSubgroup=i,this._chunks.push(e),e.notifyOnMaterialUpdated((e=>{this.material=e,this.onMaterialUpdate&&this.onMaterialUpdate()})),e.onOpacityUpdate=e=>{this.opacity=e},this.size=this.boundingBox.getSize(this.size),this.center=this.boundingBox.getCenter(this.center),this.built=!0,this.onBuild&&this.onBuild()}updateUniforms(e,t){e instanceof n.RawShaderMaterial&&(t?this.chunks[t.materialIndex].onBeforeDraw(e):this.chunks.length&&this.chunks[0].onBeforeDraw(e))}get boundingBox(){return(0,a.A5)(this.geometry)}set opacity(e){e!==this.opacity&&(this._opacity=e,this.raycastEnabled=e>d.xx.FADE_CLICKABLE_THRESHOLD,this.renderOrder=e<d.xx.FADE_OPAQUE?r.z.ghostFloor:r.z.default,this.onOpacityUpdate&&this.onOpacityUpdate(e))}get opacity(){return this._opacity}get chunks(){return this._chunks}getSortKey(){return this.chunks.length?this._chunks[0].getSortKey():0}}},51411:(e,t,i)=>{"use strict";i.d(t,{n:()=>s});var n=i(19663);class s extends n.m{constructor(e,t,i){super(),this.id="MESH_PREVIEW_POSITION",this.payload={enabled:e,previewCirclePosition:t,size:i}}}},68191:(e,t,i)=>{"use strict";i.d(t,{U:()=>a});var n=i(19663),s=i(22533);class a extends n.m{constructor(e){super(),this.id="SET_CHUNK_RENDER_MODE",this.payload={mode:e}}}a.modes=s.S},38987:(e,t,i)=>{"use strict";i.d(t,{u:()=>s});var n=i(19663);class s extends n.m{constructor(e=null){super(),this.id="SET_MOUSE_CURSOR",this.payload={cursor:e}}}},34956:(e,t,i)=>{"use strict";var n;i.d(t,{C:()=>n}),function(e){e.NONE="none",e.DEFAULT="default",e.MOVE="move",e.MOVE_LF="col-resize",e.MOVE_UD="row-resize",e.XHAIR="crosshair",e.PLUS="cell",e.QUESTION="help",e.NOPE="not-allowed",e.FINGER="pointer",e.TEXT="text",e.TEXT_VERT="vertical-text",e.ZOOM_IN="zoom-in",e.ZOOM_OUT="zoom-in",e.GRAB="grab",e.GRABBING="grabbing",e.ARROW_R="e-resize",e.ARROW_L="w-resize",e.ARROW_U="n-resize",e.ARROW_D="s-resize",e.ARROW_UR="ne-resize",e.ARROW_UL="nw-resize",e.ARROW_DR="se-resize",e.ARROW_DL="sw-resize",e.ARROW_LR="ew-resize",e.ARROW_UD="ns-resize",e.ARROW_URDL="nesw-resize",e.ARROW_ULDR="nwse-resize",e.ROOMBOUNDS_DEFAULT="rbe-default",e.ROOMBOUNDS_MOVING="rbe-moving",e.ROOMBOUNDS_PLACE_NODE="rbe-place-node",e.ROOMBOUNDS_FINISH_ROOM="rbe-finish-room"}(n||(n={}))},39564:(e,t,i)=>{"use strict";i.d(t,{t:()=>a});var n=i(67992),s=i(15637);class a extends n.V{constructor(e){super(),this.name="notes-data",this.notes=(0,s.q)(e)}iterate(e){for(const t of this.notes)e(t)}updateNote(e){this.notes.has(e.id)?this.notes.get(e.id).copy(e):this.notes.set(e.id,e)}updateNoteProperties(e,t){if(this.notes.has(e)){const i=this.notes.get(e);let n=!1;void 0!==t.resolved&&t.resolved!==i.resolved&&(i.resolved=t.resolved,n=!0),void 0!==t.color&&t.color!==i.color&&(i.color=t.color,n=!0),void 0!==t.anchorPosition&&t.anchorPosition!==i.anchorPosition&&(i.anchorPosition=t.anchorPosition,n=!0),void 0!==t.stemNormal&&t.stemNormal!==i.stemNormal&&(i.stemNormal=t.stemNormal,n=!0),void 0!==t.stemLength&&t.stemLength!==i.stemLength&&(i.stemLength=t.stemLength,n=!0),void 0!==t.stemEnabled&&t.stemEnabled!==i.stemEnabled&&(i.stemEnabled=t.stemEnabled,n=!0),void 0!==t.floorId&&t.floorId!==i.floorId&&(i.floorId=t.floorId,n=!0),void 0!==t.roomId&&t.roomId!==i.roomId&&(i.roomId=t.roomId,n=!0),n&&i.commit()}}removeNote(e){this.notes.has(e)&&(this.notes.delete(e),this.commit())}getNote(e){return this.notes.get(e)}getNoteProperties(e){const t=this.notes.get(e);if(!t)return null;return Object.assign({},t)}get collection(){return this.notes}}},19998:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AddCommentCommand:()=>X.Df,CancelCommentChangesCommand:()=>X.oH,CancelNewNoteCommand:()=>X.gc,CloseNoteCommand:()=>X._N,Comment:()=>we,DeleteCommentCommand:()=>X.mH,DeleteNoteCommand:()=>X.sG,EditCommentCommand:()=>X.x4,FilterVisibleNotesCommand:()=>X.Gx,FocusCommentMessage:()=>ee.J,HashtagData:()=>Q.c,Note:()=>q,NoteColorVariant:()=>G.Y,NoteResolutionChangeMessage:()=>ee.h,NotesData:()=>J.t,NotesFilter:()=>G.$,NotesModeToggleCommand:()=>X.yK,NotesPhase:()=>z.U,NotesViewData:()=>Y.X,NotesVisibilityFilterEnabledCommand:()=>X.GV,OpenNoteCommentCommand:()=>X.yP,ResolveNoteCommand:()=>X.yp,SaveNewNoteCommand:()=>X.FB,SaveNoteAppearanceCommand:()=>X.oE,SaveNoteChangesCommand:()=>X.kd,StartNewNoteCommand:()=>X.VI,ToggleNoteToolEditorCommand:()=>X.df,ToggleNotesFilterCommand:()=>X.RO,UpdateCommentCommand:()=>X.Uw,default:()=>Le});var n=i(97542),s=i(23379),a=i(35895),o=i(5823),r=i(87926);const d=i.p+"images/NoteColor.png";var h=i(39880),l=i(64918),c=i(52528),m=i(95160),u=i(76631),p=i(40964),g=i(89549),y=i(91380),v=i(92211),w=i(20436),b=i(66197),f=i(5686),T=i(10374),D=i(53954),C=i(23254),P=i(34029),A=i(5135),S=i(79727),k=i(80742),I=i(14630),E=i(64773),O=i(12039),N=i(72936),M=i(62612),x=i(60083),B=i(13132),V=i(43470),R=i(86283),L=i(16935),F=i(5604),H=i(44877),j=i(35446),U=i(21149),z=i(38965),G=i(22744),_=i(81396),$=i(75287),K=i(10385),W=i(67622),Z=i(39693);class q extends $.T{constructor(e){super(),this.id="",this.layerId="",this.color=Z.Rn,this.anchorPosition=new _.Vector3,this.stemNormal=new _.Vector3,this.stemLength=Z.ZP.stem.length,this.stemEnabled=!0,this.created=new Date,this.modified=new Date,this.lastCommentMs=(new Date).getTime(),this.resolved=!1,this.user=(0,W.Q)(""),this.comments=(0,K.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.resolved=e.resolved,this.color=e.color,this.floorId=e.floorId,this.roomId=e.roomId,this.anchorPosition.copy(e.anchorPosition),this.stemNormal.copy(e.stemNormal),this.stemLength=e.stemLength,this.stemEnabled=e.stemEnabled,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.lastCommentMs=e.lastCommentMs,this.comments.replace(e.comments.values()),this.commit(),this}getComment(e){return this.comments.find((t=>t.id===e))||null}updateComment(e){const t=this.comments.findIndex((t=>t.id===e.id));-1!==t&&(e.assetId=this.id,this.comments.update(t,e))}deleteComment(e){const t=this.comments.findIndex((t=>t.id===e));-1!==t&&this.comments.splice(t,1)}}var J=i(39564),Y=i(66291),Q=i(10359),X=i(24696),ee=i(35004),te=i(39586),ie=i(17788),ne=i(95548),se=i(97998),ae=i(63665),oe=i(65222),re=i(40731),de=i(2569);const he=new se.Z("mds-note-serialize");class le{constructor(){this.getNoteDetails=(e,t,i)=>{const n={enabled:!0,floorId:"",roomId:void 0};void 0!==e.floorId&&""!==e.floorId&&(n.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(n.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(n.color=e.color),void 0!==e.stemEnabled&&(n.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(n.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,re.u)(e.anchorPosition)&&(n.anchorPosition=de.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,re.u)(e.stemNormal)&&(n.stemNormal=de.ep.toVisionVector(e.stemNormal)),void 0!==e.resolved&&(n.resolution=e.resolved?o.d7.RESOLVED:o.d7.OPEN),i&&e.layerId&&(n.layerId=e.layerId);const s={text:t};return n.comment=s,Object.keys(n).length>0?n:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","enabled"].filter((t=>!(t in e))),i=0===t.length,n=!!e.floorId&&"string"==typeof e.floorId,s=!!e.anchorPosition&&(0,re.u)(e.anchorPosition),a=i&&n&&s;return a||he.debug("Note invalid:",{missingFields:t,validPosition:s}),a}}serialize(e,t,i){const n=this.getNoteDetails(e,t,i);return this.validate(n)?n:null}}class ce{constructor(){this.getNotePatch=(e,t)=>{if(!e)return null;const i={};return void 0!==e.floorId&&""!==e.floorId&&(i.floorId=e.floorId),void 0!==e.roomId&&""!==e.roomId&&(i.roomId=e.roomId),void 0!==e.color&&""!==e.color&&(i.color=e.color),void 0!==e.stemEnabled&&(i.stemEnabled=e.stemEnabled),void 0!==e.stemLength&&(i.stemLength=e.stemLength),void 0!==e.anchorPosition&&(0,re.u)(e.anchorPosition)&&(i.anchorPosition=de.ep.toVisionVector(e.anchorPosition)),void 0!==e.stemNormal&&(0,re.u)(e.stemNormal)&&(i.stemNormal=de.ep.toVisionVector(e.stemNormal.normalize())),t&&e.layerId&&(i.layerId=e.layerId),Object.keys(i).length>0?i:null},this.validate=e=>{if(!e)return!1;const t=["floorId","roomId","color","anchorPosition","stemNormal","stemLength","stemEnabled","stemNormal","enabled"];return Object.keys(e).every((e=>t.includes(e)))}}serialize(e,t){const i=this.getNotePatch(e,t);return i&&this.validate(i)?i:null}}var me=i(9133),ue=i(37519);function pe(e){const t=Object.assign({modelAccess:o.x6.PUBLIC},e);return t.__typename&&delete t.__typename,t}const ge=new se.Z("mds-note-deserializer");class ye{constructor(e,t){this.commentDeserializer=e,this.userData=t,this.validate=e=>{if(!e)return!1;const t=["id","created","modified","floor","resolution"].filter((t=>!(t in e))),i=0===t.length,n=!(!e.floor||!e.floor.id);return i&&n||ge.debug("Note invalid:",{missingFields:t,validFloor:n}),i&&n}}deserialize(e){var t;if(!e||!this.validate(e)||!e.floor)return ge.debug("Deserialized invalid Note data from MDS",e),null;const i=new q;i.id=e.id,i.layerId=(null===(t=e.layer)||void 0===t?void 0:t.id)||"",i.floorId=e.floor.id,e.room&&e.room.id&&(i.roomId=e.room.id),i.resolved=e.resolution===o.d7.RESOLVED,i.created=(0,me.p)(e.created),i.modified=(0,me.p)(e.modified),i.user=this.userData.loadContributor(pe(e.createdBy)),i.lastCommentMs=(0,me.p)(e.lastCommentAt).getTime();const n=this.deserializeComments(e);if(!(n.length>0))return ge.error("Note without a comment:",i.id),null;i.comments.replace(n),e.color&&(i.color=e.color);const s=e.anchorPosition?de.ep.fromVisionVector(e.anchorPosition):void 0;s&&(i.anchorPosition=s),(0,ue.hj)(e.stemLength)&&(i.stemLength=e.stemLength);const a=e.stemNormal?de.ep.fromVisionVector(e.stemNormal):void 0;return a?(i.stemNormal=a,i.stemEnabled=!!e.stemEnabled):(i.stemNormal=new _.Vector3(0,0,0),i.stemEnabled=!!e.stemEnabled),i}deserializeComments(e){var t;const i=(null===(t=e.comments)||void 0===t?void 0:t.results)||[],n=[];return i.forEach((t=>{const i=this.commentDeserializer.deserialize(t);i&&(i.assetId=e.id,n.push(i))})),n}}class ve{constructor(){this.validate=e=>!!e}serialize(e){if(void 0===e.text)return null;const t={text:e.text};return t&&this.validate(t)?t:null}}class we extends $.T{constructor(e){super(),this.id="",this.assetId="",this.text="",this.user=(0,W.Q)(""),this.created=new Date,this.modified=new Date,this.edited=!1,this.attachments=(0,K.C)([]),e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.user=e.user,this.assetId=e.assetId,this.created.setTime(e.created.getTime()),this.modified.setTime(e.modified.getTime()),this.text=e.text,this.edited=e.edited,this.attachments=e.attachments,this.commit(),this}}const be=new se.Z("mds-comment-deserializer");class fe{constructor(e,t,i){this.fileDeserializer=e,this.embedDeserializer=t,this.userData=i}deserialize(e){if(!e||!this.validate(e))return be.debug("Deserialized invalid Comment data from MDS",e),null;const t=new we;t.id=e.id,t.created=(0,me.p)(e.created),t.modified=(0,me.p)(e.modified),e.text&&(t.text=e.text),t.edited=e.edited,t.user=this.userData.loadContributor(pe(e.createdBy));const i=this.deserializeExternalAttachments(e),n=this.deserializeFileAttachments(e),s=i.concat(n).sort(((e,t)=>e.created.getTime()-t.created.getTime()));return s.length>0&&t.attachments.replace(s),t}deserializeExternalAttachments(e){const t=e.externalAttachments||[],i=[];return t.forEach((t=>{const n=this.embedDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.ud.COMMENT,i.push(n))})),i}deserializeFileAttachments(e){const t=e.fileAttachments||[],i=[];return t.forEach((t=>{const n=this.fileDeserializer.deserialize(t);n&&(n.parentId=e.id,n.parentType=o.ud.COMMENT,i.push(n))})),i}validate(e){if(!e)return!1;const t=["id","created","modified","edited","createdBy"].filter((t=>!(t in e))),i=0===t.length;return i||be.debug("Comment invalid:",{missingFields:t}),i}}var Te=i(44571),De=i(36159);const Ce=new se.Z("MdsNoteStore");class Pe extends ie.u{constructor(e,t){super(e),this.userData=t,this.prefetchKey="data.model.notes",this.layeredType=o.SF.NOTE,this.embedDeserializer=new ae.d,this.fileDeserializer=new oe.O,this.commentDeserializer=new fe(this.fileDeserializer,this.embedDeserializer,this.userData),this.deserializer=new ye(this.commentDeserializer,this.userData),this.createSerializer=new le,this.patchSerializer=new ce,this.commentSerializer=new ve}async read(e){const t={modelId:this.getViewId(),ids:null,includeLayers:this.readLayerId()};return this.query(Te.GetNotes,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;if(!n||!Array.isArray(n))return{};const s=[];for(const e of n){const t=this.deserializer.deserialize(e);t&&s.push(t)}return s.reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async readNote(e,t){const i={modelId:this.getViewId(),ids:[e],includeLayers:this.readLayerId()};return this.query(Te.GetNotes,i,t).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.notes;return n&&Array.isArray(n)&&1===n.length?this.deserializer.deserialize(n[0]):null}))}async create(e,t){var i;const n=this.getViewId(),s=this.createSerializer.serialize(e,t,this.writeLayerId(e.layerId));if(!s)throw Ce.error("Failure creating note:",e.id,e),new Error("Could not create Note");const a={modelId:n,data:s,includeLayers:this.readLayerId()},o=await this.mutate(Te.AddNote,a).catch((e=>{throw new ne.w0(e)}));if(null===(i=o.data)||void 0===i?void 0:i.addNote){const e=this.deserializer.deserialize(o.data.addNote);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new Note")}async update(e){const t=this.getViewId(),i=e.id,n=this.patchSerializer.serialize(e,!1);if(!n||!i)throw Ce.error("Failure updating note:",i),new Error("Could not update Note");const s={modelId:t,noteId:i,data:n,includeLayers:this.readLayerId()};return this.mutate(Te.PatchNote,s).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchNote)?this.deserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchNote):null}))}async updateResolution(e,t){const i={modelId:this.getViewId(),noteId:e};return t?this.mutate(Te.ResolveNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.resolveNote})):this.mutate(Te.ReopenNote,i).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.reopenNote}))}async delete(e){const t=this.getViewId();for(const i of e)await this.mutate(Te.DeleteNote,{modelId:t,noteId:i.id})}async createComment(e,t){const i=this.getViewId(),n=this.commentSerializer.serialize(t);if(!n)throw Ce.error("Failure creating comment:",t),new Error("Could not create Comment");const s={modelId:i,noteId:e,data:n};return this.mutate(Te.AddNoteComment,s).then((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.addNoteComment)?this.commentDeserializer.deserialize(e.data.addNoteComment):null}))}async updateComment(e){const t=this.getViewId(),i=e.id,n=this.commentSerializer.serialize(e);if(!n||!i)throw Ce.error("Failure updating comment:",i),new Error("Could not update Comment");const s={modelId:t,commentId:i,data:n};return this.mutate(De.PatchComment,s).then((e=>{var t,i;return(null===(t=e.data)||void 0===t?void 0:t.patchComment)?this.commentDeserializer.deserialize(null===(i=e.data)||void 0===i?void 0:i.patchComment):null}))}async deleteComment(e){const t=this.getViewId();if(!e||!(null==e?void 0:e.id))throw new Error("MdsNoteStore.deleteComment failed");const i={modelId:t,commentId:e.id};await this.mutate(De.DeleteComment,i)}}var Ae=i(54244),Se=i(89570),ke=i(71166),Ie=i(56163),Ee=i(35221);class Oe extends Ie.K{constructor(e,t,i,n,s,a,r){super(e,t,i),this.comment=n,this.note=s,this.textParser=a,this.asWholeNote=r,this.id=this.comment.id,this.parentId=this.note.id,this.title=this.comment.user.name,this.description=this.textParser.getPlainText(this.comment.text),this.icon="icon-comment",this.typeId=o.SF.NOTE,this.floorId=this.note.floorId,this.roomId=this.note.roomId||"",this.layerId=this.note.layerId,this.dateBucket=this.getNoteOrCommentDateBucket(),this.color=this.note.color,this.resolved=this.note.resolved,this.numAttachments=this.comment.attachments.length,this.numComments=this.note.comments.length,this.user=this.comment.user,this.enabled=!this.note.resolved,this.onSelect=async(e,t,i)=>{super.onSelect(),await this.commandBinder.issueCommand(new V.yL);const n=t===u.w1.NOTES||i||e;this.commandBinder.issueCommand(new X.yP(this.note.id,n,!1,this.comment.id))}}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}getNoteOrCommentDateBucket(){return(0,Ee.f)(new Date(this.asWholeNote?this.note.lastCommentMs:this.comment.created))}}var Ne=i(38399);const{NOTES:Me}=Ne.Z.SHOWCASE;var xe=i(635),Be=i(79728),Ve=i(28022);class Re extends n.Y{constructor(){super(...arguments),this.name="notes",this.activated=!1,this.registered=!1,this.activeBindings=[],this.refreshPromise=null,this.pollOnNotes=()=>{let e;return(0,a.k1)((()=>{clearInterval(e),e=window.setInterval((()=>{this.refreshNotes()}),1e3*Z.GR)}),(()=>{window.clearInterval(e)}),!0)},this.modelViewChanged=()=>{this.cancelNoteCreation(!0)},this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(Z.Mp,!1),t=!this.in360View(),i=!this.interactionmodeData.isVR(),n=t&&i&&e,s=n?this.getFilteredNoteIds(!1):[];this.engine.commandBinder.issueCommand(new N.kb(M.Er.NOTE,n?1:0,s)),n||this.closeNoteBillboard()},this.toggleNotesMode=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.togglePinAssetEditor=async e=>{this.viewData.setActiveNotation(null),e.opened?this.changeNotesPhase(z.U.EDITING):this.viewData.notesPhase===z.U.EDITING&&this.changeNotesPhase(z.U.OPEN)},this.toggleNotesFilter=async e=>{const{filter:t,enabled:i}=e;i?this.viewData.setNotesFilter(t):this.viewData.setNotesFilter(G.$.ALL)},this.openNoteToComment=async e=>{const{noteId:t,commentId:i,dock:n,edit:s,transition:a}=e,o=this.viewData,r=o.getNoteView(t);if(!r)return void this.log.error(`Missing note ${t}`);const{notesFilter:d}=o,h=d===G.$.RESOLVED;d!==G.$.ALL&&r.resolved!==h&&o.setNotesFilter(G.$.ALL);const c=n||s,m=this.toolsData.toolPanelLayout===u.wS.SIDE_PANEL?l.n.FadeToBlack:l.n.Instant;await this.openNote(t,a||m,c,i,s),this.openAnnotation(t,c)},this.onAppChange=()=>{this.deactivateTool(),this.updatePerSettings(),this.displayNotes()},this.onNotesPhaseChanged=()=>{let e=!0;const t=this.toolsData.toolPanelLayout===u.wS.BOTTOM_PANEL;switch(this.viewData.notesPhase){case z.U.EDITING:case z.U.CREATING:e=!1;break;case z.U.OPENING:case z.U.OPEN:e=!t}this.engine.broadcast(new p.ps(e))},this.changeNotesPhase=e=>{e!==this.viewData.notesPhase&&this.viewData.setNotesPhase(e)},this.onCloseNote=async()=>{this.closeNote()},this.pinAddCancelled=e=>{e.pinType===M.Er.NOTE&&this.cancelNoteCreation(!1)},this.onCancelNewNote=async()=>{this.cancelNoteCreation(!0)},this.cancelNoteCreation=e=>{var t;if(!this.userData.isCommenter())return;const i=this.viewData,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id;n&&(e&&this.engine.commandBinder.issueCommand(new N.tT(n,M.Er.NOTE)),this.engine.commandBinder.issueCommand(new V.Aj(n,R.J.NOTE))),this.cancelAttachmentChanges(),i.setActiveNotation(null),i.setOpenNoteView(null),i.setFocusedComment(null),i.isNewNote=!1,i.commit(),this.changeNotesPhase(z.U.IDLE)},this.notesWereChanged=()=>{this.parseNotes(),this.updateNoteViewData(),this.displayNotes()},this.onNoteFilterChanged=()=>{this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),this.updateNoteViewData(),this.displayNotes()},this.onViewModeOrFloorChanged=()=>{this.updatePerSettings()},this.onLayersChanged=()=>{this.closeNoteBillboard(),this.displayNotes()},this.onOpenNoteViewChanged=()=>{const e=this.viewData.openNoteView;e&&this.updateNotePin(e)},this.startNoteCreation=async()=>{if(!this.userData.isCommenter())return;this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!1));const e=this.viewData,t=this.appData.application===Ae.Mx.WORKSHOP;let i=(0,h.O1)(11);for(;this.notesData.getNote(i);)i=(0,h.O1)(11);const n=new q;n.user=this.userData.getCurrentUser(),n.id=i,n.floorId=this.floorsViewData.getHighestVisibleFloorId(),n.layerId=this.layersData.getNotesLayerId(t);const s=e.createNoteView(n);e.isNewNote=!0,e.commit(),this.changeNotesPhase(z.U.CREATING),e.setOpenNoteView(s),e.setFocusedComment(null),this.engine.commandBinder.issueCommand(new N.fM(n.id,this.getPinUpdate(n),M.Er.NOTE,s.backgroundTexture))},this.saveNewNote=async e=>{if(!this.userData.isCommenter())return;const{text:t}=e,i=this.viewData,n=i.getPendingNote();if(n){if(this.layersData.isInMemoryLayer(n.layerId)){const e=new q(n);return this.notesData.updateNote(e),i.setActiveNotation(null),i.isNewNote=!1,i.commit(),void this.updateNoteViewData()}const e=await this.store.create(n,t);if(!e)return void this.log.error("MDS Note saved failed");const s=e.comments.get(0);if(!s)throw new Error("No root comment in the new note");const a=await this.confirmAttachmentChanges(s.id,n.id);this.notesData.updateNote(e),a&&await this.refreshNote(e.id),this.parseMarkdown(t),i.setOpenNoteView(i.getNoteView(e.id));const o=i.openNoteView;if(o){const t=(0,H.CM)(this.userData,R.J.NOTE,o.user);this.engine.commandBinder.issueCommand(new N.Ar(e.id,M.Er.NOTE,t)),this.engine.commandBinder.issueCommand(new N.OL(n.id,M.Er.NOTE))}i.setActiveNotation(null),i.isNewNote=!1,i.commit(),this.updateNoteViewData()}else this.log.debug("No pending note")},this.pinMoved=async e=>{const{id:t,pinType:i,pinPos:n}=e,s=this.viewData.openNoteView;if(s&&i===M.Er.NOTE&&t===s.id){const e=this.notesData.getNote(t);if(e){if(this.layersData.isInMemoryLayer(e.layerId))return;const{anchorPosition:i,stemNormal:s,floorId:a,roomId:o}=n;this.store.update({id:t,anchorPosition:i,stemNormal:s,floorId:a,roomId:o}).then((e=>{e&&this.notesData.updateNote(e)}))}else this.log.debug("Cannot move a non-existent note")}},this.pinPlaced=e=>{const t=this.viewData.openNoteView;t&&e.pinType===M.Er.NOTE&&e.id===t.id&&(this.viewData.updateOpenNoteView(e.pinPos),this.changeNotesPhase(z.U.OPEN),this.viewData.setActiveNotation(t.id),this.openAnnotation(t.id,!0))},this.onEditComment=async e=>{this.viewData.setActiveNotation(e.id)},this.handlePinFocusChange=async()=>{const{openNoteView:e,isNewNote:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:s}=this.pinsViewData,{billboardAnnotation:a,billboardSelected:o}=this.annotationsViewData;if(!n)return void(a&&a.annotationType===R.J.NOTE&&a.id!==s&&this.closeNoteBillboard());const r=(null==e?void 0:e.id)===(null==a?void 0:a.id)&&o,d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeNote(),n.pinType===M.Er.NOTE){const t=this.viewData.getNoteView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no note view.");t.id!==(null==e?void 0:e.id)&&i.issueCommand(new V.Kw(t.id,R.J.NOTE))}},this.handleAnnotationsChanged=async()=>{const{openNoteView:e,isNewNote:t,focusedComment:i}=this.viewData;if(t)return;const{softOpening:n}=this.toolsData,{dockedAnnotation:s,selectedAnnotation:a}=this.annotationsViewData,o=s||a,r=(null==s?void 0:s.annotationType)===R.J.NOTE&&s,d=(null==a?void 0:a.annotationType)===R.J.NOTE&&a,h=r||d,l=!!r;h&&h.id!==(null==e?void 0:e.id)?await this.openNote(h.id,null,l):e&&e.id!==(null==o?void 0:o.id)&&this.closeNote(),l?(this.activated||await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!0)),i&&this.engine.broadcast(new ee.J(i.id))):this.activated&&n&&await this.engine.commandBinder.issueCommand(new g.CH(u.w1.NOTES))},this.handlePinSelectionChange=async()=>{const{openNoteView:e,activeNotation:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null;if(!e||n&&n.pinType===M.Er.NOTE){if(i&&n&&n.pinType===M.Er.NOTE){const t=(0,H.CM)(this.userData,R.J.NOTE,null==e?void 0:e.user);this.engine.commandBinder.issueCommand(new N.ic(i,!!t));const n=!0;await this.openNote(i,l.n.Interpolate,n),this.openAnnotation(i,n)}}else{const e=!this.toolsData.softOpening;this.activated&&!e?await this.engine.commandBinder.issueCommand(new g.CH(u.w1.NOTES)):this.closeNote()}},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==R.J.NOTE)return;const s=this.viewData.getNoteAttachments(i),a=s.find((e=>e.id===n));if(a&&(0,U.lV)(a)){const e=s.filter((e=>(0,U.lV)(e)));this.engine.commandBinder.issueCommand(new j.xW(!0,e,n))}},this.deleteNote=async e=>{const t=e.noteId,i=this.notesData.getNote(t);if(i){this.engine.commandBinder.issueCommand(new v.r),this.layersData.isInMemoryLayer(i.layerId)||this.store.delete([i]),this.notesData.removeNote(t);const e=this.viewData.openNoteView;e&&e.id===t&&this.closeNote(),this.engine.commandBinder.issueCommand(new N.OL(t,M.Er.NOTE))}else this.log.debug("Cannot delete a non-existent note")},this.onResolveNoteCommand=async e=>{const{noteId:t,resolved:i}=e;i?await this.resolveNote(t):await this.reopenNote(t)},this.onSaveNoteChanges=async e=>{const{noteId:t,text:i}=e,n=this.notesData.getNote(t);if(n){const e=n.comments.get(0);if(e)return this.updateNoteComment(t,e.id,i);this.log.warn("no root comment")}else this.log.debug("Cannot update a non-existent note")},this.cancelCommentChanges=async e=>{this.cancelAttachmentChanges(),this.viewData.setActiveNotation(null)},this.saveNoteAppearance=async e=>{const t=this.notesData,{noteId:i,properties:n}=e,s=t.getNote(i);if(s){const e=this.viewData,{openNoteView:a}=e;if(Object.keys(n)){const o=this.layersData.isInMemoryLayer(s.layerId)?Object.assign(s,n):await this.store.update(Object.assign({id:i},n));o&&(this.updateNotePin(o),t.updateNote(o),(null==a?void 0:a.id)===i&&e.updateOpenNoteView(n))}}else this.log.debug("Cannot update a non-existent note")},this.addComment=async e=>{const{noteId:t,text:i,replyId:n}=e,s=this.notesData.getNote(t);if(s){s.resolved&&(this.viewData.setNotesFilter(G.$.ALL),this.reopenNote(s.id));const e=await this.store.createComment(t,{text:i});return e?(this.viewData.setActiveNotation(null),this.parseMarkdown(i),await this.confirmAttachmentChanges(e.id,n),await this.refreshNote(s.id),this.refreshNotes(),e):(this.log.error("Cannot create MDS comment"),null)}return this.log.debug("Cannot add a comment to a non-existent note"),null},this.onUpdateComment=async e=>{const{noteId:t,commentId:i,text:n}=e;return this.updateNoteComment(t,i,n)},this.deleteComment=async e=>{const{commentId:t,noteId:i}=e,n=this.notesData.getNote(i);if(n){const e=n.getComment(t);e&&(this.layersData.isInMemoryLayer(n.layerId)||await this.store.deleteComment(e),n.deleteComment(t)),this.refreshNotes()}else this.log.debug("Cannot delete a comment in a non-existent note")},this.notationBlockClicked=async e=>{const{annotationType:t,block:i}=e;t===R.J.NOTE&&(i.blockType!==m.C.USER&&i.blockType!==m.C.HASH||(this.activated&&!this.toolsData.softOpening||await this.engine.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!1)),this.engine.commandBinder.issueCommand(new ke.H1(i.text||"")),i.text&&this.closeNote()))},this.filterVisibleNotes=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayNotes()},this.noteVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayNotes()}}async init(e,t){const[i,n,a,h]=await Promise.all([t.market.waitForData(P.e),t.market.waitForData(A.Z),t.market.waitForData(w.m),t.market.waitForData(Ae.pu)]);if(!a.isLoggedIn()||n.isVR()||!i.tryGetProperty(te.IA,!1))return;this.engine=t,this.config=e,this.interactionmodeData=n,this.userData=a,this.settingsData=i,this.appData=h;const[l,m,u,p,g,v,b]=await Promise.all([t.market.waitForData(y.t),t.market.waitForData(D.Z),t.market.waitForData(C.O),t.market.waitForData(S.c),t.market.waitForData(L.A),t.getModuleBySymbol(s.DeepLinksModuleKey),t.market.waitForData(k.R)]);this.toolsData=l,this.sweepData=m,this.viewmodeData=u,this.floorsViewData=p,this.annotationsViewData=g,this.linkHandler=v,this.layersData=b;const{readonly:f,baseUrl:O}=this.config;this.store=new Pe({context:b.mdsContext,readonly:f,includeDisabled:!0,baseUrl:O},this.userData);const N=()=>{this.store.setStoreViewId(b.getNonworkshopViewId())};N(),this.bindings.push(b.onPropertyChanged("currentViewId",N),b.onPropertyChanged("activeLayerId",(()=>this.updatePendingNote())),this.store.onNewData((async e=>{this.loadNewNotes(e)}))),this.notesData=new J.t({}),this.textParser=new c.v({links:!0,hashtags:!0,users:this.userData}),this.backgroundTexture=(0,r.p)(d),this.viewData=new Y.X(this.notesData,this.textParser,this.linkHandler,this.backgroundTexture),this.hashtagData=new Q.c,t.market.register(this,Q.c,this.hashtagData),this.pinsViewData=await t.market.waitForData(x.B),this.bindings.push(i.onPropertyChanged(Z.Mp,this.updatePerSettings),t.commandBinder.addBinding(X.yK,this.toggleNotesMode),t.commandBinder.addBinding(X.sG,this.modifyInsideSaveCommand(this.deleteNote)),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),g.onChanged(this.handleAnnotationsChanged),t.subscribe(F.q,this.handleViewingAttachment),t.subscribe(F.i,this.notationBlockClicked),t.commandBinder.addBinding(X.yP,this.openNoteToComment),t.subscribe(T.bS,this.onAppChange),u.makeModeChangeSubscription(this.onViewModeOrFloorChanged),p.makeFloorChangeSubscription(this.onViewModeOrFloorChanged),t.subscribe(I.Z,this.updatePerSettings),t.subscribe(E.m,this.updatePerSettings),this.layersData.onCurrentLayersChanged(this.onLayersChanged),t.commandBinder.addBinding(X.Gx,this.filterVisibleNotes),t.commandBinder.addBinding(X.GV,this.noteVisbilityFilterEnabled),this.pollOnNotes(),this.viewData.onOpenNoteViewChanged(this.onOpenNoteViewChanged),this.notesData.onChanged(this.notesWereChanged),this.notesData.collection.onElementChanged({onAdded:this.updateNotePin.bind(this),onUpdated:this.updateNotePin.bind(this),onRemoved:this.removeNotePin.bind(this)}),t.subscribe(Ve.YB,this.modelViewChanged)),t.market.register(this,Y.X,this.viewData),this.updatePerSettings(),this.parseNotes(),async function(e,t,i,n,s,a,r){let d=n.application===Ae.Mx.WORKSHOP;const h=(n,a,o,r=[])=>{const h=[],l=t.getFilteredNotesMap().values,c=!o,m=[];return 0===r.length&&l.forEach((t=>{if(!d&&!i.layerToggled(t.layerId))return;let o=0;t.comments.forEach(((r,d)=>{c&&d>0||n(r.user.name,s.getPlainText(r.text))&&(o++,h.push(new Oe(e,i,a,r,t,s,c)))})),o>0&&m.push(t.id)})),e.issueCommand(new X.Gx(m)),h},l=t=>{e.issueCommand(new X.GV(!!t))},c=e=>new Se.V(t.getFilteredNotesMap().onChanged(e),a.onChanged(e)),m={renew:()=>{e.issueCommandWhenBound(new ke.c6({id:o.SF.NOTE,groupPhraseKey:Me.SEARCH_GROUP_HEADER_NOTES,groupMatchingPhraseKey:Me.SEARCH_GROUP_HEADER,getSimpleMatches:h,registerChangeObserver:c,onSearchActivatedChanged:l,groupOrder:50,groupIcon:"comment-outline",batchSupported:!0}))},cancel:()=>{e.issueCommandWhenBound(new ke.Pe(o.SF.NOTE))}},u=()=>{d=n.application===Ae.Mx.WORKSHOP,r.tryGetProperty(te.IA,!1)||d?m.renew():m.cancel()},p=n.onPropertyChanged("application",u),g=r.onPropertyChanged(te.IA,u);return u(),new Se.V(m,p,g)}(t.commandBinder,this.viewData,this.layersData,h,this.textParser,this.userData,this.settingsData).then((e=>this.bindings.push(e))),await this.refreshNotes(),t.market.register(this,J.t,this.notesData)}dispose(e){this.deactivateTool(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new N.zM(M.Er.NOTE)),this.backgroundTexture.dispose(),this.store.dispose(),super.dispose(e)}onUpdate(){}async refreshNotes(){if(this.refreshPromise)return;const e=this.viewData,{isNewNote:t,notesPhase:i}=e;t||i===z.U.EDITING||(this.refreshPromise=this.store.refresh().finally((()=>{this.refreshPromise=null})))}loadNewNotes(e){var t;const{viewData:i}=this,n=null===(t=i.openNoteView)||void 0===t?void 0:t.id,s=n?{[n]:this.notesData.getNote(n)}:{};this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,s)})),this.notesData.atomic((()=>{this.layersData.replaceBackendLayers(this.notesData.collection,e)})),n&&!e[n]&&(this.log.debug("Open note was deleted"),i.setOpenNoteView(null),i.setFocusedComment(null),i.setActiveNotation(null),i.setNotesPhase(z.U.IDLE))}async refreshNote(e){if(this.refreshPromise)return;const t=this.notesData.getNote(e);if(this.layersData.isInMemoryLayer(null==t?void 0:t.layerId))this.notesData.updateNote(t);else{const t=await this.store.readNote(e);t&&this.notesData.updateNote(t)}}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new V.yL(R.J.NOTE)),this.userData.isCommenter()&&this.engine.commandBinder.issueCommand(new N.Ki(!0)),this.changeNotesPhase(z.U.IDLE),this.updateNoteViewData(),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0)}deactivateTool(e){var t;if(!this.activated)return;this.activated=!1;const{isNewNote:i,openNoteView:n}=this.viewData,s=(null===(t=this.annotationsViewData.dockedAnnotation)||void 0===t?void 0:t.annotationType)===R.J.NOTE;i?this.cancelNoteCreation(!0):n&&(e||s)&&this.closeNote(),this.changeNotesPhase(z.U.CLOSED),this.engine.commandBinder.issueCommand(new N.iK),this.engine.commandBinder.issueCommand(new N.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()}))}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(B.b0,this.pinPlaced),this.engine.subscribe(B.bV,this.modifyInsideSaveCommand(this.pinMoved)),this.engine.subscribe(B.hu,this.pinAddCancelled),e.addBinding(X.VI,this.startNoteCreation),e.addBinding(X.FB,this.modifyInsideSaveCommand(this.saveNewNote)),e.addBinding(X.gc,this.onCancelNewNote),e.addBinding(X._N,this.onCloseNote),e.addBinding(X.kd,this.modifyInsideSaveCommand(this.onSaveNoteChanges)),e.addBinding(X.oH,this.cancelCommentChanges),e.addBinding(X.x4,this.onEditComment),e.addBinding(X.yp,this.modifyInsideSaveCommand(this.onResolveNoteCommand)),e.addBinding(X.Df,this.modifyInsideSaveCommand(this.addComment)),e.addBinding(X.Uw,this.modifyInsideSaveCommand(this.onUpdateComment)),e.addBinding(X.mH,this.modifyInsideSaveCommand(this.deleteComment)),e.addBinding(X.oE,this.modifyInsideSaveCommand(this.saveNoteAppearance)),e.addBinding(X.df,this.togglePinAssetEditor),e.addBinding(X.RO,this.toggleNotesFilter),this.viewData.onNotesFilterChanged(this.onNoteFilterChanged),this.viewData.onNotesPhaseChanged(this.onNotesPhaseChanged)),this.registered=!0}async parseNotes(){const e=[],t=[];return this.notesData.iterate((i=>{i.comments.forEach((i=>{const n=this.getUserMentionsAndHashtags(i.text);n.emails.forEach((t=>{e.push({email:t,userStatus:b.J.MENTIONED})})),t.push(...n.hashtags)}))})),this.hashtagData.addHashtags(t),this.engine.commandBinder.issueCommand(new f.Vu(e))}async parseMarkdown(e){const t=[],i=this.getUserMentionsAndHashtags(e);return i.emails.forEach((e=>{t.push({email:e,userStatus:b.J.MENTIONED})})),this.hashtagData.addHashtags(i.hashtags),this.engine.commandBinder.issueCommand(new f.Vu(t))}getUserMentionsAndHashtags(e){const t=[],i=[];for(const n of this.textParser.parse(e))n.blockType===m.C.USER&&n.value?t.push(n.value):n.blockType===m.C.HASH&&i.push(n.text);return{emails:t,hashtags:i}}closeNoteBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===R.J.NOTE&&this.engine.commandBinder.issueCommand(new V.Aj(e.id,R.J.NOTE))}openAnnotation(e,t){t?this.engine.commandBinder.issueCommand(new V.bd(e,R.J.NOTE)):this.engine.commandBinder.issueCommand(new V.oM(e,R.J.NOTE))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeNote(){var e;const{commandBinder:t}=this.engine,{openNoteView:i,notesPhase:n}=this.viewData;if(this.viewData.setActiveNotation(null),this.viewData.setOpenNoteView(null),this.viewData.setFocusedComment(null),n!==z.U.CLOSED&&this.changeNotesPhase(z.U.IDLE),i){const n=i.id;this.cancelAttachmentChanges(),t.issueCommand(new ke.IL(null)),t.issueCommand(new j.xW(!1));const s=this.notesData.getNote(n);s&&(t.issueCommand(new N.RH(n,M.Er.NOTE)),t.issueCommand(new N.ik(n,M.Er.NOTE,this.getNoteVisibility(n,s.layerId,i.resolved))));(null===(e=this.annotationsViewData.dockedAnnotation)||void 0===e?void 0:e.annotationType)===R.J.NOTE&&await t.issueCommand(new V.JD)}}updateNoteViewData(){this.viewData.updateNoteViews()}getFilteredNoteIds(e){const t=[];return this.notesData.iterate((i=>{this.getNoteVisibility(i.id,i.layerId,i.resolved)===e&&t.push(i.id)})),t}getNoteVisibility(e,t,i){if(!this.settingsData.tryGetProperty(Z.Mp,!1))return!1;const{notesFilter:n,openNoteView:s,idVisibilityEnabled:a,idVisibility:o}=this.viewData,r=this.appData.application===Ae.Mx.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),h=(null==s?void 0:s.id)===e,l=!a||o.has(e),c=n===G.$.ALL||i&&n===G.$.RESOLVED||!i&&n===G.$.OPEN;return r&&(h||c&&l&&d)}displayNotes(){const e=[];this.notesData.iterate((t=>{const i=this.getPinUpdate(t);e.push(i)})),this.engine.commandBinder.issueCommand(new N.mE(e))}updateNotePin(e){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new N.mE([t]))}getPinUpdate(e){const{id:t,layerId:i,resolved:n,anchorPosition:s,color:a,stemEnabled:o,floorId:r,roomId:d,stemNormal:h,stemLength:l}=e;return{id:t,anchorPosition:s,color:a,floorId:r,roomId:d,stemEnabled:o,stemNormal:h,stemLength:l,pinType:M.Er.NOTE,backgroundTexture:this.backgroundTexture,icon:M.Qk[M.Er.NOTE],visible:this.getNoteVisibility(t,i,n)}}removeNotePin(e){this.engine.commandBinder.issueCommand(new N.OL(e.id,M.Er.NOTE))}async confirmAttachmentChanges(e,t){return this.engine.commandBinder.issueCommand(new j.iu(e,o.ud.COMMENT,t))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new j.Ze)}updatePendingNote(){const e=this.viewData.getPendingNote(),t=this.appData.application===Ae.Mx.WORKSHOP;e&&t&&!this.layersData.isInMemoryLayer(e.layerId)&&(e.layerId=this.layersData.getNotesLayerId(t))}setFocusedNoteComment(e,t){if(t){const i=this.viewData.getComment(e,t);this.viewData.setFocusedComment(i)}else this.viewData.setFocusedComment(null)}async openNote(e,t,i,n,s){var a;const r=(null===(a=this.annotationsViewData.dockedAnnotation)||void 0===a?void 0:a.annotationType)===R.J.NOTE,d=null!==i?i:r;return this.engine.commandBinder.issueCommand(new ke.IL(e,o.SF.NOTE)),d?this.dockNote(e,t,n,s):this.selectNote(e,t,n)}async selectNote(e,t,i){var n;const{commandBinder:s}=this.engine;this.setFocusedNoteComment(e,i);const a=this.viewData.getNoteView(e);if(a){const{openNoteView:i}=this.viewData,o=(null==i?void 0:i.id)===e,r=(null===(n=this.annotationsViewData.dockedAnnotation)||void 0===n?void 0:n.id)===e;if(o&&!r&&i)return void this.log.debug("Note is already selected");this.activated&&await s.issueCommand(new g.CH(u.w1.NOTES)),s.issueCommand(new j.xW(!1)),i&&(s.issueCommand(new V.Aj(i.id,R.J.NOTE)),s.issueCommand(new N.RH(i.id,M.Er.NOTE))),this.viewData.setOpenNoteView(a),await s.issueCommand(new N.Ar(e,M.Er.NOTE,!1)),null!==t&&await s.issueCommand(new O.OR({pinPosition:a,transition:t}))}else this.log.debug("Cannot select a non-existent note")}async dockNote(e,t,i,n=!1){var s;const{toolsData:a,viewData:o,engine:r,activated:d,userData:h}=this,l=o.getNoteView(e);if(l){const{openNoteView:c,focusedComment:m}=this.viewData,p=(null==c?void 0:c.id)===e,y=(null===(s=this.annotationsViewData.dockedAnnotation)||void 0===s?void 0:s.id)===e;if(a.toolCollapsed&&r.commandBinder.issueCommand(new g.Fg(!1)),this.setFocusedNoteComment(e,i),p&&y)return void(o.focusedComment&&i!==(null==m?void 0:m.id)&&this.engine.broadcast(new ee.J(o.focusedComment.id)));r.commandBinder.issueCommand(new v.r),d||await r.commandBinder.issueCommand(new g.z2(u.w1.NOTES,!0)),p||o.setOpenNoteView(l);const w=(0,H.CM)(h,R.J.NOTE,l.user);if(r.commandBinder.issueCommand(new N.Ar(e,M.Er.NOTE,w)),this.changeNotesPhase(z.U.OPENING),null!==t&&await r.commandBinder.issueCommand(new O.OR({pinPosition:l,transition:t})),this.changeNotesPhase(z.U.OPEN),n){const t=l.comments.get(0);let n=i?o.getComment(e,i):void 0;if(n||(n=t),!n)throw new Error("No root comment in the note");const s=(0,H.CM)(h,R.J.NOTE,n.user);o.setActiveNotation(s?n.id:null)}else o.setActiveNotation(null)}else this.log.debug("Cannot open a non-existent note")}async resolveNote(e){const t=this.notesData.getNote(e);if(t){if(t.resolved)return;this.closeNote(),await(0,h.gw)(350),this.engine.broadcast(new ee.h(e,!0));!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!0)?this.notesData.updateNoteProperties(e,{resolved:!0}):this.log.error("Resolving note failed")}else this.log.debug("Cannot resolve a non-existent note")}async reopenNote(e){const t=this.notesData.getNote(e);if(t){if(!t.resolved)return;this.viewData.updateOpenNoteView({resolved:!1});!!this.layersData.isInMemoryLayer(t.layerId)||await this.store.updateResolution(e,!1)?this.notesData.updateNoteProperties(e,{resolved:!1}):this.log.error("Reopen note failed")}else this.log.debug("Cannot reopen a non-existent note")}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new xe.V({dataTypes:[Be.g.NOTES],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}async updateNoteComment(e,t,i){const n=this.notesData.getNote(e);if(n){const s=this.layersData.isInMemoryLayer(n.layerId),a=n.getComment(t);if(a)if(a.user.id===this.userData.getCurrentUserId()){const r=!s&&await this.confirmAttachmentChanges(t,o.ud.COMMENT),d=i!==a.text;if(d){if(s)a.text=i;else{const e=await this.store.updateComment({id:t,text:i});e&&n.updateComment(e)}this.parseMarkdown(i)}(r||d)&&(await this.refreshNote(n.id),n.resolved&&(this.viewData.setNotesFilter(G.$.ALL),this.reopenNote(e))),this.viewData.setActiveNotation(null)}else this.log.debug("Cannot update another user's comment");else this.log.debug("Cannot update a non-existent comment")}else this.log.debug("Cannot update a comment in a non-existent note")}}const Le=Re},90560:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ge});var n=i(97542),s=i(92810),a=i(81396),o=i(5823),r=i(635),d=i(79728),h=i(64918),l=i(12039),c=i(62612),m=i(72936),u=i(60083),p=i(43470),g=i(16935),y=i(5666),v=i(59512),w=i(54244),b=i(89570),f=i(71166),T=i(56163),D=i(35221),C=i(75182);function P(e){const t=e.toLowerCase().replace(" & "," ").replace(" ","-");return C.g.includes(`object-${t}`)?`object-${t}`:"simple-tag-small"}class A extends T.K{constructor(e,t,i,n,s){var a,r,d;super(e,t,i),this.suggestion=n,this.mattertag=s,this.id=this.suggestion.id,this.title=this.suggestion.displayLabel,this.description=this.suggestion.displayCategory,this.icon=`icon-${P(this.suggestion.displayLabel)}`,this.color=this.suggestion.color,this.enabled=this.suggestion.visible,this.typeId=o.SF.OBJECTANNOTATION,this.floorId=this.suggestion.floorId,this.roomId=this.suggestion.roomId||"",this.dateBucket=(0,D.f)(this.suggestion.created),this.layerId=this.suggestion.layerId,this.onSelect=()=>{super.onSelect(),this.commandBinder.issueCommand(new y.w$(this.suggestion.id))},this.title=(null===(a=this.mattertag)||void 0===a?void 0:a.label)?this.mattertag.label:this.suggestion.displayLabel,this.description=(null===(r=this.mattertag)||void 0===r?void 0:r.description)?this.mattertag.description:this.suggestion.displayCategory,this.color=(null===(d=this.mattertag)||void 0===d?void 0:d.color)?`#${this.mattertag.color.getHexString()}`:this.suggestion.color}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var S=i(85893),k=i(67294),I=i(33558),E=i(38399),O=i(66102),N=i(86283),M=i(84426),x=i(36375);const{WORKSHOP:B,HIDE:V,SHOW:R}=E.Z;function L({item:e,onToggle:t}){const{commandBinder:i}=(0,k.useContext)(I.I),n=(0,O.b)(),{enabled:s,id:a,typeId:o}=e,r=!e.isLayerVisible(),d=!s||r?"eye-hide":"eye-show",h=(0,x.k)(),l=r?n.t(B.LAYERS.HIDDEN_LAYER_ITEM_TOOLTIP):s?n.t(V):n.t(R);return(0,S.jsx)(M.zx,{icon:d,dimmed:!s,variant:M.Wu.TERTIARY,onClick:e=>{e.stopPropagation(),r||(s&&h===a&&i.issueCommand(new f.IL(null,o)),t(!s))},tooltip:l})}const{OBJECT_TAG_SUGGESTION:F}=E.Z.WORKSHOP,H=({item:e})=>{const{id:t,typeId:i}=e,{analytics:n,commandBinder:s,editMode:a}=(0,k.useContext)(I.I),r=(0,O.b)();if(!a||i!==o.SF.OBJECTANNOTATION)return null;function d(e){n.track("showcase_gui",{tool:"object_tags",gui_action:e})}return(0,S.jsxs)(M.hE,{children:[(0,S.jsx)(L,{item:e,onToggle:e=>{s.issueCommand(new y.Q_(t,e)),d(e?"object_tags_show_click":"object_tags_hide_click")}}),(0,S.jsxs)(M.xz,Object.assign({icon:"more-vert",ariaLabel:r.t(E.Z.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu"},{children:[(0,S.jsx)(M.zx,{label:r.t(F.SEARCH_ITEM_EDIT),onClick:()=>{s.issueCommand(new f.IL(t,i)),s.issueCommand(new y.OD(t)),d("object_tags_edit_click")},variant:M.Wu.TERTIARY,size:M.qE.SMALL}),(0,S.jsx)(M.zx,{className:"menu-delete-btn",label:r.t(F.SEARCH_ITEM_DELETE),onClick:()=>{s.issueCommand(new y.SO(t)),s.issueCommand(new m.OL(t,c.Er.OBJECT)),s.issueCommand(new p.Aj(t,N.J.OBJECT)),d("object_tags_delete_click")},variant:M.Wu.TERTIARY,size:M.qE.SMALL})]}))]})};var j=i(27839);const{OBJECT_TAG_SUGGESTION:U}=E.Z.WORKSHOP,z=({group:e})=>{const{analytics:t,commandBinder:i,editMode:n}=(0,k.useContext)(I.I),s=(0,O.b)(),a=(0,j._)(),{matches:o}=e;if(!n)return null;if(0===o.length)return null;const r=o.filter((e=>e.enabled)).length,d=r===o.length,h=0===r;function l(e){t.track("showcase_gui",{tool:"object_tags",gui_action:e})}const c=!a||!a.canBatchDeleteInActiveView();return(0,S.jsx)(M.hE,{children:(0,S.jsxs)(M.xz,Object.assign({icon:"more-vert",ariaLabel:s.t(E.Z.MORE_OPTIONS),menuArrow:!0,menuClassName:"search-result-menu"},{children:[(0,S.jsx)(M.zx,{label:s.t(U.SEARCH_GROUP_HIDE_ALL),onClick:()=>{i.issueCommand(new y.cO(!1,...o.map((e=>e.id)))),l("hide_all_click")},variant:M.Wu.TERTIARY,size:M.qE.SMALL,disabled:h}),(0,S.jsx)(M.zx,{label:s.t(U.SEARCH_GROUP_SHOW_ALL),onClick:()=>{i.issueCommand(new y.cO(!0,...o.map((e=>e.id)))),l("show_all_click")},variant:M.Wu.TERTIARY,size:M.qE.SMALL,disabled:d}),c&&(0,S.jsx)(M.zx,{className:"menu-delete-btn",label:s.t(U.SEARCH_GROUP_DELETE_ALL),onClick:()=>{i.issueCommand(new y.SO(...o.map((e=>e.id)))),l("delete_all_click")},variant:M.Wu.TERTIARY,size:M.qE.SMALL})]}))})};var G=i(69665),_=i(2569),$=i(17788),K=i(95724),W=i(75287);const Z=.065;class q extends W.T{constructor(e){super(),this.created=new Date,this.modified=new Date,this.position=new a.Vector3,this.stemDirection=new a.Vector3,this.stemLength=Z,this.stemEnabled=!1,this.enabled=!0,this.icon="simple-tag",e&&(Object.assign(this,e),this.keywords=e.keywords||[],this.label&&(this.icon=P(this.label)))}get displayLabel(){return this.localizedName?this.localizedName:this.label}get displayCategory(){return this.localizedCategory?this.localizedCategory:""}get visible(){return this.enabled}set visible(e){this.enabled=e,this.commit()}getMattertagOptions(){return{color:new a.Color(this.color),description:this.displayCategory,enabled:!0,floorId:this.floorId,roomId:this.roomId,label:this.displayLabel,normal:this.stemDirection.clone(),objectAnnotationId:this.id,position:this.position.clone(),stemHeight:this.stemLength,stemVisible:!0,keywords:this.keywords.slice(),icon:this.icon}}getPin(e){return{id:this.id,floorId:this.floorId,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemEnabled:!1,stemLength:Z,color:e?`#${e.color.getHexString()}`:this.color,roomId:this.roomId,icon:this.icon}}toTagView(e){return{id:this.id,label:e?e.label:this.displayLabel,description:e?e.description:this.displayCategory,enabled:this.enabled,backgroundTexture:pe,attachments:(null==e?void 0:e.fileAttachments.values())||[],created:this.created,modified:this.modified,stemEnabled:this.stemEnabled,color:this.color,anchorPosition:this.position.clone(),stemNormal:this.stemDirection.clone(),stemLength:this.stemLength,floorId:this.floorId,roomId:this.roomId,layerId:this.layerId,keywords:e?null==e?void 0:e.keywords.slice():this.keywords.slice(),icon:this.icon}}}var J=i(9133),Y=i(97998);const Q=Object.freeze({pink:"#f78da7",plum:"#9c4b92",purple:"#673ab7",teal:"#03687d",cerulean:"#03a9f4",ocean:"#00bcd4",fog:"#abb8c3",iron:"#607d8b",forest:"#417505",emerald:"#51a868",mint:"#37d67a",lime:"#cddc39",canary:"#fbcd00",sunflower:"#ffac17",tangerine:"#ff6900",sunset:"#f44336",sierra:"#d44441",magenta:"#e91e63"});var X;!function(e){e.APPLIANCE="Appliance",e.CONSUMER_ELECTRONICS="Consumer Electronics",e.FIXTURE="Fixture",e.FURNITURE="Furniture",e.LIGHTING="Lighting"}(X||(X={}));const ee="WORKSHOP.OBJECT_TAG_SUGGESTION.VISION.";class te{constructor(e){this.locale=e,this.locale=e,this.log=new Y.Z("Object-tag-deserializer"),this.keywordList=Object.values(X)}deserialize(e){var t,i,n,s;if(!e||!this.validate(e))return null;const a=e.region,o=(null==a?void 0:a.anchorPosition)?_.ep.fromVisionVector(a.anchorPosition):void 0,r=(null==a?void 0:a.stemNormal)?_.ep.fromVisionVector(a.stemNormal):void 0,d=new q({id:e.id,confidence:null!==(t=e.confidence)&&void 0!==t?t:0,created:(0,J.p)(e.created),modified:(0,J.p)(e.created),enabled:e.enabled});(null===(i=e.region)||void 0===i?void 0:i.stemLength)&&(d.stemLength=e.region.stemLength),e.floor&&e.floor.id&&(d.floorId=e.floor.id),e.room&&e.room.id&&(d.roomId=e.room.id),e.layer&&e.layer.id&&(d.layerId=e.layer.id),o&&(d.position=o),r&&(d.stemDirection=r),d.mattertagId=null===(n=e.tag)||void 0===n?void 0:n.id;let h=e.keywords||[],l=e.label||"";if(e.classification){const t=e.classification,i=ee+this.formatStringToPhraseKey(t.label);this.locale.has(i)&&(d.localizedName=this.locale.t(i));const{defaultKeywords:n}=t;if(n&&n.length>0){const e=n[n.length-1],t=ee+this.formatStringToPhraseKey(e);this.locale.has(t)&&(d.localizedCategory=this.locale.t(t))}t.label&&(l=t.label,d.icon=P(l)),t.defaultKeywords&&(h=t.defaultKeywords);const s=[];for(const e of h){const t=ee+this.formatStringToPhraseKey(e);this.locale.has(t)?s.push(this.locale.t(t)):s.push(e)}h=s}return d.keywords=h,d.label=l,this.postProcess(d,null===(s=e.classification)||void 0===s?void 0:s.defaultKeywords),d}formatStringToPhraseKey(e){return e.trim().replace(/\s/,"_").toUpperCase()}validate(e){if(!e)return!1;const t=["id","label","created","modified","region"];for(const i of t){if(!(i in e))return this.log.error("Missing field: ",i),!1}return!0}postProcess(e,t){let[i,n]=e.label.split(".").slice(1);if(i&&!e.localizedCategory){const t=ee+i.toUpperCase();this.locale.has(t)?e.localizedCategory=this.locale.t(t):e.localizedCategory=i}if(n&&!e.localizedName){const t=ee+n.toUpperCase();this.locale.has(t)?e.localizedName=this.locale.t(t):e.localizedName=n}if(t&&t.length>0)for(const e of this.keywordList)if(t.includes(e)){i=e;break}e.color=this.getCategoryColor(i)}getCategoryColor(e){switch(e){case"appliances":return Q.cerulean;case"consumer_electronics":return Q.emerald;case"fixtures":return Q.sunset;case X.APPLIANCE:return Q.cerulean;case X.CONSUMER_ELECTRONICS:return Q.emerald;case X.FIXTURE:return Q.sunset;case X.FURNITURE:return Q.canary;case X.LIGHTING:return Q.fog;default:return Q.forest}}}class ie extends $.u{constructor(e,t,i){super(e),this.classifications=[],this.layeredType=o.SF.OBJECTANNOTATION,this.confidence=i||.9,this.objectDeserializer=new te(t),this.deserializer=new K.o({deserializer:this.objectDeserializer})}async read(e){const t={modelId:this.getViewId(),minConfidence:this.confidence,includeDisabled:!0,inferenceEvents:null,ids:null,includeLayers:this.readLayerId()};return this.query(G.GetObjectAnnotations,t,e).then((e=>{var t,i;const n=null===(i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.objectAnnotations;if(!n||!Array.isArray(n))return null;return(this.deserializer.deserialize(n)||[]).reduce(((e,t)=>(e[t.id]=t,e)),{})}))}async toggleEnabled(e,t){const i={modelId:this.getViewId(),objectAnnotationId:e,data:{enabled:t},includeLayers:this.readLayerId()};return this.mutate(G.PatchObjectAnnotation,i).then((e=>{var t;const i=null===(t=e.data)||void 0===t?void 0:t.patchObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not update Object Annotation")}))}async toggleAllEnabled(e,...t){const i={modelId:this.getViewId(),objectAnnotationIds:t,setEnabled:e,includeLayers:this.readLayerId()};return this.mutate(G.SetBulkObjectAnnotationsEnabled,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.setBulkObjectAnnotationsEnabled;if(!i)throw new Error("Could not update Object Annotations");return i.map((e=>e.id))}))}async deleteObjectAnnotation(e){const t={modelId:this.getViewId(),objectAnnotationId:e};return this.mutate(G.DeleteObjectAnnotation,t).then((e=>{var t;return!!(null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.deleteObjectAnnotation)}))}async createObjectTag(e){const t={label:e.label,keywords:e.keywords||[],floorId:e.floorId,layerId:this.writeLayerId(e.layerId)?e.layerId:void 0,enabled:!0,vectorRegion:{anchorPosition:_.ep.toVisionVector(e.position),stemNormal:_.ep.toVisionVector(e.stemDirection),stemLength:e.stemLength}},i={modelId:this.getViewId(),objectAnnotation:t,includeLayers:this.readLayerId()};return this.mutate(G.AddObjectAnnotation,i).then((e=>{var t;const i=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.addObjectAnnotation;if(i){const e=this.objectDeserializer.deserialize(i);if(e)return e}throw new Error("Could not create Object Annotation")}))}}var ne=i(87926);const se=i.p+"images/objectColor.png";var ae=i(29883),oe=i(85679),re=i(43037),de=i(39880),he=i(19648),le=i(89549),ce=i(76631),me=i(66917),ue=i(80742);const pe=(0,ne.p)(se);class ge extends n.Y{constructor(){super(...arguments),this.name="object-tag-suggestions-data",this.visibilityEnabled=!1,this.idVisibility=new Set,this.createdTag=null,this.onPinSelectionChange=e=>{const{commandBinder:t}=this.engine,{billboardAnnotation:i}=this.annotationsViewData,n=e?this.data.getObjectTag(e):null;n?(t.issueCommand(new f.IL(n.id,o.SF.OBJECTANNOTATION)),t.issueCommand(new p.Kw(n.id,N.J.OBJECT))):i&&i.annotationType===N.J.OBJECT&&t.issueCommand(new p.Aj(i.id,N.J.OBJECT))},this.onPinFocusChange=async()=>{const{commandBinder:e}=this.engine,{focusedPin:t,selectedPinId:i}=this.pinsViewData,{billboardAnnotation:n,dockedAnnotation:s}=this.annotationsViewData;if(!t)return void(n&&n.annotationType===N.J.OBJECT&&n.id!==i&&await e.issueCommand(new p.Aj(n.id,N.J.OBJECT)));const a=i?this.pinsViewData.getPin(i):null;a&&a.pinType===c.Er.OBJECT&&(e.issueCommand(new m.RH(a.id,c.Er.OBJECT)),e.issueCommand(new f.IL(null))),t.pinType===c.Er.OBJECT&&t.id!==(null==s?void 0:s.id)&&e.issueCommand(new p.Kw(t.id,N.J.OBJECT))},this.onLayersChanged=()=>{this.unselectObjectPin(),this.unselectObjectSearchResult(),this.displayObjects()},this.toggleObjectAnnotations=async e=>{const{enabled:t}=e;this.visibilityEnabled=t,this.engine.commandBinder.issueCommand(new m.qN(c.Er.OBJECT,t)),t||(this.unselectObjectPin(),this.unselectObjectSearchResult()),this.displayObjects()},this.selectedItemChanged=()=>{const{activeItemId:e,selectedType:t}=this.searchData;if(e&&t===o.SF.OBJECTANNOTATION){const t=this.data.getObjectTag(e);t&&this.updatePin(t)}},this.setAllObjectTagsEnabled=async e=>{const{ids:t,enabled:i}=e;0!==t.length&&(await this.store.toggleAllEnabled(i,...t),this.data.atomic((()=>{for(const e of this.data.collection)t.includes(e.id)&&(e.enabled=i,e.commit())})),this.unselectObjectPin(),this.unselectObjectSearchResult())},this.toggleObjectTagEnabled=async e=>{const{id:t,enabled:i}=e,n=this.data.getObjectTag(t);if(!n)throw new Error("Object tag not found!");if(n.enabled===i)return;await this.store.toggleEnabled(t,i)&&(n.enabled=i,n.commit(),this.unselectObjectPin(t),this.unselectObjectSearchResult(t))},this.deleteTags=async e=>{const{ids:t}=e;if(0===t.length)return;const i=this.annotationsViewData.billboardAnnotation;(null==i?void 0:i.annotationType)===N.J.OBJECT&&this.engine.commandBinder.issueCommand(new p.Aj(i.id,i.annotationType));for(const e of t){if(!await this.store.deleteObjectAnnotation(e))throw new Error("Could not delete Object Annotation");{this.data.removeObjectTag(e);const t=this.data.getObjectTag(e);t&&t.mattertagId&&await this.engine.commandBinder.issueCommand(new re.T3(t.mattertagId,"search_menu_object_tag"))}}},this.createObjectTag=async e=>{const{id:t,options:i,pendingAttachments:n,embed:s}=e,r=new q,d=null==i?void 0:i.color,h=d?`#${new a.Color(d.r,d.g,d.b).getHexString()}`:"#ffffff";if(r.label=i.label||"",r.floorId=i.floorId||"",r.keywords=i.keywords||[],r.stemDirection=i.normal||new a.Vector3,r.stemLength=i.stemHeight?Math.max(i.stemHeight,Z):Z,r.position=i.position||new a.Vector3,r.color=h,r.layerId=this.layersData.activeLayerId,await this.modifyInsideSaveCommand((async()=>{this.createdTag=await this.store.createObjectTag(r)}))(),!this.createdTag)return;const l=this.createdTag.id,{commandBinder:u}=this.engine;i.objectAnnotationId=l,await u.issueCommand(new re.QG(t,i,n,void 0,s)),this.createdTag.mattertagId=t,this.data.updateObjectTag(this.createdTag);const p=this.getPinUpdate(this.createdTag);this.createdTag=null,u.issueCommand(new m.tE(l,c.Er.OBJECT,p)),await u.issueCommand(new le.CH(ce.w1.TAGS)),u.issueCommand(new me.M),await u.issueCommand(new le.z2(ce.w1.LAYERS)),u.issueCommand(new me.I),u.issueCommand(new f.IL(l,o.SF.OBJECTANNOTATION)),await u.issueCommand(new y.w$(l))},this.dockObjectTag=async e=>{const{id:t}=e,i=this.data.getObjectTag(t);if(!i)return;const{commandBinder:n}=this.engine;if(!i.mattertagId){const e=i.getMattertagOptions(),t=(0,de.O1)(11);n.issueCommand(new he.Mm(t,e)),i.mattertagId=t}n.issueCommand(new re.lt(i.mattertagId,{dock:!0,objectTag:!0}))}}async init(e,t){super.init(e,t),this.engine=t,[this.locale,this.pinsViewData,this.annotationsViewData,this.mattertagsData,this.layersData,this.searchData,this.appData]=await Promise.all([t.getModuleBySymbol(s.e9),t.market.waitForData(u.B),t.market.waitForData(g.A),t.market.waitForData(oe.n),t.market.waitForData(ue.R),t.market.waitForData(ae.T),t.market.waitForData(w.pu)]),this.store=new ie({context:this.layersData.mdsContext,readonly:!1,baseUrl:e.baseUrl},this.locale,e.minConfidence),this.engine.commandBinder.issueCommand(new m.qN(c.Er.OBJECT,!1)),this.data=new v.h,this.store.onNewData(this.loadNewData.bind(this));const{commandBinder:i}=this.engine;this.bindings.push(i.addBinding(y.AN,this.toggleObjectAnnotations),i.addBinding(y.yJ,(async e=>this.filterObjectTagSuggestions(e.ids))),i.addBinding(y.w$,(async({id:e})=>this.navigateToSuggestion(e))),i.addBinding(y.cO,this.modifyInsideSaveCommand(this.setAllObjectTagsEnabled)),i.addBinding(y.Q_,this.modifyInsideSaveCommand(this.toggleObjectTagEnabled)),i.addBinding(y.SO,this.modifyInsideSaveCommand(this.deleteTags)),i.addBinding(y.I2,this.createObjectTag),i.addBinding(y.OD,(async e=>this.dockObjectTag(e))),this.appData.onChanged((()=>this.displayObjects())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.searchData.onPropertyChanged("activeItemId",this.selectedItemChanged),this.pinsViewData.onSelectedPinChanged(this.onPinSelectionChange),this.pinsViewData.onFocusedPinChanged((()=>this.onPinFocusChange())),this.data.onChanged((()=>this.displayObjects())),this.data.collection.onElementChanged({onAdded:this.updatePin.bind(this),onUpdated:this.updatePin.bind(this),onRemoved:this.removePin.bind(this)})),await this.store.refresh(),this.engine.market.register(this,v.h,this.data),async function(e,t,i,n){const s=await e.market.waitForData(w.pu);let a=s.application===w.Mx.WORKSHOP;const r=(s,o,r,h=[])=>{const l=[];return t.iterate((t=>{if(!(a||t.visible&&n.layerToggled(t.layerId)))return;const r=[t.displayLabel,t.displayCategory],d=[...t.keywords],c=t.mattertagId?i.getTag(t.mattertagId):void 0;c&&(r.length=0,d.length=0,r.push(c.label,c.description),d.push(...c.keywords));const m=r.filter((e=>!!e));let u=s(...m);u&&h.length>0&&(u=d.length>0&&d.some((e=>h.includes(e)))),u&&l.push(new A(e.commandBinder,n,o,t,c))})),e.commandBinder.issueCommand(new y.yJ(l.map((e=>e.id)))),d(l),l},d=e=>{e.sort(((e,t)=>{var i;const n=e,s=t,a=null===(i=n.description)||void 0===i?void 0:i.localeCompare(s.description);return 0!==a?a:n.title.localeCompare(s.title)}))},h=t=>{e.commandBinder.issueCommand(new y.AN(!!t))},l=()=>{let e=[];return t.iterate((t=>{t.visible&&t.keywords.length&&!t.mattertagId&&(e=e.concat(t.keywords))})),e},c=e=>new b.V(t.onChanged(e),i.onChanged(e)),m=()=>{e.commandBinder.issueCommandWhenBound(new f.c6({id:o.SF.OBJECTANNOTATION,groupPhraseKey:"WORKSHOP.OBJECT_TAG_SUGGESTION.SEARCH_GROUP_HEADER",getSimpleMatches:r,registerChangeObserver:c,onSearchActivatedChanged:h,getKeywords:l,groupOrder:90,groupIcon:"snap",groupActionsFC:z,itemActionsFC:H,batchSupported:!0}))},u=()=>{e.commandBinder.issueCommandWhenBound(new f.Pe(o.SF.OBJECTANNOTATION))},p={renew:m,cancel:u},g=e=>{a=e===w.Mx.WORKSHOP,u(),m()},v=s.onPropertyChanged("application",g);return g(s.application),new b.V(p,v)}(t,this.data,this.mattertagsData,this.layersData).then((e=>this.bindings.push(e)))}loadNewData(e){this.data.atomic((()=>{this.layersData.replaceBackendLayers(this.data.collection,e||{})}))}dispose(e){super.dispose(e),this.data&&e.market.unregister(this,v.h)}modifyInsideSaveCommand(e){return async(...t)=>{await this.engine.commandBinder.issueCommand(new r.V({dataTypes:[d.g.OBJECT_ANNOTATIONS],onCallback:()=>e(...t),skipDirtyUpdate:!0}))}}displayObjects(){const e=[];this.data.collection.values.forEach((t=>{e.push(this.getPinUpdate(t))})),this.engine.commandBinder.issueCommand(new m.mE(e))}removePin(e){this.engine.commandBinder.issueCommand(new m.OL(e.id,c.Er.OBJECT))}updatePin(e){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new m.mE([t]))}getPinUpdate(e){const t=this.mattertagsData.getTag(e.mattertagId||""),i=e.getPin(t);return Object.assign({id:e.id,pinType:c.Er.OBJECT,backgroundTexture:pe,visible:this.getObjectVisibility(e.id,e.layerId,e.visible),scale:new a.Vector3(.75,.75,.75)},i)}getObjectVisibility(e,t,i){if(!this.visibilityEnabled)return!1;const{activeItemId:n,selectedType:s}=this.searchData,a=this.appData.application===w.Mx.WORKSHOP||this.layersData.layerToggled(t),r=this.layersData.layerVisible(t),d=this.idVisibility.has(e),h=n===e&&s===o.SF.OBJECTANNOTATION;return a&&(h||i&&d&&r)}async filterObjectTagSuggestions(e){this.idVisibility.clear(),e.forEach((e=>this.idVisibility.add(e))),this.displayObjects()}async navigateToSuggestion(e){const t=this.data.getObjectTag(e);if(!t)return;const i={anchorPosition:t.position.clone(),stemNormal:t.stemDirection.clone(),stemLength:t.stemLength,stemEnabled:!0,color:"",floorId:t.floorId,roomId:t.roomId};await this.engine.commandBinder.issueCommand(new l.OR({pinPosition:i,transition:h.n.FadeToBlack})),this.engine.commandBinder.issueCommand(new m.Ar(e,c.Er.OBJECT,!1))}unselectObjectPin(e){const{selectedPinId:t}=this.pinsViewData;if(t){const i=this.pinsViewData.getPin(t);i&&(i.pinType!==c.Er.OBJECT||e&&e!==t||this.engine.commandBinder.issueCommand(new m.RH(t,c.Er.OBJECT)))}}unselectObjectSearchResult(e){const{selectedType:t,activeItemId:i}=this.searchData;i&&t===o.SF.OBJECTANNOTATION&&(e&&e!==i||this.engine.commandBinder.issueCommand(new f.IL(null)))}}},66338:(e,t,i)=>{"use strict";i.d(t,{W:()=>a});var n=i(67992),s=i(15637);class a extends n.V{constructor(e){super(),this.name="ordered-list-data",this.lists=(0,s.q)(e)}replace(e){this.lists.replace(e)}getOrderedLists(){return this.lists.values}getOrderedList(e){return this.lists.get(e)}updateOrderedList(e){this.lists.has(e.name)?this.lists.get(e.name).copy(e):this.lists.set(e.name,e)}}},43846:(e,t,i)=>{"use strict";i.d(t,{Bd:()=>a,ui:()=>o,wg:()=>s});var n=i(19663);class s extends n.m{constructor(e,t){super(),this.id="ORDERED_LIST_NAMED_SAVE",this.payload={name:e,entries:t}}}class a extends n.m{constructor(e,t){super(),this.id="ORDERED_LIST_CREATE",this.payload={name:e,entries:t}}}class o extends n.m{constructor(e,t,i){super(),this.id="ORDERED_LIST_UPDATE",this.payload={id:e,name:t,entries:i}}}},24102:(e,t,i)=>{"use strict";var n;i.d(t,{l:()=>n}),function(e){e.TAG="tag"}(n||(n={}))},51366:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CreateOrderedListCommand:()=>f.Bd,MdsOrderedListDeserializer:()=>y,MdsOrderedListStore:()=>w,OrderedList:()=>d,OrderedListData:()=>b.W,OrderedListEntryType:()=>C.l,SaveNamedOrderedListCommand:()=>f.wg,TAG_ORDERED_LIST_NAME:()=>P.q,UpdateOrderedListCommand:()=>f.ui,default:()=>A});var n=i(97542),s=i(92810),a=i(79728),o=i(635),r=i(75287);class d extends r.T{constructor(e){super(),this.id="",this.name="",this.description="",this.entries=[],this.layerId="",e&&Object.assign(this,e)}copy(e){return this.id=e.id,this.name=e.name,e.description&&(this.description=e.description),this.entries=e.entries.slice(),this.commit(),this}}var h=i(17788),l=i(95548),c=i(97704),m=i(73123),u=i(97998),p=i(22001);const g=new u.Z("ordered-list-deserializer");class y{deserialize(e){var t,i,n;return e&&this.validate(e)?new d({id:e.id,name:null!==(t=e.label)&&void 0!==t?t:"",layerId:null!==(n=null===(i=e.layer)||void 0===i?void 0:i.id)&&void 0!==n?n:"",entries:e.entries.filter((e=>!!e)).map((e=>({id:e.id,type:e.type})))}):(g.debug("Deserialized invalid ordered list data from Mds",e),null)}validate(e){return["id","label","entries"].every((t=>t in e))}}const v=new u.Z("MdsOrderedListStore");class w extends h.u{constructor(e){super(e),this.prefetchKey="data.model.orderedLists",this.deserializer=new y}async read(){const e={modelId:this.getViewId(),includeLayers:this.readLayerId()};return this.query(p.GetOrderedLists,e).then((e=>{var t,i;const n=null===(i=null===(t=e.data)||void 0===t?void 0:t.model)||void 0===i?void 0:i.orderedLists;if(!n||!Array.isArray(n))return v.debug("GetOrderedLists failed"),{};return n.reduce(((e,t)=>{const i=this.deserializer.deserialize(t);return i&&(e[i.name]&&v.debug(`Duplicate orderedList found with label: ${i.name}`),e[i.name]=i),e}),{})}))}async create(e,t){return 0===e.length?[]:Promise.all(e.map((e=>this.createOrderedList(e,t))))}async createOrderedList(e,t){var i;const n={modelId:this.getViewId(),label:e.name,description:e.description,entries:e.entries,includeLayers:this.readLayerId()};let s;if(t&&this.writeLayerId(t)){const e=Object.assign({layerId:t},n);s=await this.mutate(p.AddOrderedListWithLayer,e).catch((e=>{throw new l.w0(e)}))}else s=await this.mutate(p.AddOrderedList,n).catch((e=>{throw new l.w0(e)}));if(null===(i=s.data)||void 0===i?void 0:i.addOrderedList){const e=this.deserializer.deserialize(s.data.addOrderedList);if(e)return e.layerId&&await this.context.updateForAutoProvisionedLayer(e.layerId),e}throw new Error("Unable to create new OrderedList")}async update(e){if(0===e.length)return;const t=this.getViewId();let i="";const n={};n.modelId=t;let s="";for(const t of e){const e=t.id;i+=`\n        , $label${e}: String!\n        , $description${e}: String!\n        , $entries${e}: [EntryInput!]\n      `,n[`label${e}`]=t.name,n[`description${e}`]=t.description,n[`entries${e}`]=t.entries,s+=`\n        update${e}:\n        patchOrderedList(modelId: $modelId,\n                         orderedListId: "${e}",\n                         label: $label${e},\n                         description: $description${e},\n                         entries: $entries${e}) {\n          id\n          label\n          entries {\n            id\n            type\n          }\n        }\n      `}const a=c.gql`
      mutation orderedListsUpdate($modelId: ID! ${i}) {
        ${s}
      }
    `;return this.mutate(a,n).then((e=>{v.debug(Object.assign({type:"patchOrderedList"},Object.values((0,m.q)(e,"data"))))}))}}var b=i(66338),f=i(43846),T=i(80742);class D extends n.Y{constructor(){super(...arguments),this.name="ordered-lists",this.saveNamedOrderedList=async e=>{const{name:t,entries:i}=e;let n=this.data.getOrderedList(t);return n?n.entries=i:n=new d({name:t,entries:i}),this.data.updateOrderedList(n),this.engine.commandBinder.issueCommand(new o.V({dataTypes:[a.g.ORDERED_LISTS]}))}}async init(e,t){const{baseUrl:i,workshop:n}=e;if(this.engine=t,this.layersData=await t.market.waitForData(T.R),this.store=new w({context:this.layersData.mdsContext,baseUrl:i,readonly:!n}),this.bindings.push(this.store.onNewData((async e=>{this.data.replace(e)}))),this.data=new b.W({}),await this.store.refresh(),n){const e=await t.getModuleBySymbol(s.Lx);this.bindings.push(t.commandBinder.addBinding(f.wg,this.saveNamedOrderedList),e.onSave((()=>this.save()),{dataType:a.g.ORDERED_LISTS}))}t.market.register(this,b.W,this.data)}dispose(e){this.store.dispose(),super.dispose(e)}onUpdate(){}async save(){const e=this.data.getOrderedLists(),t=[],i=[];e.forEach((e=>{""===e.id?t.push(e):i.push(e)}));return Promise.all([this.store.create(t,this.layersData.getOrderedListsLayerId()),this.store.update(i)]).then((e=>{e[0].forEach((e=>{e&&this.data.updateOrderedList(e)}))}))}}var C=i(24102),P=i(25561);const A=D},25561:(e,t,i)=>{"use strict";i.d(t,{q:()=>n});const n="mp.tags"},93642:(e,t,i)=>{"use strict";i.d(t,{O8:()=>r,SI:()=>s,WI:()=>d,uQ:()=>a,zf:()=>o});var n=i(69505);const s=1e3/60,a=(0,n.Id)(70),o=-a,r=.05,d=.1/60},49219:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>C,lookAccelerationKey:()=>D});var n=i(81396),s=i(90304),a=i(93642),o=i(21646),r=i(49827),d=i(41835),h=i(46950);class l extends d.Z{constructor(e){super(),this.cameraPoseProxy=e,this.lookVelocity=new n.Vector2,this.lookAccel=new n.Vector2,this.tempAxis=new n.Vector3,this.tempOrientation=new n.Quaternion,this.currentOrientation=new n.Quaternion,this.tempEuler=new n.Euler,this.transition={active:!1,startTime:0,elapsed:0,duration:0,velocity:new n.Vector2,easeOut:!1}}setLookAcceleration(e,t=!1){this.transition.active||(t&&(e.x&&this.lookVelocity.x&&Math.sign(e.x)!==Math.sign(this.lookVelocity.x)&&(this.lookVelocity.x=0),e.y&&this.lookVelocity.y&&Math.sign(e.y)!==Math.sign(this.lookVelocity.y)&&(this.lookVelocity.y=0)),this.lookAccel.x=void 0!==e.x?e.x:this.lookAccel.x,this.lookAccel.y=void 0!==e.y?e.y:this.lookAccel.y)}startTransition(e,t,i){var n;const s=new h.Q;return this.transition.active=!0,this.transition.duration=e,this.transition.elapsed=0,this.transition.startTime=Date.now(),this.transition.deferred=s,this.transition.velocity.copy(t),this.transition.easeOut=i,this.lookAccel.set(0,0),this.lookVelocity.copy(t),null===(n=this.poseController)||void 0===n||n.beginExternalTransition(),s.promise()}stopTransition(){var e;this.transition.active&&(null===(e=this.poseController)||void 0===e||e.endExternalTransition(),this.transition.active=!1),this.transition.deferred&&(this.transition.deferred.resolve(),this.transition.deferred=void 0)}updateTransition(e){const t=e/a.SI;if(this.lookVelocity.copy(this.transition.velocity),this.transition.elapsed+=e,this.transition.elapsed>=this.transition.duration){const t=this.transition.duration-(this.transition.elapsed-e);this.lookVelocity.multiplyScalar(t/e)}else this.lookVelocity.multiplyScalar(t)}updateCameraParameters(){var e;const t=this.cameraPoseProxy.pose;this.tempEuler.setFromQuaternion(t.rotation,"YXZ");const i=this.tempEuler.x,n=(0,r.uZ)(this.lookVelocity.y,a.zf-i,a.uQ-i);this.tempAxis.copy(s.fU.RIGHT),this.tempOrientation.setFromAxisAngle(this.tempAxis.applyQuaternion(t.rotation),n),this.currentOrientation.copy(t.rotation).premultiply(this.tempOrientation),this.tempOrientation.setFromAxisAngle(s.fU.UP,this.lookVelocity.x),this.currentOrientation.premultiply(this.tempOrientation),t.rotation.equals(this.currentOrientation)||(this.tempOrientation.copy(this.currentOrientation).normalize(),null===(e=this.poseController)||void 0===e||e.updateCameraRotation(this.tempOrientation))}update(e){const t=this.cameraPoseProxy.pose,i=e/a.SI;t.rotation.equals(this.currentOrientation)||this.currentOrientation.copy(t.rotation),this.transition.active?(this.updateTransition(e),this.updateCameraParameters(),this.transition.elapsed>=this.transition.duration&&(this.stop(this.transition.easeOut),this.transition.active=!1)):(this.lookAccel.length()>o.Z.epsilon||this.lookVelocity.length()>o.Z.epsilon)&&(this.lookVelocity.addScaledVector(this.lookAccel,i),this.updateCameraParameters(),this.lookVelocity.multiplyScalar(Math.pow(1-a.O8,i)))}stop(e=!1){this.stopTransition(),this.lookAccel.set(0,0),e||this.lookVelocity.set(0,0)}startRotateTransition(e,t,i){return this.beforeStartRotationTransition&&this.beforeStartRotationTransition(),this.startTransition(e,t.clone().multiplyScalar(a.SI),i).nativePromise()}startTranslateTransition(e,t,i=!0){throw new Error("Panning isn't supported in Panorama Controls")}startZoomTransition(e,t,i){throw new Error("Zooming isn't supported in Panorama Controls")}}var c=i(5135),m=i(95882),u=i(16782),p=i(32597),g=i(6667),y=i(80592),v=i(89553),w=i(34029),b=i(92810),f=i(9037),T=i(66211);const D="Rotation speed";class C extends T.Z{constructor(){super(...arguments),this.name="panorama-controls",this.controlsEngaged=!1,this.lookAccelerationSpeed=a.WI,this.calcRotationAngle=(()=>{const e=new n.Matrix4,t=new n.Vector3,i=new n.Vector3;return(s,a)=>{e.copy(this.cameraData.pose.projection.asThreeMatrix4()),e.invert(),t.set(s.x-a.x,s.y-a.y,-1).applyMatrix4(e),i.set(s.x,s.y,-1).applyMatrix4(e);const o=Math.sqrt(t.x*t.x+t.z*t.z),r=Math.sqrt(i.x*i.x+i.z*i.z),d=Math.atan2(t.y,o),h=Math.atan2(i.y,r)-d;t.y=0,i.y=0,t.normalize(),i.normalize();const l=Math.acos(t.dot(i));let c=0;return isNaN(l)||(c=l,a.x>0&&(c*=-1)),new n.Vector2(-c,-h)}})()}async init(e,t){const i=await t.getModuleBySymbol(b.Ng);this.controls=new l(i.cameraPoseProxy),this.cameraData=await t.market.waitForData(f.M);const n=this.cameraData;this.controls.beforeStartRotationTransition=()=>{n.transition&&n.transition.activeInternal&&n.transition.to.rotation&&(n.transition.to.rotation=void 0)},i.addControls(m.Ey.Panorama,this.controls),i.addControls(m.Ey.Mesh,this.controls),this.market=t.market,this.registerActiveStateChangeBinding(),t.getModuleBySymbol(b.PZ).then((e=>{e.registerHandler(y.E0,(e=>{this.shouldBeActive()&&this.controls.stop()})),e.registerHandler(y._t,(e=>{this.shouldBeActive()&&e.buttons&u.r.PRIMARY&&(this.controlsEngaged=!0,this.onDrag(e.position,e.delta),this.controls.update(a.SI),this.controls.stop())})),e.registerHandler(y._R,(e=>{this.shouldBeActive()&&this.controlsEngaged&&(e.timeSinceLastMove<100&&!(e.buttons&u.r.PRIMARY)&&(this.onDrag(e.position,e.delta),this.controls.update(a.SI),this.controls.setLookAcceleration({x:0,y:0})),this.controlsEngaged=!1)})),e.registerHandler(v.e,(e=>{this.shouldBeActive()&&this.onKey(e.key,e.state)})),this.updateInputBindings()}))}onUpdate(e){this.shouldBeActive()&&this.controls.update(e)}onDrag(e,t){this.controls.setLookAcceleration(this.calcRotationAngle(e,t))}onKey(e,t){var i,n;const s=null!==(n=null===(i=this.market.tryGetData(w.e))||void 0===i?void 0:i.tryGetProperty(D,null))&&void 0!==n?n:null;this.lookAccelerationSpeed=s?s*(Math.PI/180)/60:this.lookAccelerationSpeed;const a=t===g.M.DOWN;switch(e){case p.R.LEFTARROW:case p.R.J:this.controls.setLookAcceleration({x:a?this.lookAccelerationSpeed:0},!0);break;case p.R.RIGHTARROW:case p.R.L:this.controls.setLookAcceleration({x:a?-this.lookAccelerationSpeed:0},!0);break;case p.R.K:this.controls.setLookAcceleration({y:a?-this.lookAccelerationSpeed:0},!0);break;case p.R.I:this.controls.setLookAcceleration({y:a?this.lookAccelerationSpeed:0},!0)}}shouldBeActive(){var e,t;return null!==(t=!(null===(e=this.market.tryGetData(c.Z))||void 0===e?void 0:e.isVR()))&&void 0!==t&&t}}},70042:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelNewPinCommand:()=>K.tT,ChangePinOpacityByTypeCommand:()=>K.kb,ChangePinOpacityCommand:()=>K._Y,ChangePinOpacityScaleCommand:()=>K.nP,ChangePinVisibilityByTypeCommand:()=>K.qN,ChangePinVisibilityCommand:()=>K.ik,ClearPinSelectionCommand:()=>K.iK,ClickOffPinCommand:()=>K.yR,CreatePinCommand:()=>K.fM,EnablePinCreationCommand:()=>K.Ki,MovePinCommand:()=>K.I$,NewPinReadyMessage:()=>W.cd,PinAddCancelledMessage:()=>W.hu,PinAnchorMesh:()=>$,PinClickedMessage:()=>W.F7,PinColorVariant:()=>H.K_,PinEditor:()=>Q,PinEditorState:()=>H.V8,PinHeadMesh:()=>j.$,PinHoverChangeMessage:()=>W.tP,PinMovedMessage:()=>W.bV,PinPlacedMessage:()=>W.b0,PinPlacementCancelledMessage:()=>W.pe,PinPreviewDirection:()=>H.Od,PinRenderer:()=>he,PinType:()=>H.Er,PinsViewData:()=>D.B,PlacePinCommand:()=>K.ip,RemovePinCommand:()=>K.OL,RemovePinsByTypeCommand:()=>K.zM,SelectPinCommand:()=>K.Ar,TogglePinEditingCommand:()=>K.ic,UnselectPinCommand:()=>K.RH,UpdatePinCommand:()=>K.tE,UpdatePinViewsCommand:()=>K.mE,default:()=>Se});var n=i(81396),s=i(97542),a=i(92810),o=i(59370),r=i(31362),d=i(54244),h=i(5332),l=i(79727),c=i(5135),m=i(9037),u=i(53954),p=i(23254),g=i(95882),y=i(95512),v=i(38987),w=i(34956),b=i(14630),f=i(10699),T=i(79596),D=i(60083),C=i(89570),P=i(53058),A=i(82814);var S=i(94046),k=i(97998),I=i(72996),E=i(16769),O=i(16782),N=i(67678),M=i(86819),x=i(80592),B=i(62017),V=i(89553),R=i(51788),L=i(6667),F=i(32597),H=i(62612),j=i(33160),U=i(12529),z=i(87926);const G=i.p+"images/pinAnchor.png";var _=i(84958);class $ extends n.Mesh{constructor(e){super(new n.PlaneGeometry(_.Z.anchor.size,_.Z.anchor.size),new n.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:$.getTexture(),side:n.DoubleSide})),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pins}static getTexture(){return $.anchorTexture||($.anchorTexture=(0,z.p)(G)),$.anchorTexture}}var K=i(72936),W=i(13132),Z=i(76957),q=i(35826),J=i(12039),Y=i(51411);class Q{constructor(e,t,i,s){this.viewData=e,this.engine=t,this.input=i,this.pinRenderer=s,this.editEnabled=!1,this.handlersRegistered=!1,this.bindings=[],this.externalBehaviorsBlocked=!1,this.touchDevice=(0,r.Jm)(),this.longPressCreateThreshold=500,this.ndcPoint=new n.Vector3,this.movingPin=!1,this.anchored=!1,this.inAnchorClick=!1,this.startingPinData=void 0,this.log=new k.Z("pin-editor"),this.stopEventPropagation=()=>!0,this.updateMeshPreviewSphere=async(e,t)=>{this.engine.commandBinder.issueCommand(new Y.n(e,t))},this.startPinCreation=()=>{this.editEnabled&&(this.addingHandlers.renew(),this.touchDevice||this.engine.commandBinder.issueCommand(new v.u(w.C.XHAIR)),this.engine.commandBinder.issueCommand(new q.ZD))},this.endPinCreation=()=>{this.editEnabled&&(this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.clearLongPressTimeout(),this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new v.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new q.zd))},this.onSelectedPinChanged=()=>{const{selectedPinId:e}=this.viewData;e?this.selectedHandlers.renew():this.selectedHandlers.cancel(),this.updateAnchorMesh()},this.onPinStateUpdated=()=>{const e=this.viewData.pinEditorState;switch(this.updateAnchorMesh(),e){case H.V8.PLACING:this.draggingHandlers.renew();break;case H.V8.IDLE:this.allowExternalBehaviors(!0)}},this.updateAnchorMesh=()=>{if(!this.editEnabled)return;const{pinEditorState:e,isPinEditable:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;n&&e!==H.V8.CREATING?([H.V8.PLACING,H.V8.PLACED].includes(e)||t?(this.pinRenderer.showAnchorMesh(n.pinType,n.id,n),this.anchored=!0):this.removePinAnchorMesh(),this.editableSelectedHandlers.renew()):(this.editableSelectedHandlers.cancel(),this.anchored&&this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1))},this.clearLongPressTimeout=()=>{this.longPressStart=0,-1!==this.longPressTimeout&&window.clearTimeout(this.longPressTimeout),this.longPressTimeout=-1},this.placePin=()=>{this.viewData.pinEditorState===H.V8.PLACING&&(this.engine.commandBinder.issueCommand(new v.u(w.C.DEFAULT)),this.engine.commandBinder.issueCommand(new K.ip),this.engine.broadcast(new W.cd),this.updateMeshPreviewSphere(!1))},this.onDragEvent=e=>{e.buttons!==O.r.PRIMARY&&(this.touchDevice||this.viewData.selectedPinId)||this.positionPin(e)},this.onDragEnd=e=>{const{creatingNewPin:t,pinEditorState:i,selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;t&&!this.touchDevice&&i===H.V8.PLACING||(s&&!t&&(this.engine.commandBinder.issueCommand(new K.I$(s.id,this.copyPinData(s),this.startingPinData)),this.updateMeshPreviewSphere(!1)),this.doneMovingPin(),this.inAnchorClick=!1)},this.positionPin=(()=>{const e=new n.Vector3;return async t=>{if(this.touchDevice&&t.buttons!==O.r.PRIMARY)return!1;const i=this.viewData,{pinEditorState:n,selectedPinId:s}=i;if(n===H.V8.CREATING)this.engine.commandBinder.issueCommand(new y.y(!0));else if(n!==H.V8.PLACING&&!this.movingPin)return!1;const a=s?i.getPin(s):null;if(!a)return!1;this.saveScreenPosition(t.position.x,t.position.y);const o=this.getModelIntersection();if(o&&o.face){this.engine.commandBinder.issueCommand(new v.u(w.C.XHAIR)),i.setCanPlace(!0);const t=((e,t,i)=>{var n;return null!==(n=t.floorIdFromObject(i.object))&&void 0!==n?n:e.getClosestFloorAtHeight(i.point.y).id})(this.floorsData,this.meshQuery,o);if(null===t)return!1;const s=this.meshQuery.mdsRoomIdFromObject(o.object);e.copy(a.stemNormal).setLength(a.stemLength),this.updateMeshPreviewSphere(!0,a.anchorPosition);const r={anchorPosition:a.anchorPosition.copy(o.point),stemNormal:a.stemNormal.copy(o.face.normal).normalize(),floorId:t,roomId:s};return this.engine.commandBinder.issueCommand(new K.tE(a.id,a.pinType,r)),n===H.V8.CREATING&&i.setPinEditorState(H.V8.PLACING),!0}return this.engine.commandBinder.issueCommand(new v.u(w.C.NOPE)),i.setCanPlace(!1),!1}})(),this.allowExternalBehaviors=async e=>{e||this.externalBehaviorsBlocked?e&&this.externalBehaviorsBlocked&&(this.dragInterceptor.cancel(),this.engine.commandBinder.issueCommand(new J.Lp),this.engine.commandBinder.issueCommand(new R.U),this.externalBehaviorsBlocked=!1):(this.dragInterceptor.renew(),this.engine.commandBinder.issueCommand(new J.ZK),this.engine.commandBinder.issueCommand(new R.t),this.externalBehaviorsBlocked=!0)},this.getModelIntersection=()=>{const e=.5*_.Z.anchor.size;return this.fatcaster.cast(e,(e=>!!(0,E.Pv)(e)&&(!this.viewmodeData.isDollhouse()&&!this.viewmodeData.isFloorplan()||this.floorsViewData.isCurrentMeshGroupOrAllFloors(e.meshGroup))),P.a.Filter.CENTER_GROUP(e))},this.onPointerButton=e=>{e.down||this.viewData.pinEditorState!==H.V8.PLACED||(this.allowExternalBehaviors(!0),this.engine.commandBinder.issueCommand(new y.y(!1)))},this.onAnchorDragBegin=e=>{const{isPinEditable:t,pinEditorState:i,selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;!s||e.buttons!==O.r.PRIMARY||i!==H.V8.PLACED&&i!==H.V8.IDLE||(t?(this.movingPin=!0,this.startingPinData=this.copyPinData(s),this.allowExternalBehaviors(!1),this.draggingHandlers.renew(),this.engine.commandBinder.issueCommand(new v.u(w.C.GRABBING)),this.engine.commandBinder.issueCommand(new y.y(!0)),this.engine.commandBinder.issueCommand(new R.t),this.inAnchorClick=!0):this.log.debug("onAnchorSelect called on a non-editable pin"))},this.doneMovingPin=()=>{this.viewData.selectedPinId&&this.movingPin&&(this.draggingHandlers.cancel(),this.engine.commandBinder.issueCommand(new v.u(null)),this.engine.commandBinder.issueCommand(new y.y(!1)),this.engine.commandBinder.issueCommand(new R.U),this.movingPin=!1,this.startingPinData=void 0,this.allowExternalBehaviors(!0),this.updateMeshPreviewSphere(!1))},this.onClickElsewhere=e=>{const{selectedPinId:t,pinEditorState:i}=this.viewData;if(!(i===H.V8.CREATING&&t||this.inAnchorClick))return t&&(this.movingPin?this.doneMovingPin():this.engine.commandBinder.issueCommand(new K.yR)),!0},this.onLongPressStart=async e=>{if(e.buttons!==O.r.PRIMARY)return;const t=this.viewData;t.pinEditorState===H.V8.CREATING&&(this.longPressStart=Date.now(),t.setPinEditorState(H.V8.PRESSING),this.allowExternalBehaviors(!1),this.saveScreenPosition(e.position.x,e.position.y),this.longPressTimeout=window.setTimeout((async()=>{t.setPinEditorState(H.V8.PLACING);await this.positionPin(e)||(t.setPinEditorState(H.V8.CREATING),t.setCanPlace(!1)),this.longPressTimeout=-1}),this.longPressCreateThreshold))},this.onLongPressEnd=()=>{const e=this.viewData.pinEditorState;e===H.V8.PRESSING?(this.log.debug("Did not press long enough"),this.endPinCreation()):e===H.V8.PLACING&&this.placePin()},this.onPointerEvent=e=>{const t=this.viewData.pinEditorState;t!==H.V8.PLACING&&t!==H.V8.CREATING||this.positionPin(e)},this.onClickToPlacePin=()=>{this.placePin()},this.onKeyEvent=e=>{if(e.state===L.M.PRESSED)switch(e.key){case F.R.ESCAPE:this.viewData.creatingNewPin&&this.engine.broadcast(new W.pe)}},Promise.all([t.market.waitForData(m.M),t.market.waitForData(Z.i),t.market.waitForData(l.c),t.market.waitForData(p.O),t.getModuleBySymbol(a.c3),t.getModuleBySymbol(a.hi)]).then((([t,n,s,a,o,r])=>{this.cameraData=t,this.floorsData=n,this.floorsViewData=s,this.viewmodeData=a,this.fatcaster=o,this.meshQuery=r,this.bindings.push(i.registerPriorityHandler(N.er,j.$,this.stopEventPropagation),e.onSelectedPinChanged(this.onSelectedPinChanged)),this.selectedHandlers=new C.V(i.registerPriorityHandler(M.R,A.S,this.onClickElsewhere),i.registerPriorityHandler(M.R,S.i,this.onClickElsewhere)),this.selectedHandlers.cancel()}))}dispose(){var e,t,i,n,s;this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1),null===(e=this.dragInterceptor)||void 0===e||e.cancel(),null===(t=this.addingHandlers)||void 0===t||t.cancel(),null===(i=this.draggingHandlers)||void 0===i||i.cancel(),null===(n=this.selectedHandlers)||void 0===n||n.cancel(),null===(s=this.editableSelectedHandlers)||void 0===s||s.cancel(),this.bindings.forEach((e=>{e.cancel()}))}update(){if(!this.editEnabled)return;const e=this.viewData;if(this.touchDevice&&e.pinEditorState===H.V8.PRESSING){const t=Math.min(1,(Date.now()-this.longPressStart)/this.longPressCreateThreshold);e.setProgress(t)}}toggleEditing(e){e!==this.editEnabled&&(this.editEnabled=e,e?(this.handlersRegistered?this.creationHandlers.renew():this.registerHandlers(),this.updateAnchorMesh()):(this.inAnchorClick=!1,this.anchored=!1,this.movingPin=!1,this.creationHandlers.cancel(),this.allowExternalBehaviors(!0),this.removePinAnchorMesh(),this.updateMeshPreviewSphere(!1)),this.dragInterceptor.cancel(),this.draggingHandlers.cancel(),this.addingHandlers.cancel(),this.editableSelectedHandlers.cancel())}registerHandlers(){const e=this.input,t=this.viewData;this.creationHandlers=new C.V(t.onPinEditorStateChanged(this.onPinStateUpdated)),this.dragInterceptor=new C.V(e.registerPriorityHandler(x._t,A.S,(()=>!0)),e.registerPriorityHandler(x._t,S.i,(()=>!0))),this.draggingHandlers=new C.V(e.registerUnfilteredHandler(x._t,this.onDragEvent),e.registerUnfilteredHandler(x._R,this.onDragEnd)),this.editableSelectedHandlers=new C.V(e.registerMeshHandler(x.E0,I.s.isType($),this.onAnchorDragBegin)),this.touchDevice?this.addingHandlers=new C.V(e.registerHandler(N.er,this.onPointerButton),e.registerUnfilteredHandler(B.Vh,this.onLongPressStart),e.registerUnfilteredHandler(B.pt,this.onLongPressEnd)):this.addingHandlers=new C.V(e.registerHandler(V.e,this.onKeyEvent),e.registerHandler(N.er,this.onPointerButton),e.registerUnfilteredHandler(M.R,this.onClickToPlacePin),e.registerHandler(N.mE,this.onPointerEvent))}removePinAnchorMesh(){this.pinRenderer.hideAnchorMesh(),this.anchored=!1}copyPinData(e){return{anchorPosition:e.anchorPosition.clone(),stemNormal:e.stemNormal.clone(),floorId:e.floorId,roomId:e.roomId,stemLength:e.stemLength,stemEnabled:e.stemEnabled,color:e.color}}saveScreenPosition(e,t){this.ndcPoint.set(e,t,0);const i=(0,o.fi)(this.cameraData.width,this.cameraData.height,this.ndcPoint);this.viewData.setScreenPosition(i)}}var X=i(23612),ee=i(4510),te=i(7402),ie=i(23885),ne=i(55763);class se extends n.Mesh{constructor(e){super(new n.PlaneGeometry(_.Z.anchor.size,_.Z.anchor.size),new ne.Dx),this.visible=!1,this.layers.mask=e.mask,this.renderOrder=U.z.pinSelectedHalo}}var ae=i(98748);class oe{constructor(e,t,i=1){this.atlasMaxSize=e,this.iconSize=t,this.padding=i,this.uvRects=new Map,this.iconCount=0,this.onResize=new ae.$;const s=this.canvas=document.createElement("canvas");s.width=e,s.height=t,this.texture=new n.CanvasTexture(s)}addIcon(e,t){var i,n;const{atlasMaxSize:s,iconSize:a,padding:o,canvas:r,uvRects:d}=this,h=r.getContext("2d");let l=!1,c=d.get(e);if(!c){const t=this.iconCount++,i=s/a,n=Math.floor(t/i),o=t%i;if((n+1)*a>r.height){const e=h.getImageData(0,0,r.width,r.height);r.height*=2,h.putImageData(e,0,r.height/2),this.texture.dispose(),d.forEach((e=>{e.minV/=2,e.maxV/=2})),l=!0}c={minU:o/i,minV:n/(r.height/a),maxU:(o+1)/i,maxV:(n+1)/(r.height/a)},d.set(e,c)}const m=c.minU*s,u=(1-c.maxV)*r.height;return h.clearRect(m,u,a,a),"font"===t.type?(h.font=`${a-2*o}px ${t.family}`,h.textAlign="center",h.textBaseline="top",h.fillStyle="#fff",h.fillText(String.fromCodePoint(t.codePoint),m+a/2+((null===(i=t.offset)||void 0===i?void 0:i.x)||0),u+o+((null===(n=t.offset)||void 0===n?void 0:n.y)||0))):h.drawImage(t.image,m+o,u+o,a-2*o,a-2*o),this.texture.needsUpdate=!0,l&&this.onResize.notify(),c}}var re=i(81346),de=i(39689);class he{constructor(e,t,i,s,a=!1){this.input=e,this.layer=t,this.commandBinder=i,this.raycaster=s,this.iconsEnabled=a,this.container=new n.Object3D,this.floorIdToContainer=new Map,this.hexColorToColor=new Map,this.bindings=[],this.anchor=null,this.selected=null,this.haloEasing=(0,ie.tf)(.5,.52,0,1.98),this.pinViews=new Map,this.pinsWithOverrideTexture=new Set,this.refreshPins=()=>{this.pinViews.forEach(((e,t)=>{this.updatePin(t,e.pinType,e,e.backgroundTexture)}))},this.updateAnchorPosition=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3;return n=>{const s=this.anchorMesh;if(!s)return;const a=this.raycaster.picking;e.copy(n.stemNormal).normalize(),t.copy(e).multiplyScalar(.2).add(n.anchorPosition),i.copy(e).multiplyScalar(-1);const o=a.pick(t,i,(e=>e instanceof te.g));if(o){const e=Math.min(.2,o.distance);s.position.copy(t).add(i.multiplyScalar(.999*e))}else s.position.copy(t).add(i.multiplyScalar(.999*n.stemLength));s.lookAt(t)}})(),this.onAnchorHover=()=>{this.commandBinder.issueCommand(new v.u(w.C.GRAB)),this.commandBinder.issueCommand(new y.y(!0))},this.onAnchorUnhover=()=>{this.commandBinder.issueCommand(new v.u(null)),this.commandBinder.issueCommand(new y.y(!1))},this.iconAtlas=new oe(4096,128,4),this.iconAtlas.onResize.observe({notify:this.refreshPins})}init(){this.container.name="PinContainer",this.container.layers.mask=this.layer.mask,this.anchorMesh=new $(this.layer),this.anchorMesh.name="Anchor Mesh",this.container.add(this.anchorMesh),this.selectedMesh=new se(this.layer),this.selectedMesh.name="Selected Mesh",this.container.add(this.selectedMesh);for(const e of Object.values(H.Qk))this.iconAtlas.addIcon(e,{type:"font",family:"mp-font",codePoint:+re.f[e],offset:(0,de.m1)(e)})}dispose(){this.container.parent&&this.container.parent.remove(this.container);for(const e of[this.anchorMesh,this.selectedMesh])e&&e.parent&&e.parent.remove(e)}activate(e){this.bindings.length>0||this.bindings.push(this.input.registerMeshHandler(X.z,I.s.isType($),this.onAnchorHover),this.input.registerMeshHandler(X.A,I.s.isType($),this.onAnchorUnhover))}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0}render(e){if(!this.selected)return;const{animation:t,hideWhenDoneAnimating:i}=this.selected,s=this.selectedMesh;if(s&&s.visible&&t){const e=this.pinHeadTransform(this.selected.id),a=new n.Vector3,o=new n.Quaternion,r=new n.Vector3;e.decompose(a,o,r),r.multiplyScalar(t.getUpdatedValue()),i&&!t.isAnimating?(s.visible=!1,this.selected=null):(s.position.copy(a),s.quaternion.copy(o),s.scale.copy(r))}}updatePin(e,t,i,n,s){this.anchorMesh&&this.anchorMesh.visible&&this.anchor&&this.anchor.pinType===t&&this.anchor.id===e&&this.updateAnchorPosition(i),this.pinViews.set(e,Object.assign(Object.assign({},i),{id:e,pinType:t,backgroundTexture:n}))}removePin(e){this.selected&&this.selected.id===e&&this.clearSelected(),this.pinViews.delete(e)}removePinsByType(e){this.removePinsByPredicate((t=>t===e))}removePinsByPredicate(e){}setPinVisible(e,t){}setPinColorVariant(e,t){}setPinColorVariants(e,t){}setPinColorVariantByType(e,t,i){}setPinOpacity(e,t){}setPinOpacityByType(e,t,i){}fadePinOpacity(e,t){}fadePinOpacityByType(e,t,i=[]){}setPinRenderOverrides(e,t,i){t?(this.pinsWithOverrideTexture.add(e),this.selected&&this.selected.id===e&&this.clearSelected()):this.pinsWithOverrideTexture.delete(e)}setFloorsHidden(e){this.floorIdToContainer.forEach(((t,i)=>{t.visible=!e(i)}))}setPinTypeVisible(e,t){this.floorIdToContainer.forEach((i=>{i.userData.typeContainers[e].visible=t}))}showAnchorMesh(e,t,i){this.anchor={pinType:e,id:t},this.anchorMesh&&!this.anchorMesh.visible&&(this.anchorMesh.visible=!0,this.input.registerMesh(this.anchorMesh,!1)),this.updateAnchorPosition(i)}hideAnchorMesh(){this.anchorMesh&&this.anchorMesh.visible&&(this.anchorMesh.visible=!1,this.input.unregisterMesh(this.anchorMesh))}showSelectedMesh(e,t){const i=this.selected&&this.selected.pinType===e&&this.selected.id===t;this.selected&&i||this.pinsWithOverrideTexture.has(t)||(this.selected={pinType:e,id:t,hideWhenDoneAnimating:!1,animation:new ee.Z({startValue:10,endValue:14,duration:300,easingFunction:this.haloEasing})},this.selectedMesh.visible=!0)}hideSelectedMesh(){this.selected&&(this.selected.animation=new ee.Z({startValue:14,endValue:10,duration:300}),this.selected.hideWhenDoneAnimating=!0)}getFloorContainer(e){let t=this.floorIdToContainer.get(e);if(t)return t;t=new n.Object3D,t.name="Floor "+e,t.userData.typeContainers={},t.layers.mask=this.layer.mask;for(const e of Object.values(H.Er)){const i=new n.Object3D;i.name=e,i.layers.mask=this.layer.mask,t.add(i),t.userData.typeContainers[e]=i}return this.container.add(t),this.floorIdToContainer.set(e,t),t.userData.floorId=e,t}getColor(e){let t=this.hexColorToColor.get(e);if(t)return t;const i=new n.Color(e),s={h:0,s:0,l:0};i.getHSL(s);return t={baseColor:i,hoverColor:(new n.Color).setHSL(s.h,s.s,.8*s.l),dimmedColor:(new n.Color).setHSL(s.h,.5*s.s,s.l)},this.hexColorToColor.set(e,t),t}getViewportScale(e){return Math.sqrt(Math.min(e.width,e.height)/_.Z.pinHeadMesh.scale.baseViewportSize)}clearSelected(){this.selectedMesh.visible=!1,this.selected=null}}class le extends n.Line{constructor(e,t,i,s,a){const o=new n.BufferGeometry,r=new Float32Array(6);r[0]=r[1]=r[2]=0,r[3]=e.x,r[4]=e.y,r[5]=e.z,o.setAttribute("position",new n.BufferAttribute(r,3));const d=new ne.l0;super(o,d),this.geometry=o,this.layers.mask=i.mask,this.visible=t,this.vector=e.clone(),this.onBeforeRender=(e,t,i,n,o)=>{const r=o;r.uniforms.pinHeadMatrix.value.copy(s.matrixWorld),r.uniforms.resolution.value.set(a.width,a.height),r.uniformsNeedUpdate=!0},this.pinStemMaterial=d}dispose(){this.geometry.dispose()}updatePosition(e){this.vector.copy(e.stemNormal).setLength(Math.max(e.stemLength,.01));const t=this.geometry.getAttribute("position");t.setXYZ(1,this.vector.x,this.vector.y,this.vector.z),t.needsUpdate=!0}}var ce=i(89557);class me extends n.Object3D{constructor(e,t,i,s,a,o,r,d,h,l){super(),this.pinId=e,this.pinType=t,this.pinColor=s,this.stemVector=new n.Vector3,this.stemEnabled=!0,this.currentColorVariant=H.K_.DEFAULT,this.baseOpacity=1,this.opacityScale=1,this.pinHeadGeometryInst=new n.PlaneGeometry(_.l,_.l),this.pinHeadGeometryInst.setAttribute("instanceMaskRect",new n.BufferAttribute(a,4)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(l,1)),me.pinHeadGeometry||(me.pinHeadGeometry=new n.PlaneGeometry(_.l,_.l));const c=(new n.Color).copy(s.baseColor);this.pinHeadMeshMaterial=new ne.Nv(c,d,h,1),this.pinHeadMesh=new j.$(e,this.pinHeadGeometryInst,this.pinHeadMeshMaterial,o),this.add(this.pinHeadMesh),this.stemMesh=new le(i.stemNormal,i.stemEnabled,o,this.pinHeadMesh,r),this.add(this.stemMesh),this.updateMeshPosition(i),this.opacityAnimation=new ce.z(1)}dispose(){this.remove(this.pinHeadMesh),this.pinHeadMesh.material.dispose(),this.pinHeadMesh.dispose(),this.remove(this.stemMesh),this.stemMesh.dispose()}static disposeAll(){me.pinHeadGeometry.dispose()}updateFromPin(e,t,i,s,a,o){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemVector.copy(e.stemNormal).setLength(e.stemLength),this.stemEnabled=e.stemEnabled,this.stemMesh.updatePosition(e),this.stemMesh.visible=e.stemEnabled,this.pinHeadGeometryInst.setAttribute("instanceMaskRect",new n.BufferAttribute(i,4)),this.pinHeadGeometryInst.setAttribute("instanceStrokeWidth",new n.BufferAttribute(o,1)),t!==this.pinColor&&(this.pinColor=t,this.setColorVariant(this.currentColorVariant));const r=this.pinHeadMeshMaterial.uniforms;r.bg.value===s&&r.mask.value===a||(r.bg.value=s,r.mask.value=a,this.pinHeadMeshMaterial.uniformsNeedUpdate=!0)}setColorVariant(e){const t=(0,de.ke)(this.pinColor,e);this.pinHeadMeshMaterial.uniforms.color.value.copy(t),this.currentColorVariant=e}setOpacity(e){this.baseOpacity=e,this.updateOpacity()}setOpacityScale(e){this.opacityScale=e,this.updateOpacity()}fadeOpacity(e){e>0&&(this.visible=!0),this.opacityAnimation.modifyAnimation(this.opacityAnimation.value,e,300).onComplete((()=>{e<=0&&(this.visible=!1)}))}setVisibility(e,t){this.visible=e,this.pinHeadMesh.visible=e,this.stemMesh.visible=e&&t}setStemEnabled(e){this.stemMesh.visible=this.visible&&e}updateMeshPosition(e){this.position.copy(e.anchorPosition),this.pinHeadMesh.updatePosition(e),this.stemMesh.updatePosition(e)}update(e,t,i,n){this.pinHeadMesh.update(t,i,n);const s=this.opacityAnimation.active;this.opacityAnimation.tick(e),s&&this.updateOpacity()}setRenderOverrides(e,t){this.pinHeadMesh.material=e?new ne.m0(e,!1):this.pinHeadMeshMaterial,t?this.pinHeadMesh.geomScale.copy(t):this.pinHeadMesh.geomScale.set(1,1,1),this.setOpacity(this.pinHeadMeshMaterial.opacity)}updateOpacity(){const e=this.opacityAnimation.value*this.baseOpacity*this.opacityScale;if(this.pinHeadMeshMaterial.opacity=e,this.pinHeadMeshMaterial.uniforms.alpha.value=e,this.pinHeadMesh.material!==this.pinHeadMeshMaterial){this.pinHeadMesh.material.opacity=e;const t=this.pinHeadMesh.material;t&&t.uniforms&&t.uniforms.alpha&&(t.uniforms.alpha.value=e)}this.stemMesh.pinStemMaterial.uniforms.alpha.value=e}}class ue extends he{constructor(e,t,i,n,s,a,o,r=!1){super(e,n,s,a,r),this.camera=t,this.canvasData=i,this.idToMesh=new Map,this.inputCallbacks=o}dispose(){super.dispose(),this.removePinsByPredicate((()=>!0)),me.disposeAll()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(M.R,j.$,((e,t)=>{const i=t.parent;return this.inputCallbacks.onClick(i.pinId,i.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(X.z,I.s.isType(j.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onHover(i.pinId,i.pinType)}))),this.bindings.push(this.input.registerMeshHandler(X.A,I.s.isType(j.$),((e,t)=>{const i=t.parent;this.inputCallbacks.onUnhover(i.pinId,i.pinType)})))))}render(e){const t=this.getViewportScale(this.canvasData);this.idToMesh.forEach((i=>{i.update(e,this.camera,t,this.canvasData)})),super.render(e)}updatePin(e,t,i,n,s){var a,o;super.updatePin(e,t,i,n,s);const r=this.getColor(i.color),d=(0,de.mg)(t,i.icon,this.iconsEnabled);let h=this.iconAtlas.uvRects.get(d);h||(h=this.iconAtlas.addIcon(d,{type:"font",family:"mp-font",codePoint:+re.f[d],offset:(0,de.m1)(d)}));const l=new Float32Array(16),c=new Float32Array(4),m=this.iconAtlas.texture;for(let e=0;e<l.length;e+=4)l[e]=h.minU,l[e+1]=h.minV,l[e+2]=h.maxU,l[e+3]=h.maxV;const u=t===H.Er.OBJECT?0:.06;c[0]=u,c[1]=u,c[2]=u,c[3]=u;let p=this.idToMesh.get(e);p||(p=new me(e,t,i,r,l,this.layer,this.canvasData,n,m,c),this.idToMesh.set(e,p),this.input.registerMesh(p.pinHeadMesh,!1)),void 0!==s&&(p.visible=s),p.updateFromPin(i,r,l,n,m,c);const g=i.floorId;p.parent&&(null===(a=p.parent)||void 0===a?void 0:a.userData.floorId)===g||(p.parent&&(null===(o=p.parent)||void 0===o||o.remove(p)),this.getFloorContainer(g).userData.typeContainers[t].add(p))}removePin(e){var t;super.removePin(e);const i=this.idToMesh.get(e);i&&(this.idToMesh.delete(e),null===(t=i.parent)||void 0===t||t.remove(i),this.input.unregisterMesh(i.pinHeadMesh),i.dispose())}removePinsByPredicate(e){this.idToMesh.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToMesh.get(e);i&&(i.visible=t)}setPinColorVariant(e,t){const i=this.idToMesh.get(e);i&&i.setColorVariant(t)}setPinColorVariants(e,t){this.idToMesh.forEach((i=>{i.pinId!==t&&i.setColorVariant(e)}))}setPinColorVariantByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setColorVariant(t)}))}setPinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.setOpacity(t)}setPinOpacityScale(e,t){const i=this.idToMesh.get(e);i&&i.setOpacityScale(t)}fadePinOpacity(e,t){const i=this.idToMesh.get(e);i&&i.fadeOpacity(t)}setPinOpacityByType(e,t,i){this.idToMesh.forEach((n=>{n.pinType===e&&n.pinId!==i&&n.setOpacity(t)}))}fadePinOpacityByType(e,t,i=[]){this.idToMesh.forEach((n=>{n.pinType!==e||i.includes(n.pinId)||n.fadeOpacity(t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToMesh.get(e);n&&n.setRenderOverrides(t,i)}pinHeadTransform(e){const t=this.idToMesh.get(e);return t?t.pinHeadMesh.matrixWorld:new n.Matrix4}}var pe=i(66372),ge=i(49827),ye=i(21646),ve=i(90304),we=i(79183);const be=new ne.uW,fe=new k.Z("InstancedPinHeads");class Te extends n.InstancedMesh{constructor(e){const t=new n.BufferGeometry,i=new Float32Array(6);i[0]=i[1]=i[2]=0,i[3]=1,i[4]=1,i[5]=1,t.setAttribute("position",new n.BufferAttribute(i,3));const s=new Float32Array(3*e),a=new n.InstancedBufferAttribute(s,3);t.setAttribute("stemVector",a);const o=new Float32Array(e),r=new n.InstancedBufferAttribute(o,1);t.setAttribute("instanceAlpha",r);const d=[],h=[];for(let i=0;i<4;i++){const s=new Float32Array(4*e),a=new n.InstancedBufferAttribute(s,4);t.setAttribute(`pinHeadMatrixCol${i}`,a),d.push(s),h.push(a)}super(t,be,e),this.maxCount=e,this.stemVectorArray=s,this.stemVectorAttrib=a,this.pinHeadMatrixArray=d,this.pinHeadMatrixAttrib=h,this.opacityArray=o,this.opacityAttrib=r,this.renderOrder=U.z.lines,this.posMatrix=new n.Matrix4,this.isLine=!0,this.isMesh=!1}update(e,t){let i=0;for(const t of e){if(!t.visible||!t.stemEnabled||t.stemLength<.001)continue;if(i>=this.maxCount){fe.error("Instance count is too small!");continue}this.posMatrix.setPosition(t.anchorPosition),this.setMatrixAt(i,this.posMatrix),this.opacityArray[i]=t.opacity*t.opacityAnimation.value*t.opacityScale;const e=3*i;t.pinHeadObjPosition.toArray(this.stemVectorArray,e);let n=0;for(let e=0;e<4;e++)for(let s=0;s<4;s++)this.pinHeadMatrixArray[e][s+4*i]=t.pinHeadMatrix.elements[n++];i++}this.count=i,this.visible=this.count>0,this.instanceMatrix.needsUpdate=!0,this.stemVectorAttrib.needsUpdate=!0;for(const e of this.pinHeadMatrixAttrib)e.needsUpdate=!0;this.opacityAttrib.needsUpdate=!0,be.uniforms.resolution.value.set(t.width,t.height),be.uniformsNeedUpdate=!0,this.computeBoundingSphere()}}const De=new k.Z("InstancedPinRenderer");class Ce extends he{constructor(e,t,i,s,a,o,r,d=!1){super(e,s,a,o,d),this.camera=t,this.canvasData=i,this.pins=new Map,this.idToPin=new Map,this.keyToRenderObjs=new Map,this.updatePinHeadMatrix=(()=>{const e=new n.Vector3,t=new n.Vector3,i=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,r=new n.Vector3;return n=>{const d=_.Z.pinHeadMesh.scale,h=this.getViewportScale(this.canvasData),l=1+d.responsiveness/100*(h-1);this.camera.getWorldPosition(o);const c=this.camera.quaternion,m=this.canvasData;for(const h of n){r.copy(h.pinHeadObjPosition).add(h.anchorPosition);const n=o.distanceTo(r),u=d.maxSize-(d.maxSize-d.minSize)*(0,pe.C)(n,d.nearBound,d.farBound);t.copy(r).project(this.camera),i.set(m.width/2,m.height/2,1).multiply(t),s.set(u/2,0,0).add(i),a.set(2/m.width,2/m.height,1).multiply(s);const p=a.unproject(this.camera).distanceTo(r)*l,g=(0,ge.uZ)(p,ye.Z.epsilon,p),y=h.geomScale||ve.fU.UNIT;e.set(g*y.x,g*y.y,g*y.z),h.pinHeadMatrix.compose(r,c,e)}}})(),this.inputCallbacks=r}dispose(){super.dispose()}activate(e){this.bindings.length>0||(super.activate(e),this.bindings.push(this.input.registerPriorityHandler(M.R,we.z,((e,t,i)=>{if(!i||void 0===i.instanceId)return!0;const n=t.renderedPins[i.instanceId];return this.inputCallbacks.onClick(n.id,n.pinType),!0}))),(0,r.Jm)()||(this.bindings.push(this.input.registerMeshHandler(X.z,I.s.isType(we.z),((e,t,i)=>{if(!i||void 0===i.instanceId)return;const n=t.renderedPins[i.instanceId];this.lastHoverId=n.id,this.lastHoverType=n.pinType,this.inputCallbacks.onHover(n.id,n.pinType)}))),this.bindings.push(this.input.registerMeshHandler(X.A,I.s.isType(we.z),(()=>{this.inputCallbacks.onUnhover(this.lastHoverId,this.lastHoverType)})))))}render(e){var t,i,n,s;for(const a of this.pins.values()){const o=Array.from(a.values());if(0===o.length)continue;const r=this.keyFromPin(o[0]),d=this.keyToRenderObjs.get(r);if(!d){De.error("Expecting renderObjs for this key.",this.keyToRenderObjs,this.keyFromPin(o[0]));continue}let{lines:h,pinHeads:l}=d;if(o.forEach((t=>t.opacityAnimation.tick(e))),this.updatePinHeadMatrix(o),h.maxCount<o.length){const e=h.parent;if(!e){De.error("Expecting a parent.");continue}e.remove(h),h.dispose(),e.remove(l),this.input.unregisterMesh(l);const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=o[0];l.dispose(),Object.assign(d,this.createInstances(e,d.id,o.length+16,t,i,n)),h=d.lines,l=d.pinHeads}h.update(o,this.canvasData),(null===(t=o[0].maskTexture)||void 0===t?void 0:t.uuid)&&(null===(s=null===(n=null===(i=l.material.uniforms)||void 0===i?void 0:i.mask)||void 0===n?void 0:n.value)||void 0===s?void 0:s.uuid)&&o[0].maskTexture.uuid!==l.material.uniforms.mask.value.uuid&&l.updateMaskTexture(o[0].maskTexture),l.update(o)}super.render(e)}updatePin(e,t,i,s,a){var o;super.updatePin(e,t,i,s,a);let r=this.idToPin.get(e);const d=i.floorId,h=this.getColor(i.color).baseColor,l=`${d}_${t}_${(null===(o=null==r?void 0:r.overrideTexture)||void 0===o?void 0:o.uuid)||s.uuid}`,c=(0,de.mg)(t,i.icon,this.iconsEnabled);let m=this.iconAtlas.uvRects.get(c);m||(m=this.iconAtlas.addIcon(c,{type:"font",family:"mp-font",codePoint:+re.f[c],offset:(0,de.m1)(c)}));const u=t===H.Er.OBJECT?0:.06;if(!r){r=Object.assign(Object.assign({id:e},i),{visible:!0,opacity:1,opacityScale:1,pinType:t,opacityAnimation:new ce.z(0),backgroundTexture:s,maskTexture:this.iconAtlas.texture,pinHeadMatrix:new n.Matrix4,pinHeadObjPosition:new n.Vector3,pinColor:h,colorVariant:H.K_.DEFAULT,overrideTexture:null,geomScale:null,pinIconUVRect:m,pinStrokeWidth:u,needsEntryAnimation:!0}),this.idToPin.set(e,r);let a=this.pins.get(l);a||(a=new Map,this.pins.set(l,a)),a.set(e,r),this.createRenderObjsForPin(r)}const p=this.keyFromPin(r);Object.assign(r,i,{pinType:t,textureId:s.uuid,maskTexture:this.iconAtlas.texture}),this.changePinHeadGroupIfNeeded(p,l,r),r.pinHeadObjPosition.copy(r.stemNormal).setLength(r.stemLength),r.pinColor=(0,de.ke)(this.getColor(r.color),r.colorVariant),r.pinIconUVRect=m,r.pinStrokeWidth=u,void 0!==a&&this.setPinVisible(e,a),m&&r.needsEntryAnimation&&(r.opacityAnimation.modifyAnimation(r.opacityAnimation.value,1,500,ie.ad),r.opacityAnimation.onComplete((()=>{r&&(r.needsEntryAnimation=!1)})))}removePin(e){super.removePin(e);const t=this.idToPin.get(e);if(!t)return;this.idToPin.delete(e);const i=this.keyFromPin(t),n=this.pins.get(i);n&&(n.delete(e),this.cleanupRenderObjIfNeeded(i))}removePinsByPredicate(e){this.idToPin.forEach(((t,i)=>{e(t.pinType)&&this.removePin(i)}))}setPinVisible(e,t){const i=this.idToPin.get(e);i?i.visible=t:De.error("setPinVisible on a pin that doesn't exist.",e)}setPinColorVariant(e,t){const i=this.idToPin.get(e);i?(i.colorVariant=t,i.pinColor=(0,de.ke)(this.getColor(i.color),t)):De.error("setPinColorVariant on a pin that doesn't exist.")}setPinColorVariants(e,t){this.idToPin.forEach(((i,n)=>{n!==t&&this.setPinColorVariant(n,e)}))}setPinColorVariantByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinColorVariant(s,t)}))}setPinOpacity(e,t){const i=this.idToPin.get(e);i?i.opacity=t:De.error("setPinOpacity on a pin that doesn't exist.")}setPinOpacityScale(e,t){const i=this.idToPin.get(e);i?i.opacityScale=t:De.error("setPinOpacityScale on a pin that doesn't exist.")}fadePinOpacity(e,t){const i=this.idToPin.get(e);i?(t>0&&this.setPinVisible(e,!0),i.opacityAnimation.modifyAnimation(i.opacityAnimation.value,t,300).onComplete((()=>{i.opacityAnimation.endValue<=0&&this.setPinVisible(e,!1)}))):De.error("setPinVisible on a pin that doesn't exist.",e)}setPinOpacityByType(e,t,i){this.idToPin.forEach(((n,s)=>{n.pinType===e&&s!==i&&this.setPinOpacity(s,t)}))}fadePinOpacityByType(e,t,i=[]){this.idToPin.forEach(((n,s)=>{n.pinType!==e||i.includes(s)||this.fadePinOpacity(s,t)}))}setPinRenderOverrides(e,t,i){super.setPinRenderOverrides(e,t,i);const n=this.idToPin.get(e);if(!n)return void De.error("setPinRenderOverrides on a pin that doesn't exist.");const s=this.keyFromPin(n);if(!this.keyToRenderObjs.get(s))return void De.error("Expecting renderObjs while setting override material");n.overrideTexture=t,n.geomScale=i;const a=this.keyFromPin(n);this.changePinHeadGroupIfNeeded(s,a,n)}pinHeadTransform(e){const t=this.idToPin.get(e);return t?t.pinHeadMatrix:(De.error("pinHeadTransform on a pin that doesn't exist."),new n.Matrix4)}keyFromPin(e){return`${e.floorId}_${e.pinType}_${e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid}`}createRenderObjsForPin(e){const{backgroundTexture:t,maskTexture:i,overrideTexture:n}=e,s=this.keyFromPin(e);if(this.keyToRenderObjs.get(s))return;const a=this.getFloorContainer(e.floorId).userData.typeContainers[e.pinType];a.userData||(a.userData={});const o=e.overrideTexture?e.overrideTexture.uuid:e.backgroundTexture.uuid;if(!a.userData[o]){const e=this.createInstances(a,o,16,t,i,n);a.userData[o]=e,this.keyToRenderObjs.set(s,e)}}createInstances(e,t,i,n,s,a){const o=new Te(i);o.layers.mask=this.layer.mask,e.add(o);const r=new we.z(i,a||n,a?null:s,!a);return r.layers.mask=this.layer.mask,e.add(r),this.input.registerMesh(r,!1),{lines:o,pinHeads:r,id:t}}changePinHeadGroupIfNeeded(e,t,i){if(e!==t){let n=this.pins.get(t);n||(n=new Map,this.pins.set(t,n)),n.set(i.id,i),this.createRenderObjsForPin(i);const s=this.pins.get(e);s&&(null==s||s.delete(i.id),this.cleanupRenderObjIfNeeded(e))}}cleanupRenderObjIfNeeded(e){const t=this.pins.get(e),i=this.keyToRenderObjs.get(e);if(t&&0===t.size&&i){const t=i.lines.parent;if(this.input.unregisterMesh(i.pinHeads),this.pins.delete(e),this.keyToRenderObjs.delete(e),!t)return void De.error("Expecting pinTypeObj!");t.userData[i.id]=void 0,t.remove(i.lines),t.remove(i.pinHeads)}}}var Pe=i(80742);class Ae extends s.Y{constructor(){super(...arguments),this.name="pins",this.editActivated=!1,this.editBindings=[],this.touchDevice=(0,r.Jm)(),this.worldPosition=new n.Vector3,this.visibilityChanged=()=>{const e=!this.in360View(),t=!this.interactionmodeData.isVR();this.pinRenderer.container.visible=e&&t;const{floorsViewData:i}=this,n=this.viewmode===g.Ey.Dollhouse||this.viewmode===g.Ey.Floorplan,s=i.transition.progress.active?()=>!0:i.isHidden;this.pinRenderer.setFloorsHidden(n?s:()=>!1)},this.viewmodeChanged=e=>{this.viewmode=e.toMode,this.visibilityChanged()},this.onEnablePinEditing=async e=>{e.enabled?this.enableEditing():this.disableEditing()},this.updateCurrentPin=()=>{const{pinEditorState:e,focusedPin:t,selectedPinId:i}=this.viewData;if(e!==H.V8.CREATING){const e=i?this.viewData.getPin(i):null,n=t||e;if(this.pinEditor.updateAnchorMesh(),n){const{id:e,pinType:t,backgroundTexture:i}=n;this.pinRenderer.updatePin(e,t,n,i),this.pinRenderer.setPinColorVariant(e,H.K_.HIGHLIGHTED),this.pinRenderer.setPinColorVariants(H.K_.DEFAULT,e)}else this.pinRenderer.setPinColorVariants(H.K_.DEFAULT)}},this.onUpdatePin=async e=>{const{id:t,pinType:i,properties:n}=e,s=this.viewData.getPin(t);if(s&&s.pinType===i){const{focusedPin:e,selectedPinId:i}=this.viewData,a=i?this.viewData.getPin(i):null,o=Object.assign(Object.assign({},s),n);this.viewData.updatePin(o),this.pinRenderer.updatePin(o.id,o.pinType,o,o.backgroundTexture),(null==a?void 0:a.id)===t&&(this.saveScreenPosition(o),this.updateCurrentPin()),(null==e?void 0:e.id)===t&&this.saveScreenPosition(o)}else this.log.debug(`Cannot update non-existent ${i} pin`)},this.onUpdatePinViews=async e=>{const{pinViews:t}=e;t.forEach((e=>{this.viewData.updatePin(e),this.pinRenderer.updatePin(e.id,e.pinType,e,e.backgroundTexture,e.visible),this.viewData.selectedPinId===e.id&&(this.viewData.updatePin(e),this.updateCurrentPin()),void 0!==e.opacity&&this.pinRenderer.setPinOpacity(e.id,e.opacity),void 0!==e.scale&&this.pinRenderer.setPinRenderOverrides(e.id,null,e.scale)}))},this.onChangePinVisibility=async e=>{const{id:t,pinType:i,visible:n}=e,s=this.viewData.getPin(t);if(s&&s.pinType===i){this.pinRenderer.setPinVisible(t,n);const{selectedPinId:e,focusedPin:i}=this.viewData;n||e!==t||this.changeSelectedPin(null),n||(null==i?void 0:i.id)!==t||this.viewData.setFocusedPin(null)}else this.log.debug(`Cannot change visibility of non-existent ${i} pin`)},this.onChangePinVisibilityByType=async e=>{const{pinType:t,visible:i}=e;this.pinRenderer.setPinTypeVisible(t,i)},this.onChangePinOpacity=async e=>{const{id:t,pinType:i,opacity:n}=e,s=this.viewData.getPin(t);s&&s.pinType===i?this.pinRenderer.setPinOpacity(t,n):this.log.debug(`Cannot change opacity of non-existent ${i} pin`)},this.onChangePinOpacityScale=async e=>{const{id:t,pinType:i,scale:n}=e,s=this.viewData.getPin(t);s&&s.pinType===i?this.pinRenderer.setPinOpacityScale(t,n):this.log.debug(`Cannot change opacity scaling of non-existent ${i} pin`)},this.onChangePinOpacityByType=async e=>{const{pinType:t,opacity:i,skipIds:n}=e;this.pinRenderer.fadePinOpacityByType(t,i,n)},this.onUnselectPin=async e=>{const{pinType:t,id:i}=e,{selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;(null==s?void 0:s.pinType)===t&&(null==s?void 0:s.id)===i&&this.changeSelectedPin(null)},this.clearPinSelection=async()=>{this.changeSelectedPin(null)},this.onStartPinCreation=async e=>{const{id:t,pin:i,pinType:n,backgroundTexture:s}=e,a=this.viewData,o=Object.assign(Object.assign({id:t,pinType:n},i),{backgroundTexture:s});a.setEditablePin(!0),a.setPinEditorState(H.V8.CREATING),this.changeSelectedPin(o),this.pinEditor.startPinCreation()},this.saveScreenPosition=e=>{const t=this.viewData;this.worldPosition.copy(e.anchorPosition).addScaledVector(e.stemNormal,e.stemLength);const i=(0,o.q9)(this.cameraData,this.worldPosition);t.setScreenPosition(i.ndcPosition.z>1?null:i.screenPosition)},this.onCameraUpdate=()=>{const{creatingNewPin:e,focusedPin:t,selectedPinId:i}=this.viewData,n=i?this.viewData.getPin(i):null;!e&&t?this.saveScreenPosition(t):n&&this.saveScreenPosition(n)},this.handleSweepChange=()=>this.handleSweepAndViewModeChange(),this.handleViewModeChange=()=>this.handleSweepAndViewModeChange(),this.cancelPinCreation=()=>{const{creatingNewPin:e,selectedPinId:t}=this.viewData;if(this.changeSelectedPin(null),t){const i=t?this.viewData.getPin(t):null;e&&i&&(this.engine.broadcast(new W.hu(i.id,i.pinType)),this.removePin(i.id,i.pinType),this.pinEditor.endPinCreation())}this.resetEditingState()},this.onPinPlacementCancelled=()=>{this.cancelPinCreation()},this.onCancelNewPin=async()=>{this.cancelPinCreation()},this.onViewChange=()=>{this.cancelPinCreation()},this.handleRemovingPin=async e=>{const{pinType:t,id:i}=e;this.removePin(i,t)},this.handleRemovingPinsByType=async e=>{const{pinType:t}=e,{focusedPin:i,selectedPinId:n}=this.viewData,s=n?this.viewData.getPin(n):null;(null==s?void 0:s.pinType)===t&&this.changeSelectedPin(null),(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePinsByType(t),this.pinRenderer.removePinsByType(t)},this.onTogglePinEditing=async e=>{const{id:t,editable:i}=e;this.viewData.getPin(t)&&this.viewData.setEditablePin(i)},this.onPinClicked=e=>{const{pinType:t,id:i}=e,{creatingNewPin:n,selectedPinId:s}=this.viewData,a=s?this.viewData.getPin(s):null,o=i===(null==a?void 0:a.id)&&t===(null==a?void 0:a.pinType);if(a&&o){if(n)return;this.changeSelectedPin(null)}else if(n)this.cancelPinCreation();else{if(!(i===(null==a?void 0:a.id)&&t===(null==a?void 0:a.pinType))){const e=this.viewData.getPin(i);e&&this.changeSelectedPin(e)}}},this.onHoverChanged=e=>{const{pinType:t,id:i,hovering:n}=e,{creatingNewPin:s,focusedPin:a,selectedPinId:o}=this.viewData;if(!s)if(n){const e=this.viewData.getPin(i);if(!e)return void this.log.debug("Cannot find pin to focus");const n=o?this.viewData.getPin(o):null;if(this.viewData.setFocusedPin(e),n&&n.id===i&&n.pinType===t)return;this.saveScreenPosition(e),this.pinRenderer.setPinColorVariantByType(t,H.K_.DEFAULT,null==a?void 0:a.id),this.pinRenderer.setPinColorVariant(i,H.K_.HIGHLIGHTED)}else a&&(this.pinRenderer.setPinColorVariant(a.id,H.K_.DEFAULT),this.viewData.setFocusedPin(null))},this.onSelectPin=async e=>{const{id:t,pinType:i,editable:n}=e,s=this.viewData,{selectedPinId:a,isPinEditable:o}=s;if(s.setPinEditorState(H.V8.IDLE),t===a&&n===o)return void this.log.debug("Pin is already selected");const r=this.viewData.getPin(t);r&&r.pinType===i?(s.setEditablePin(n),this.changeSelectedPin(r)):this.log.debug(`Cannot select ${i} pin`)},this.clickOffPin=async()=>{this.viewData.creatingNewPin||this.changeSelectedPin(null)},this.movePin=async e=>{const{isPinEditable:t,selectedPinId:i}=this.viewData;if(!t)return;const{pos:n,previousPos:s,id:a}=e,o=i?this.viewData.getPin(i):null;if(o&&o.id===a){const t=Object.assign(Object.assign({},o),e.pos);this.viewData.updatePin(t),this.updateCurrentPin(),this.engine.broadcast(new W.bV(o.id,o.pinType,n,s))}else this.log.debug("Cannot move the pin, not open for edit")},this.placePin=async e=>{const{isPinEditable:t,canPlace:i,selectedPinId:n}=this.viewData;if(!t)return;const s=n?this.viewData.getPin(n):null;s&&i?(this.viewData.setPinEditorState(H.V8.PLACED),this.engine.broadcast(new W.b0(s.id,s.pinType,s))):(this.log.debug("Cannot place pin because there is no open pin"),this.cancelPinCreation())}}async init(e,t){this.engine=t;const[i,n,s,o,r,g]=await Promise.all([t.getModuleBySymbol(a.PZ),t.getModuleBySymbol(a.Aj),t.market.waitForData(h.W),t.market.waitForData(d.pu),t.getModuleBySymbol(a.fQ),t.market.waitForData(Pe.R),document.fonts.ready]);this.input=i;const C={onClick:(e,i)=>{t.broadcast(new W.F7(e,i))},onHover:(e,i)=>{t.broadcast(new W.tP(e,!0,i)),t.commandBinder.issueCommand(new v.u(w.C.FINGER)),t.commandBinder.issueCommand(new y.y(!0))},onUnhover(e,i){t.broadcast(new W.tP(e,!1,i)),t.commandBinder.issueCommand(new v.u(null)),t.commandBinder.issueCommand(new y.y(!1))}},P=t.claimRenderLayer(this.name);this.pinRenderer=n.supportsInstancing()?new Ce(i,n.getCamera(),s,P,t.commandBinder,r,C,e.tagIconsEnabled):new ue(i,n.getCamera(),s,P,t.commandBinder,r,C,e.tagIconsEnabled),n.getScene().add(this.pinRenderer.container),t.addComponent(this,this.pinRenderer),[this.floorsViewData,this.viewmodeData,this.interactionmodeData,this.sweepData,this.cameraData]=await Promise.all([t.market.waitForData(l.c),t.market.waitForData(p.O),t.market.waitForData(c.Z),t.market.waitForData(u.Z),t.market.waitForData(m.M)]),this.viewData=new D.B,this.pinEditor=new Q(this.viewData,this.engine,this.input,this.pinRenderer),this.floorsViewData.iterate((e=>this.pinRenderer.getFloorContainer(e.id))),this.viewmode=this.viewmodeData.currentMode,this.bindings.push(t.commandBinder.addBinding(K.Ki,this.onEnablePinEditing),t.commandBinder.addBinding(K.Ar,this.onSelectPin),t.commandBinder.addBinding(K.RH,this.onUnselectPin),t.commandBinder.addBinding(K.iK,this.clearPinSelection),t.commandBinder.addBinding(K.yR,this.clickOffPin),t.commandBinder.addBinding(K.tE,this.onUpdatePin),t.commandBinder.addBinding(K.mE,this.onUpdatePinViews),t.commandBinder.addBinding(K.ik,this.onChangePinVisibility),t.commandBinder.addBinding(K.qN,this.onChangePinVisibilityByType),t.commandBinder.addBinding(K._Y,this.onChangePinOpacity),t.commandBinder.addBinding(K.nP,this.onChangePinOpacityScale),t.commandBinder.addBinding(K.kb,this.onChangePinOpacityByType),t.commandBinder.addBinding(K.fM,this.onStartPinCreation),t.commandBinder.addBinding(K.OL,this.handleRemovingPin),t.commandBinder.addBinding(K.zM,this.handleRemovingPinsByType),t.commandBinder.addBinding(K.I$,this.movePin),t.commandBinder.addBinding(K.ic,this.onTogglePinEditing),this.interactionmodeData.onChanged(this.visibilityChanged),this.floorsViewData.onChanged(this.visibilityChanged),this.viewmodeData.makeModeChangeSubscription(this.visibilityChanged),t.subscribe(b.Z,this.visibilityChanged),t.subscribe(T.a,this.viewmodeChanged),t.subscribe(f.Z,this.viewmodeChanged),t.subscribe(W.F7,this.onPinClicked),this.viewData.onPinEditorStateChanged(this.updateCurrentPin),this.viewData.onSelectedPinChanged(this.updateCurrentPin),this.viewData.onFocusedPinChanged(this.updateCurrentPin),this.viewData.onPinEditableChanged(this.updateCurrentPin),this.cameraData.onChanged(this.onCameraUpdate),g.onPropertyChanged("currentViewId",this.onViewChange)),this.touchDevice||this.bindings.push(t.subscribe(W.tP,this.onHoverChanged));let A=o.application;this.bindings.push(o.onPropertyChanged("application",(e=>{e!==A&&(this.visibilityChanged(),this.viewData.creatingNewPin?this.cancelPinCreation():(this.changeSelectedPin(null),this.viewData.setFocusedPin(null),this.resetEditingState()),A=e)}))),this.visibilityChanged(),t.market.register(this,D.B,this.viewData)}dispose(e){this.disableEditing(),this.pinEditor.dispose(),this.pinRenderer.dispose(),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.editBindings=[],super.dispose(e)}onUpdate(){this.editActivated&&this.pinEditor.update()}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}enableEditing(){if(!this.editActivated){if(this.editActivated=!0,this.pinEditor.toggleEditing(!0),0===this.editBindings.length){const e=this.engine,t=e.commandBinder;this.editBindings.push(t.addBinding(K.ip,this.placePin),t.addBinding(K.tT,this.onCancelNewPin),this.sweepData.makeSweepChangeSubscription(this.handleSweepChange),e.subscribe(f.Z,this.handleViewModeChange),e.subscribe(W.pe,this.onPinPlacementCancelled))}else this.editBindings.forEach((e=>{e.renew()}));this.handleSweepAndViewModeChange()}}disableEditing(){this.editActivated&&(this.editActivated=!1,this.pinEditor.toggleEditing(!1),this.cancelPinCreation(),this.editBindings.forEach((e=>{e.cancel()})))}changeSelectedPin(e){const{selectedPinId:t}=this.viewData;if(((null==e?void 0:e.id)||null)===t)return void this.log.debug("Pin selection did not change");(t?this.viewData.getPin(t):null)&&this.pinRenderer.hideSelectedMesh(),e?(this.saveScreenPosition(e),this.viewData.setSelectedPinId(e.id),this.pinRenderer.showSelectedMesh(e.pinType,e.id)):(this.viewData.setScreenPosition(null),this.viewData.setSelectedPinId(null))}handleSweepAndViewModeChange(){const e=this.viewData,t=!this.in360View();e.creatingNewPin&&!t?this.cancelPinCreation():e.setCanAdd(t)}resetEditingState(){const e=this.viewData;e.setPinEditorState(H.V8.IDLE),e.setEditablePin(!1),e.setCanPlace(!0),e.setCanAdd(!this.in360View())}removePin(e,t){const{focusedPin:i,selectedPinId:n}=this.viewData;n===e&&this.changeSelectedPin(null),(null==i?void 0:i.id)===e&&(null==i?void 0:i.pinType)===t&&this.viewData.setFocusedPin(null),this.viewData.removePin(e),this.pinRenderer.removePin(e)}}const Se=Ae},49657:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>m});var n,s=i(97542),a=i(92810),o=i(53954),r=i(46368),d=i(9699),h=i(39880);!function(e){e.None="none",e.Queued="queued",e.Rendering="loading",e.Rendered="loaded"}(n||(n={}));class l{constructor(e){this.panoRenderer=e,this.statusMap={},this.active=[],this.queued=[]}processQueued(){let e=0;for(const t of Object.keys(this.statusMap))this.statusMap[t]===n.Rendering&&e++;if(0===e&&this.queued.length>0){const e=this.queued.shift();if(e){this.active.push(e),this.statusMap[e]=n.Rendering;this.panoRenderer.activateSweep(e,!1).then((()=>{this.statusMap[e]=n.Rendered}))}}}tryPreRender(e){return this.getPreRenderState(e)===n.None&&(this.queued.push(e),this.statusMap[e]=n.Queued,!0)}getPreRenderState(e){const t=this.statusMap[e];return void 0!==t?t:n.None}cleanup(e=[]){const t=(0,h.ow)(e),i=[];for(const e of this.queued)t[e]?i.push(e):this.statusMap[e]=n.None;this.queued.length=0,this.queued.push(...i);const s=[];for(const e of this.active)t[e]?s.push(e):this.statusMap[e]=n.None;this.active.length=0,this.active.push(...s)}}var c=i(34029);class m extends s.Y{constructor(){super(...arguments),this.name="prerenderer-module",this.lastPrerendered=null}async init(e,t){[this.settings,this.sweepData]=await Promise.all([await t.market.waitForData(c.e),await t.market.waitForData(o.Z)]),this.panoRenderer=(await t.getModuleBySymbol(a.RR)).getRenderer(),this.preRenderer=new l(this.panoRenderer),this.bindings.push(t.subscribe(r.Z,(e=>this.onRestrictSweepsSet(e.sweepIds))),t.subscribe(d.Z,(()=>this.onRestrictedSweepsClear())))}enabled(){return this.settings.getOverrideParam("pre",true)}onUpdate(){this.enabled()&&this.preRenderer.processQueued()}getCurrentSweeps(){return this.currentRestrictedSweeps||[]}onRestrictSweepsSet(e){this.enabled()&&(this.lastPrerendered=null,e&&e.length>=3&&(this.lastPrerendered=e[2],this.preRenderer.tryPreRender(this.lastPrerendered)),this.cleanup(this.sweepData),this.currentRestrictedSweeps=e)}onRestrictedSweepsClear(){this.enabled()&&(this.cleanup(this.sweepData,!0),this.currentRestrictedSweeps=null)}cleanup(e,t=!1){const i=[];e.transition.active?(e.transition.from&&i.push(e.transition.from),e.transition.to&&i.push(e.transition.to)):e.currentSweep&&i.push(e.currentSweep),this.lastPrerendered&&i.push(this.lastPrerendered),t&&this.panoRenderer.freeAllTextures(i),this.preRenderer.cleanup(i)}}},74909:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(97542),s=i(92810),a=i(56692),o=i(92901),r=i(81396),d=i(35895),h=i(89570),l=i(67678),c=i(86819),m=i(72996);const u=new r.Vector2;class p{constructor(e,t){this.inputIni=e,this.rendererModule=t,this.registrations=new Map,this.hovered=new Map,this.checkPointerLeave=()=>{if(this.hovered.size){const e=y(this.inputIni.getCurrentRayHits());this.hovered.forEach(((t,i)=>{var n,s,a,o,r,d;if(!e.find((e=>e.object===i))){this.hovered.delete(i);const h=Object.assign(Object.assign({},t),{intersections:e});null===(a=null===(n=i.__r3f)||void 0===n?void 0:(s=n.handlers).onPointerOut)||void 0===a||a.call(s,h),null===(d=null===(o=i.__r3f)||void 0===o?void 0:(r=o.handlers).onPointerLeave)||void 0===d||d.call(r,h)}}))}},this.checkPointerMissed=()=>{var e,t,i;const n=new Set(this.inputIni.getCurrentRayHits().map((e=>e.object)));for(const s of this.registrations.keys())n.has(s)||null===(i=null===(e=s.__r3f)||void 0===e?void 0:(t=e.handlers).onPointerMissed)||void 0===i||i.call(t,new MouseEvent("click",this.lastPointerUp.nativeEvent))},this.handlers=[this.initMeshHandlers(),e.registerUnfilteredHandler(l.mE,this.checkPointerLeave),e.registerUnfilteredHandler(c.R,this.checkPointerMissed),e.registerUnfilteredHandler(l.er,(e=>{e.down?this.lastPointerDown=e:this.lastPointerUp=e}))]}dispose(){[...this.handlers,...this.registrations.values()].forEach((e=>e.cancel()))}registerObject3D(e){const t=this.registrations.get(e);if(t)return t;const i=(0,d.k1)((()=>{this.registrations.set(e,i),this.inputIni.registerMesh(e,!1,(t=>function(e){let t=e;for(;t&&!g(t);)t=t.parent;return t}(t)===e))}),(()=>{this.registrations.delete(e),this.hovered.delete(e),this.inputIni.unregisterMesh(e)}),!1);return i.renew(),i}initMeshHandlers(){const e=new WeakMap,t=(t,i,n)=>{var s,a,o,d,h,m,p,v,w,b,f,T;let D=null;for(let e=i;e;e=e.parent)g(e)&&(D||(D=[])).push(e);if(!D)return!1;const C=this.rendererModule.getCamera(),P=new r.Vector2(t.position.x,t.position.y);let A;n||(n=e.get(i)||{});let S=0;if(t instanceof c.R){const{x:e,y:t}=this.lastPointerDown.clientPosition,{x:i,y:n}=this.lastPointerUp.clientPosition;S=u.set(i-e,n-t).length(),A=new MouseEvent("click",this.lastPointerUp.nativeEvent)}else A=t.nativeEvent;const k=y(this.inputIni.getCurrentRayHits()),I={};for(const e in A)"function"!=typeof A[e]&&(I[e]=A[e]);const E=Object.assign(Object.assign(Object.assign({},I),n),{intersections:k,camera:C,delta:S,eventObject:i,nativeEvent:A,sourceEvent:A,pointer:P,ray:this.inputIni.getCurrentPointerRay(),stopPropagation:()=>{E.stopped=!0,this.handleStopPropagation(E.eventObject,k),t.stopPropagation(),t.preventDefault()},stopped:!1,unprojectedPoint:new r.Vector3(P.x,P.y,0).unproject(C),spaceX:P.x,spaceY:P.y});for(const i of D){e.set(i,n);const r=i.__r3f;if(r&&g(i)&&(E.eventObject=i,t instanceof l.er?t.down?null===(a=(s=r.handlers).onPointerDown)||void 0===a||a.call(s,E):null===(d=(o=r.handlers).onPointerUp)||void 0===d||d.call(o,E):t instanceof l.mE?(this.hovered.has(i)||(this.hovered.set(i,E),null===(m=(h=r.handlers).onPointerOver)||void 0===m||m.call(h,E),null===(v=(p=r.handlers).onPointerEnter)||void 0===v||v.call(p,E)),null===(b=(w=r.handlers).onPointerMove)||void 0===b||b.call(w,E)):t instanceof c.R&&(null===(T=(f=r.handlers).onClick)||void 0===T||T.call(f,E)),E.stopped))return!0}return!1},i=[l.er,l.mE,c.R];return new h.V(...i.map((e=>this.inputIni.registerMeshHandler(e,m.s.isAny(),t))))}handleStopPropagation(e,t){if(this.hovered.has(e)){const i=t.findIndex((t=>t.object===e));if(i>-1){const e=[];for(let n=i+1;n<t.length;n++)for(let i=t[n].object;i;i=i.parent){const t=this.hovered.get(i);t&&e.push({obj:i,origEvent:t})}e.forEach((({obj:e,origEvent:i})=>{var n,s,a;const o=Object.assign(Object.assign({},i),{intersections:t,eventObject:e});this.hovered.delete(e);const r=null===(n=e.__r3f)||void 0===n?void 0:n.handlers;null===(s=null==r?void 0:r.onPointerOut)||void 0===s||s.call(r,o),null===(a=null==r?void 0:r.onPointerLeave)||void 0===a||a.call(r,o)}))}}}}function g(e){const t=e.__r3f;return!!t&&(t.hasOwnProperty("eventCount")?(t.eventCount||0)>0:t.handlers&&Object.keys(t.handlers).length>0)}function y(e){const t=new Set;return e.filter((e=>{const i=t.has(e.object);return t.add(e.object),!i}))}class v extends n.Y{constructor(){super(...arguments),this.name="react-three-fiber-external",this.onPlayerResized=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onSizeChange(e.width,e.height)},this.onPixelRatioChanged=e=>{var t;null===(t=this.externalCallbacks)||void 0===t||t.onPixelRatioChange(e.pixelRatio)}}async init(e,t){this.bindings.push(t.subscribe(a.a,this.onPlayerResized),t.subscribe(o.Vx,this.onPixelRatioChanged));const[i,n]=await Promise.all([t.getModuleBySymbol(s.PZ),t.getModuleBySymbol(s.Aj)]);this.rendererModule=n,this.eventsAdapter=new p(i,n)}dispose(e){this.eventsAdapter.dispose(),super.dispose(e)}onUpdate(e){var t;null===(t=this.externalCallbacks)||void 0===t||t.onFrame()}registerExternalR3F(e){if(this.externalCallbacks)throw new Error("registerExternalR3F called twice");return this.externalCallbacks=e,{renderer:this.rendererModule.threeRenderer,scene:this.rendererModule.getScene().scene,camera:this.rendererModule.getCamera(),registerMeshEvents:e=>this.eventsAdapter.registerObject3D(e)}}}},74642:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>v});var n=i(97542),s=i(61864),a=i(92810),o=i(5332),r=i(17878),d=i(31362),h=i(41603),l=i(68191),c=i(81396),m=i(41187),u=i(23254),p=i(41326),g=i(64918),y=i(95882);class v extends n.Y{constructor(){super(...arguments),this.name="screenshots-module",this.capturer=new w}async init(e,t){this.engine=t,[this.settingsModule,this.canvas,this.renderer,this.renderToTexture]=await Promise.all([t.getModuleBySymbol(s.Ak),t.market.waitForData(o.W),t.getModuleBySymbol(a.Aj),t.getModuleBySymbol(a.tA)]),this.settingsModule.registerButton("Debug","Take screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,r.o.ALL)})),this.settingsModule.registerButton("Debug","Take 4k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:2304,width:4096},`image_${e}.jpg`,r.o.ALL)})),this.settingsModule.registerButton("Debug","Take 8k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:4608,width:8192},`image_${e}.jpg`,r.o.ALL)})),this.settingsModule.registerButton("Debug","Take 16k screenshot",(async()=>{const e=Date.now();await this.takeAndDownloadScreenshot({height:9e3,width:16e3},`image_${e}.jpg`,r.o.ALL)})),this.settingsModule.registerButton("Debug","Take FB 3D screenshot",(async()=>{const e=Date.now(),t=this.engine.getRenderLayer("model-mesh"),i=this.engine.getRenderLayer("skybox"),n=t.clone();n.addLayers(i);const s=(await this.engine.market.waitForData(u.O)).currentMode;try{await this.takeAndDownloadScreenshot({height:this.canvas.height,width:this.canvas.width},`image_${e}.jpg`,n),await this.engine.commandBinder.issueCommand(new l.U(l.U.modes.Depth)),await this.engine.commandBinder.issueCommand(new p._i(p.BD.MESH,g.n.Instant)),await this.takeAndDownloadScreenshot({height:Math.floor(this.canvas.height/4),width:Math.floor(this.canvas.width/4)},`image_${e}_depth.jpg`,t)}catch(e){throw this.log.error("Could not take screenshot"),e}finally{await this.engine.commandBinder.issueCommand(new l.U(null)),await this.engine.commandBinder.issueCommand(new p._i(p.KP[s||y.Ey.Panorama]))}}))}async takeAndDownloadScreenshot(e,t,i){this.renderTarget||(this.renderTarget=await this.engine.commandBinder.issueCommandWhenBound(new m.oM));const n=await this.capturer.capture(i,e,this.renderer,this.renderToTexture,this.renderTarget);(0,d.Hx)((0,h.Xk)(n),t)}}class w{constructor(){this.captureCamera=new c.PerspectiveCamera}async capture(e,t,i,n,s){const{camera:a,scene:o}=i.getScene();return a.getWorldPosition(this.captureCamera.position),a.getWorldQuaternion(this.captureCamera.quaternion),this.captureCamera.projectionMatrix.copy(a.projectionMatrix),this.captureCamera.layers.mask=e.mask,s.setSize(t.width,t.height),n.render(s.target,o,this.captureCamera),await(0,h.vP)(s)}}},56163:(e,t,i)=>{"use strict";i.d(t,{K:()=>r});var n=i(52528),s=i(71166),a=i(63319);const o=new n.v({});class r{constructor(e,t,i){this.commandBinder=e,this.layersData=t,this.dataTypeGroup=i,this.textParser=o,this.enabled=!0,this.bindings=[]}getGroupingId(e){switch(e){case a.HH.TYPE:return this.getTypeId();case a.HH.FLOOR:return this.getFloorId();case a.HH.ROOM:return this.getRoomId();case a.HH.LAYER:return this.getLayerGroupId();case a.HH.DATE:return this.dateBucket}}getFloorId(){return this.floorId}getRoomId(){return this.roomId}getDateBucket(){return this.dateBucket}getTypeId(){return this.typeId}supportsBatchDelete(){return!1}supportsLayeredCopyMove(){return!1}getLayerGroupId(){var e,t;const i=null===(e=this.layersData)||void 0===e?void 0:e.getBaseLayerId(),n=null===(t=this.layersData)||void 0===t?void 0:t.getViewLayerId();return this.layerId&&n&&this.layerId===i?n:this.layerId}isLayerVisible(){return!this.layersData||!this.layerId||this.layersData.layerVisible(this.layerId)}onSelect(e,t,i){this.commandBinder.issueCommand(new s.IL(this.id,this.typeId))}registerBindings(){}cancelBindings(){this.bindings.forEach((e=>e.cancel()))}}},36375:(e,t,i)=>{"use strict";i.d(t,{k:()=>a});var n=i(73085),s=i(29883);const a=(0,n.M)(s.T,"activeItemId",null)},48781:(e,t,i)=>{"use strict";i.r(t),i.d(t,{ChangeSearchGroupingCommand:()=>S.SN,ClearSearchFiltersCommand:()=>S.Hf,DeregisterSearchGroupCommand:()=>S.Pe,RegisterSearchGroupCommand:()=>S.c6,SelectSearchResultCommand:()=>S.IL,ToggleSearchFilterCommand:()=>S.Mp,ToggleSearchQueryKeywordCommand:()=>S.M8,UpdateSearchQueryCommand:()=>S.H1,UpdateSearchQueryKeywordsCommand:()=>S.FZ,default:()=>Ie});var n=i(97542),s=i(92810),a=i(38399),o=i(80361),r=i(10374),d=i(54244),h=i(34029),l=i(39866),c=i(91380),m=i(76631),u=i(89549),p=i(50892),g=i(62436);class y{constructor(e){this.engine=e}async activate(){await this.engine.commandBinder.issueCommandWhenBound(new g.O(!0,!1,!1))}async deactivate(){await this.engine.commandBinder.issueCommandWhenBound(new g.O(!1,!1,!1))}}var v=i(85893),w=i(67294),b=i(33558),f=i(66102),T=i(73085),D=i(29883);const C=(0,T.M)(D.T,"grouping",D.T.defaultGrouping);var P=i(46362),A=i(36375),S=i(71166),k=i(25071),I=i(84426),E=i(51978);const O=(0,T.M)(D.T,"searchMode",!1);var N=i(38242),M=i(76087),x=i(63319);const{SEARCH:B}=a.Z.SHOWCASE;function V({phraseKeys:e={},grouping:t,onGroupBy:i}){const n=(0,f.b)(),s=(0,E.y)(M.Wp,!1),a=O(),o=[x.HH.DATE,x.HH.FLOOR];"boolean"==typeof a&&o.unshift(x.HH.TYPE),s&&o.push(x.HH.LAYER);const r=n.t(L(t,!0,e));return(0,v.jsx)(I.xz,Object.assign({className:"grouping-sort-menu-button",ariaLabel:r,variant:I.Wu.TERTIARY,label:r,caret:!0},{children:o.map((t=>(0,v.jsx)(R,{onGroupBy:i,grouping:t,phraseKeys:e},t)))}))}function R({grouping:e,onGroupBy:t,phraseKeys:i={}}){const{analytics:n}=(0,w.useContext)(b.I),s=(0,f.b)().t(L(e,!1,i)),a=(0,N.e)();return(0,v.jsx)(I.zx,{label:s,size:I.qE.SMALL,variant:I.Wu.TERTIARY,onClick:()=>{t(e),n.trackGuiEvent(`items_group_by_${e}`,{tool:a})}},e)}function L(e,t,i){var n,s,a,o,r,d,h,l,c,m;switch(e){case x.HH.TYPE:return t?(null===(n=i[x.HH.TYPE])||void 0===n?void 0:n.selectedTextKey)||B.GROUP_TYPE_SELECTED:(null===(s=i[x.HH.TYPE])||void 0===s?void 0:s.textKey)||B.GROUP_TYPE;case x.HH.FLOOR:return t?(null===(a=i[x.HH.FLOOR])||void 0===a?void 0:a.selectedTextKey)||B.GROUP_FLOOR_SELECTED:(null===(o=i[x.HH.FLOOR])||void 0===o?void 0:o.textKey)||B.GROUP_FLOOR;case x.HH.ROOM:return t?(null===(r=i[x.HH.ROOM])||void 0===r?void 0:r.selectedTextKey)||B.GROUP_ROOM_SELECTED:(null===(d=i[x.HH.ROOM])||void 0===d?void 0:d.textKey)||B.GROUP_ROOM;case x.HH.LAYER:return t?(null===(h=i[x.HH.LAYER])||void 0===h?void 0:h.selectedTextKey)||B.GROUP_LAYER_SELECTED:(null===(l=i[x.HH.LAYER])||void 0===l?void 0:l.textKey)||B.GROUP_LAYER;case x.HH.DATE:default:return t?(null===(c=i[x.HH.DATE])||void 0===c?void 0:c.selectedTextKey)||B.GROUP_DATE_SELECTED:(null===(m=i[x.HH.DATE])||void 0===m?void 0:m.textKey)||B.GROUP_DATE}}var F=i(43013),H=i(94184),j=i.n(H),U=i(43470),z=i(6335),G=i(6608);function _({item:e}){const{imgUrl:t,color:i,icon:n}=e;return t?(0,v.jsx)(z.X,{className:"thumbnail-image",resource:t}):n?(0,v.jsx)(G.C,{badgeStyle:void 0!==i?{background:i,borderColor:i}:{},iconClass:n}):null}var $=i(77230),K=i(16589),W=i(44472);function Z({item:e}){const{textParser:t,title:i,description:n}=e,s=(0,$.A)();let a=i;a&&(a=(0,K.vr)(a,s));let o=n;return o&&(o=(0,K.zf)(o,s)),(0,v.jsxs)("div",Object.assign({className:"item-details"},{children:[(0,v.jsx)("div",Object.assign({className:"item-header"},{children:(0,v.jsx)(W.S,{text:a||"",textParser:t,markers:K.PP})})),t&&(0,v.jsx)("div",Object.assign({className:"item-description"},{children:(0,v.jsx)(W.S,{text:o||"",textParser:t,markers:K.PP})}))]}))}const{SEARCH:q}=a.Z.SHOWCASE,J=({item:e})=>{const t=(0,f.b)();if(!e){const e=t.t(q.EMPTY_LIST_MESSAGE);return(0,v.jsx)(I.gQ,{message:e})}const{dataTypeGroup:i}=e;return(null==i?void 0:i.itemFC)?(0,v.jsx)(i.itemFC,{item:e}):(0,v.jsx)(Y,{item:e},e.id)};function Y({item:e,className:t}){const i=(0,A.k)(),n=e.id,s=!!i&&n===i,{analytics:a,commandBinder:o}=(0,w.useContext)(b.I),r=(0,v.jsx)(_,{item:e}),d=(0,v.jsx)(Z,{item:e});return(0,v.jsx)(I.HC,{id:n,className:j()("search-result-item",t),title:d,active:s,disabled:!e.enabled,onClick:async()=>{const t="search_item_"+e.typeId.toLowerCase()+"_click";a.track("showcase_gui",{tool:"search",gui_action:t}),o.issueCommand(new u.qy(!0)),await o.issueCommand(new U.yL),e.onSelect()},badge:r||void 0},n)}var Q=i(41407),X=i(32279),ee=i(37190),te=i(49571),ie=i(43363);function ne({id:e,icon:t,label:i,selected:n}){const{commandBinder:s,analytics:a}=(0,w.useContext)(b.I),o=(0,N.e)();return(0,v.jsx)(ie.e,{id:e,icon:t,label:i,selected:n,onToggled:t=>{t.stopPropagation(),"ALL"===e?n||s.issueCommand(new S.Hf):s.issueCommand(new S.Mp(e,!n)),n||a.trackGuiEvent(`items_filter_by_${e.toLowerCase()}`,{tool:o})}})}var se=i(38490);i(11213);const{SEARCH:ae}=a.Z.SHOWCASE;function oe(){const e=(0,f.b)(),t=Object.values((0,X.b)()),i=(0,ee.b)(),n=0===i.length,s=(0,w.useRef)(null),a=t.sort(((e,t)=>(e.groupOrder||te.Xs)-(t.groupOrder||te.Xs))).map((t=>{const{id:s,groupIcon:a,groupPhraseKey:o}=t,r=e.t(o),d=!n&&i.includes(s);return(0,v.jsx)(ne,{id:s,icon:a,label:r,selected:d},s)})),o=e.t(ae.FILTER_SEARCH),r=e.t(ae.FILTER_SEARCH_ALL);return(0,v.jsx)("div",Object.assign({className:"search-filter",onClick:e=>e.stopPropagation()},{children:(0,v.jsxs)(I.xz,Object.assign({ariaLabel:e.t(ae.FILTER_SEARCH_LABEL),ref:s,icon:"filter",variant:I.Wu.TERTIARY,size:I.qE.SMALL,menuClassName:"search-filter-menu"},{children:[(0,v.jsxs)("div",Object.assign({className:"search-filter-menu-header"},{children:[(0,v.jsx)("div",{children:o}),(0,v.jsx)(se.P,{onClose:()=>{s.current&&s.current.closeMenu()}})]})),(0,v.jsx)(ne,{id:"ALL",icon:"fullscreen",label:r,selected:n}),a]}))}))}var re=i(71282),de=i(70704);const{SEARCH:he}=a.Z.SHOWCASE;function le(){const{commandBinder:e}=(0,w.useContext)(b.I),t=C(),i=(0,P.s)(),n=(0,A.k)(),s=(0,f.b)();const a=i.length,o=s.t(he.ITEMS,a),r=s.t(he.EMPTY_LIST_MESSAGE),d=(0,v.jsx)(re.B,{filter:(0,v.jsx)(oe,{}),filterPills:!0,shareEnabled:!0});return(0,v.jsxs)(de.L,Object.assign({toolId:m.w1.SEARCH,className:"search-tool-panel",title:o,subheader:d,subheaderCollapsedHeight:k.vH},{children:[(0,v.jsx)(I.w0,Object.assign({className:"list-panel-controls"},{children:(0,v.jsx)(V,{grouping:t,onGroupBy:function(t){e.issueCommand(new S.SN(t))}})})),(0,v.jsx)("div",Object.assign({className:"panel-list search-panel-list"},{children:0===a?(0,v.jsx)(I.gQ,{message:r}):(0,v.jsx)(Q.D,{renderGroup:F.v,renderItem:J,activeItemId:n,grouping:t,excludeEmptyGroups:!0})}))]}))}var ce=i(36676);const me=(e,t)=>Number(t.isSelected)-Number(e.isSelected)||e.text.localeCompare(t.text),ue={fixtures:"KEYWORDS_FIXTURES"};function pe(){const e=(0,f.b)(),t=function(){const e=(0,ce.s)(),[t,i]=(0,w.useState)((null==e?void 0:e.getKeywordSummaries())||[]);return(0,w.useEffect)((()=>{if(!e)return()=>{};function t(){e&&i(e.getKeywordSummaries())}const n=e.keywordCounts.onChanged(t),s=e.keywordFilters.onChanged(t);return t(),()=>{n.cancel(),s.cancel()}}),[e]),t}();return(0,w.useMemo)((()=>t.map((t=>Object.assign(Object.assign({},t),{text:ue[t.id]?e.t(ue[t.id]):t.text}))).sort(me)),[t,e])}const ge=()=>{const e=pe(),t=function(e,t){const{engine:i}=(0,w.useContext)(b.I);return(0,w.useCallback)(((...n)=>{const s=t?Array.isArray(t)?t:t(...n):[];i.commandBinder.issueCommand(new e(...s))}),[e,t,i])}(S.M8,(e=>[e.id]));return(0,v.jsx)(I.no,{className:"search-keyword-summary",tokens:e,onTokenClick:t,maxVisibleTruncated:5,allowSelect:!0})};var ye=i(77543),ve=i(8659),we=i(51588),be=i(40216),fe=i(15501);function Te(){const e=(0,we.E)(),t=(0,be.T)(),i=t===m.wS.NARROW||t===m.wS.BOTTOM_PANEL,n=!e&&t===m.wS.BOTTOM_PANEL;return(0,fe.R)()&&n?null:(0,v.jsx)("div",Object.assign({className:"search-tool-overlay"},{children:i?(0,v.jsx)(ye.Z,Object.assign({direction:ve.Nm.horizontal},{children:(0,v.jsx)(ge,{})})):(0,v.jsx)(ge,{})}))}class De{constructor(){this.renderPanel=()=>(0,v.jsx)(le,{}),this.renderOverlay=()=>(0,v.jsx)(Te,{})}}function Ce(...e){return!0}function Pe(...e){return!1}class Ae{constructor(e){this.searchData=e,this.subscriptions=[],this.isSearchingGroup=e=>{const t=this.searchData.searchMode;return!0===t||t===e},this.onFiltersChanged=()=>{this.updateAvailableKeywords(),this.clearUnavailableKeywordFilters(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()},this.updateAvailableKeywords=()=>{const e=this.getActiveSearchDataTypeList().reduce(((e,{getKeywords:t})=>{if(t){t().forEach((t=>{e[t]?e[t]++:e[t]=1}))}return e}),{});this.searchData.setKeywordCounts(e)},this.updateMatches=e=>{const{id:t,getSimpleMatches:i}=e,n=this.searchData.getTypeFilters(),s=this.searchData.getQuery(),a=0===n.length||n.includes(t)?function(e){if(!e)return Ce;const t=e.toLowerCase();return(...e)=>function(e,...t){return t.some((t=>t.toLowerCase().includes(e)))}(t,...e)}(s):Pe,o=this.searchData.getKeywordFilters();e.matches=i(a,e,s,o)},this.activationChanged=e=>{e?this.updateAllMatchesAndResults():this.searchData.getSearchDataTypeList().forEach(this.revealItems)},this.revealItems=e=>{e.getSimpleMatches(Ce,e,"",[])},this.updateAllMatchesAndResults=(0,o.D)((()=>{this.updateAvailableKeywords(),this.searchData.getSearchDataTypeList().forEach(this.updateMatches),this.updateResults()}),200),this.subscriptions.push(e.onPropertyChanged("query",this.updateAllMatchesAndResults),e.onPropertyChanged("keywordFilters",this.updateAllMatchesAndResults),e.onPropertyChanged("searchMode",this.activationChanged),e.typeFilters.onChanged(this.onFiltersChanged))}dispose(){const e=e=>e.cancel();this.subscriptions.forEach(e),this.searchData.getSearchDataTypeList().forEach((t=>t.subscriptions.forEach(e)))}registerSearchGroup(e,t,i){const n=()=>{this.updateMatches(e),this.updateResults(),this.updateAvailableKeywords()};let s=!1,a=!1;const r=(0,o.D)((()=>{a?(n(),s=!1):s=!0}),200);t&&e.subscriptions.push(t(r));const d=t=>{const n=a;a=this.isSearchingGroup(e.id),i&&n!==a&&i(a&&t),a&&s&&r()};e.subscriptions.push(this.searchData.onPropertyChanged("searchMode",d)),d(this.searchData.searchMode)}deregisterSearchGroup(e){e.subscriptions.forEach((e=>e.cancel())),this.updateResults()}clearUnavailableKeywordFilters(){const e=this.searchData.getTypeFilters().length>0,t=this.getActiveSearchDataTypeList().find((e=>!!e.getKeywords));e&&!t&&this.searchData.setKeywordFilters([])}getActiveSearchDataTypeList(){const e=this.searchData.typeFilters;return this.searchData.getSearchDataTypeList().filter((t=>0===e.length||e.includes(t.id)))}updateResults(){const e=this.searchData.getSearchDataTypeList().reduce(((e,t)=>(e.push(...t.matches),e)),[]);this.searchData.setResults(e)}}const{TOOLS:Se}=a.Z;class ke extends n.Y{constructor(){super(...arguments),this.name="search",this.searchData=new D.T,this.deactivateTimeout=0,this.hasStartedTrackingQueries=!1,this.onApplicationChange=async()=>{this.updateFeatureEnablement()},this.registerSearchGroup=async e=>{const{id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:s,getKeywords:a,groupOrder:o,groupIcon:r,registerChangeObserver:d,onSearchActivatedChanged:h,itemFC:l,itemActionsFC:c,groupActionsFC:m,batchSupported:u=!1}=e;if(this.searchData.dataTypeGroups[t])return void this.log.debug("Search group already registered");const p={id:t,groupPhraseKey:i,groupMatchingPhraseKey:n,getSimpleMatches:s,getKeywords:a,groupOrder:o,groupIcon:r,matches:[],subscriptions:[],itemFC:l,itemActionsFC:c,groupActionsFC:m,batchSupported:u};this.searchData.dataTypeGroups[t]=p,this.searchResultsUpdater.registerSearchGroup(p,d,h)},this.deregisterSearchGroup=async e=>{const{id:t}=e,i=this.searchData.dataTypeGroups[t];i?(delete this.searchData.dataTypeGroups[t],this.searchResultsUpdater.deregisterSearchGroup(i)):this.log.debug("Search group not found to deregister")},this.updateQuery=async e=>{this.searchData.setQuery(e.query),this.searchData.commit()},this.updateQueryKeywords=async e=>{this.searchData.setKeywordFilters(e.keywords)},this.toggleQueryKeyword=async({keywordId:e})=>{const t=[...this.searchData.getKeywordFilters()];t.includes(e)?t.splice(t.indexOf(e),1):t.push(e),this.searchData.setKeywordFilters(t)},this.selectSearchResult=async e=>{const{id:t,typeId:i}=e,{activeItemId:n,selectedType:s}=this.searchData;t===n&&i===s||(this.searchData.activeItemId=t,this.searchData.selectedType=t&&i||null,this.searchData.commit())},this.changeGrouping=async e=>{this.searchData.grouping=e.grouping,this.searchData.commit()},this.toggleSearchFilter=async e=>{const{groupId:t,enabled:i}=e;this.searchData.toggleSearchFilter(t,i);this.searchData.getTypeFilters().length===Object.keys(this.searchData.dataTypeGroups).length&&this.searchData.clearTypeFilters()},this.onToolChanged=()=>{const e=this.toolsData.getActiveTool(),t=null==e?void 0:e.searchModeType;if(window.clearTimeout(this.deactivateTimeout),t){const e="string"==typeof t?t:void 0;this.activateSearchMode(e),e?this.searchData.setTypeFilter(e):this.searchData.clearTypeFilters()}else this.deactivateSearchMode()},this.trackQuery=(0,o.D)((()=>{const e=this.searchData.query.substring(0,1e3),t=this.searchData.getKeywordFilters().map((e=>e.trim())).sort().join(",");if(!e&&!t)return;const i=!this.hasStartedTrackingQueries&&e===this.config.urlQuery;this.analytics.track("space_search_queried",{query:e,queryKeywords:t,submittedByUrlParam:i}),this.hasStartedTrackingQueries=!0}),1e3)}async init(e,t){if(this.config=e,this.engine=t,[this.toolsData,this.appData,this.settingsData,this.analytics]=await Promise.all([t.market.waitForData(c.t),t.market.waitForData(d.pu),t.market.waitForData(h.e),t.getModuleBySymbol(s.V6)]),this.bindings.push(t.subscribe(r.bS,this.onApplicationChange),this.searchData.onPropertyChanged("query",this.trackQuery),this.searchData.onPropertyChanged("keywordFilters",this.trackQuery),this.toolsData.onPropertyChanged("activeToolName",this.onToolChanged),t.commandBinder.addBinding(S.H1,this.updateQuery),t.commandBinder.addBinding(S.FZ,this.updateQueryKeywords),t.commandBinder.addBinding(S.M8,this.toggleQueryKeyword),t.commandBinder.addBinding(S.SN,this.changeGrouping),t.commandBinder.addBinding(S.Mp,this.toggleSearchFilter),t.commandBinder.addBinding(S.Hf,(async()=>this.searchData.clearTypeFilters())),t.commandBinder.addBinding(S.IL,this.selectSearchResult),t.commandBinder.addBinding(S.c6,this.registerSearchGroup),t.commandBinder.addBinding(S.Pe,this.deregisterSearchGroup)),this.searchResultsUpdater=new Ae(this.searchData),this.updateFeatureEnablement(),(0,l.J)(this.settingsData)&&(void 0!==e.urlQuery||void 0!==e.urlQueryKeywords||void 0!==e.urlQueryFilters)){const t=decodeURIComponent(e.urlQuery||"");this.searchData.setQuery(t),this.searchData.commit();const i=decodeURIComponent(e.urlQueryFilters||"").trim(),n=i?i.split(","):[];n.length>0&&this.searchData.setTypeFilters(n);const s=decodeURIComponent(e.urlQueryKeywords||"").trim(),a=s?s.split(","):[];a.length>0&&this.searchData.setKeywordFilters(a);const o=this.toolsData.getTool(m.w1.LAYERS)?m.w1.LAYERS:m.w1.SEARCH;this.engine.commandBinder.issueCommand(new u.tT(o,!0))}t.market.register(this,D.T,this.searchData)}dispose(e){super.dispose(e),window.clearTimeout(this.deactivateTimeout),this.searchResultsUpdater&&this.searchResultsUpdater.dispose()}updateFeatureEnablement(){if(!(this.appData.application===d.Mx.WORKSHOP)&&(0,l.J)(this.settingsData)&&!this.toolsData.getTool(m.w1.SEARCH)){const e=new p.U({id:m.w1.SEARCH,searchModeType:!0,namePhraseKey:Se.SEARCH,panel:!0,panelLeft:!0,icon:"icon-magnifying-glass",analytic:"search",dimmed:!1,enabled:!0,hidesAppBar:!0,order:1,ui:new De,manager:new y(this.engine)});this.engine.commandBinder.issueCommand(new u.MV([e]))}}activateSearchMode(e){const t=e||!0;this.searchData.searchMode!==t&&(this.searchData.searchMode=t,this.searchData.commit())}deactivateSearchMode(){this.searchData.searchMode&&(this.searchData.setKeywordFilters([]),this.searchData.searchMode=!1,this.searchData.activeItemId=null,this.searchData.commit(),this.deactivateTimeout=window.setTimeout((()=>{this.searchData.clearTypeFilters()}),300))}}const Ie=ke},76979:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>z});var n,s=i(97542),a=i(92810),o=i(17878),r=i(53954),d=i(9037),h=i(95882),l=i(23254),c=i(41187),m=i(41603),u=i(76609),p=i(27646),g=i(71239),y=i(69505),v=i(90304),w=i(73121),b=i(39880),f=i(37082),T=i(68717),D=i(50090),C=i(79727),P=i(63252),A=i(12039),S=i(8728);!function(e){e.CAPTURING="capturing",e.UPLOADING="uploading",e.ERROR="error",e.DONE="done"}(n||(n={}));var k=i(58368),I=i(66917),E=i(91380),O=i(76631),N=i(98010);class M extends N.v0{constructor(e){super(),this.error=e}}var x=i(2224);class B extends x.y{constructor(e,t="72002"){super(e,t),this.name="SnapshotCaptureError"}}class V extends x.y{constructor(e,t="73002"){super(e,t),this.name="SnapshotUploadError"}}class R extends x.y{constructor(e,t="74002"){super(e,t),this.name="SnapshotEncodingError"}}var L=i(19663);const F=16/9;class H extends L.m{constructor(e){super(),this.id="CAPTURE_SNAPSHOT",this.payload={maxSize:e.maxSize||u.SL.ULTRAHIGH,aspect:e.aspect||F,category:e.category||D.i.USER,onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}class j extends L.m{constructor(e){super(),this.id="EQUIRECTANGULAR_SNAPSHOT",this.payload={onProgress:e.onProgress,waitForUpload:void 0===e.waitForUpload||e.waitForUpload}}}const U=g.Xd.uploadIntervalDelay;class z extends s.Y{constructor(){super(...arguments),this.name="snapshots-editor"}async init(e,t){this.engine=t,[this.renderer,this.sweepRenderer]=await Promise.all([t.getModuleBySymbol(a.Aj),t.getModuleBySymbol(a.RR)]),[this.sweepData,this.viewmodeData,this.cameraData,this.floorsViewData]=await Promise.all([t.market.waitForData(r.Z),t.market.waitForData(l.O),t.market.waitForData(d.M),t.market.waitForData(C.c),t.market.waitForData(T.P)]),[this.snapshotTarget,this.snapshotOverlayTarget]=await Promise.all([t.commandBinder.issueCommandWhenBound(new c.oM),t.commandBinder.issueCommandWhenBound(new c.oM)]);const i=await t.market.waitForData(E.t);this.bindings.push(i.onPropertyChanged("activeToolName",this.onToolChanged.bind(this)),t.commandBinder.addBinding(H,this.onCaptureSnapshotCommand.bind(this)),t.commandBinder.addBinding(j,this.onCaptureEquirectCommand.bind(this)))}onToolChanged(e){this.sweepRenderer.setPreloadQuality(e===O.w1.PHOTOS||e===O.w1.START_LOCATION?this.sweepRenderer.enum.resolution.ULTRAHIGH:null)}async onCaptureEquirectCommand(e){const t=e.onProgress||(0,f.Y)(0);t.value=10,this.engine.commandBinder.issueCommand(new A.ZK),await(0,b.gw)(50);const i=this.sweepData.currentSweepObject;if(!i)throw new B("Equirectangular capture is only supported in Panorama mode");const n=this.queryIdealEqResolution();this.snapshotTarget.setSize(n.width,n.height);const s=v.fU.FORWARD.clone().applyQuaternion(i.rotation).setY(0),a=v.fU.FORWARD.clone().applyQuaternion(this.cameraData.pose.rotation).setY(0),o=(0,w.k2)(s,a)+Math.PI;await this.fetchHighestAvailable(!0,u.SL.ULTRAHIGH,(e=>t.value=Math.max(10,e))),await this.takeEquirectangular(o),await this.sweepRenderer.resetSweep(i.id),this.engine.commandBinder.issueCommand(new A.Lp);const r=(0,m.fY)(this.snapshotTarget.width,this.snapshotTarget.height,o,0),d=this.uploadAndAddSnapshot(D.i.PANORAMA,r).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new M(e)),e}));return e.waitForUpload?d:null}async onCaptureSnapshotCommand(e){const t=e.onProgress||(0,f.Y)(0);t.value=10,this.engine.commandBinder.issueCommand(new A.ZK),this.engine.commandBinder.issueCommand(new I.M);const i=this.queryIdealResolution(e.maxSize,e.aspect);this.snapshotTarget.setSize(i.width,i.height),this.snapshotOverlayTarget.setSize(i.width,i.height),await this.fetchHighestAvailable(!1,e.maxSize,(e=>t.value=Math.max(10,e))),await(0,b.gw)(2*U),await this.takeScreenshot();const n=this.sweepData.currentSweepObject;n&&this.viewmodeData.currentMode===h.Ey.Panorama&&await this.sweepRenderer.resetSweep(n.id),this.engine.commandBinder.issueCommand(new A.Lp),this.engine.commandBinder.issueCommand(new I.I);let s=e.category;n&&(n.alignmentType===P.z9.UNALIGNED||n.placementType===P.hU.MANUAL)&&s===D.i.USER&&(s=D.i.UNALIGNED);const a=this.uploadAndAddSnapshot(s).then((e=>e&&e.sid)).catch((e=>{throw this.log.error(e),this.engine.broadcast(new M(e)),e}));return e.waitForUpload?a:null}async uploadAndAddSnapshot(e,t){const i=this.createSnapshot(e);i.state=n.CAPTURING;try{const e=await(0,m.vP)(this.snapshotTarget,t);i.imageBlob=(0,m.Xk)(e)}catch(e){throw i.state=n.ERROR,this.log.error(e),new R(e)}i.state=n.UPLOADING;try{const e=await this.engine.commandBinder.issueCommand(new k.nM(i));if(!e)throw i.state=n.ERROR,this.log.error("Exception during snapshot upload"),new V("Exception during snapshot upload");return i.state=n.DONE,e}catch(e){throw i.state=n.ERROR,this.log.error(e),new V(e)}}createSnapshot(e){var t;const i=this.viewmodeData.isInside(),n=this.sweepData.currentSweep;let s=(0,b.DZ)(new Date);if(n&&i){const e=this.sweepData.getSweep(n).name;e&&(s=e)}const a=new S.a;return a.name=s,a.category=e,a.is360=i&&!this.sweepData.currentAlignedSweepObject,a.metadata={cameraMode:null!==(t=this.viewmodeData.currentMode)&&void 0!==t?t:h.Ey.Panorama,cameraPosition:this.cameraData.pose.position.clone(),cameraQuaternion:this.cameraData.pose.rotation.clone(),orthoZoom:this.viewmodeData.currentMode===h.Ey.Floorplan?this.cameraData.zoom():-1,ssZoom:this.cameraData.zoom(),scanId:i?this.sweepData.currentSweep:void 0,floorId:this.floorsViewData.currentFloorId,floorVisibility:this.floorsViewData.getFloorsVisibility()},a}queryIdealResolution(e=u.SL.ULTRAHIGH,t){var i,n;const s=1/Math.max(t,Number.EPSILON);let a=3840,o=a*s;const r=this.renderer.maxTextureSize;if(a>r&&(this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${r}`),a=r,o=a*s),this.viewmodeData.currentMode===h.Ey.Panorama){const s=null!==(n=null===(i=this.sweepData.currentSweepObject)||void 0===i?void 0:i.availableResolution(e))&&void 0!==n?n:u.SL.STANDARD,d=p.Z.getPanoSize(s)*(this.cameraData.fovY()*y.MN)/90;a=Math.min(Math.round(d*t),r),o=Math.round(a/t)}return{width:a,height:o}}queryIdealEqResolution(){let e=4096,t=.5*e;const i=this.renderer.maxTextureSize;return e>i&&this.log.warn(`The active gl context does not support 4k x 2k equirectangular capture\nCapture is limited to a max size of ${i}`),e=Math.min(i,e),t=.5*e,{width:e,height:t}}fetchHighestAvailable(e,t=u.SL.ULTRAHIGH,i){const n=this.sweepData.currentSweepObject;if(n&&this.viewmodeData.currentMode===h.Ey.Panorama){const s=e?this.sweepRenderer.enum.queueStyle.FullPanorama:this.sweepRenderer.enum.queueStyle.CurrentView,a=i?e=>i(e*z.captureProgressFudgeFactor):void 0;return this.sweepRenderer.requestResolution({sweepId:n.id,resolution:t,queueType:s,quickly:!0,onProgress:a}).promise}return i&&i(z.captureProgressFudgeFactor),Promise.resolve()}takeScreenshot(){const e=o.o.ALL;e.removeLayers(this.engine.getRenderLayer("grid-underlay")),e.removeLayers(this.engine.getRenderLayer("cursor-mesh")),e.removeLayers(this.engine.getRenderLayer("current-pano-marker"));const t=this.renderer.getScene().scene,i=this.renderer.getScene().camera,n=i.layers.mask;return i.layers.mask=e.mask,this.engine.commandBinder.issueCommand(new c.vU(this.snapshotTarget,t,i)).then((()=>{i.layers.mask=n}))}async takeEquirectangular(e){const t=this.sweepData.currentSweep,i=this.sweepRenderer.getRenderer(),n=i.useTexture(t),s=this.engine.commandBinder.issueCommand(new c.fZ(this.snapshotTarget,n,e));await s,i.freeTexture(t)}}z.captureProgressFudgeFactor=90},27646:(e,t,i)=>{"use strict";i.d(t,{Z:()=>o});var n,s=i(76609),a=i(71239);!function(e){e[e.Untested=0]="Untested",e[e.Testing=1]="Testing",e[e.Success=2]="Success",e[e.Fail=3]="Fail"}(n||(n={}));class o{constructor(e,t,i,n){this.maxCubemapSize=e,this.maxNavPanoSize=t,this.maxZoomPanoSize=i,this.overrideWindow=!1,this.navPanoSize=s.AB.STANDARD,this.zoomPanoSize=s.AB.STANDARD,this.defaultMaxNavPanoSize=this.maxNavPanoSize,this.resolution=n,this.highQualityThreshold=a.Xd.windowHeightHighQualityThresholdOverride||a.Xd.windowHeightHighQualityThreshold,this.updateMaximums()}update({height:e,fov:t}){this.resolution=e,this.updateMaximums()}overrideWindowMaximums(e){this.overrideWindow=e,this.updateMaximums()}overrideNavPanoSize(e){this.maxNavPanoSize=null!=e?e:this.defaultMaxNavPanoSize,this.updateMaximums()}updateMaximums(){this.resolution<this.highQualityThreshold&&!this.overrideWindow?(this.navPanoSize=Math.min(o.getPanoSize(s.SL.STANDARD),this.maxNavPanoSize),this.zoomPanoSize=Math.min(o.getPanoSize(s.SL.HIGH),this.maxZoomPanoSize)):(this.navPanoSize=this.maxNavPanoSize,this.zoomPanoSize=this.maxZoomPanoSize),this.zoomPanoSize<this.navPanoSize&&(this.navPanoSize=this.zoomPanoSize),this.zoomPanoSize=Math.min(this.maxCubemapSize,this.zoomPanoSize),this.navPanoSize=Math.min(this.maxCubemapSize,this.navPanoSize)}static getPanoSize(e){if(e in s.eE)return s.eE[e];throw new Error(`Not a panoSizeClass: ${e}`)}static getPanoSizeClass(e){if(e in s.Qf)return s.Qf[e];throw new Error(`Not a valid pano resolution: ${e}`)}getNavPanoSize(){return this.navPanoSize}getZoomPanoSize(){return this.zoomPanoSize}}},9699:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var n=i(98010);class s extends n.v0{constructor(){super()}}},46368:(e,t,i)=>{"use strict";i.d(t,{Z:()=>s});var n=i(98010);class s extends n.v0{constructor(e){super(),this.sweepIds=e}}},65594:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>l});var n=i(81396),s=i(97542),a=i(53954),o=i(26306);const r=Object.freeze({sweeps:{maxNeighborDistance:50}});var d=i(46368),h=i(9699);class l extends s.Y{constructor(){super(...arguments),this.name="sweep-path"}async init(e,t){this.engine=t,this.sweepData=await t.market.waitForData(a.Z),this.validNeighbors={},this.maxNeighborDistance=e.maxNeighborDistance||r.sweeps.maxNeighborDistance,this.buildDistanceMap()}setRestrictedSweeps(e,t=0){if(this.restrictedSweeps=[],e){for(let i=t;i<e.length;i++)this.restrictedSweeps.push(e[i].id);this.engine.broadcast(new d.Z(this.restrictedSweeps))}else this.restrictedSweeps=void 0,this.engine.broadcast(new h.Z)}findShortestPath(e,t,i,n,s,a,r=5e3){const d=this.sweepData.getSweep(e),h=this.sweepData.getSweep(t),l=this,c=(0,o.K)({start:d,isEnd:e=>e===h,*neighbors(e){for(const t of e.neighbours)yield l.sweepData.getSweep(t)},distance:(e,t)=>l.getDistance(e.id,t.id),heuristic:(e,t)=>1,timeout:r});return c.status===o.h.Success&&c.path.length<s?(this.addSweepsNearPath(c.path,i),this.filterCloseSweepsFromPath(c.path,n)):null}addSweepsNearPath(e,t){const i=new n.Vector3,s=new n.Vector3,a=new n.Vector3,o=new n.Vector3,r=new n.Vector3,d=new n.Vector3,h=[],l=new n.Vector3,c=(e,t,i)=>(a.copy(t).sub(e),a.dot(i)),m=(e,t)=>c(l,e.position,i)-c(l,t.position,i);let u=0;for(;u<e.length-1;){const n=e[u].id,c=e[u+1].id,p=this.sweepData.getSweep(n),g=this.sweepData.getSweep(c);l.copy(p.position),h.length=0,i.copy(g.position).sub(l).normalize();const y=this.findConnectedSweeps(p,this.maxNeighborDistance),v=this.findConnectedSweeps(g,this.maxNeighborDistance),w=y.concat(v);for(const e of w){const n=a.copy(e.position).sub(l).dot(i);if(n>0){r.copy(i),r.multiplyScalar(n),o.copy(a),o.sub(r);if(o.length()<t){s.copy(i).negate(),d.copy(e.position).sub(g.position);d.dot(s)>0&&h.push(e)}}}if(h.length>0){h.sort(m);for(let t=e.length+h.length-1;t>=u+h.length;t--)e[t]=e[t-h.length];for(let t=0;t<h.length;t++)e[t+u+1]=h[t]}u+=h.length+1}}findConnectedSweeps(e,t,i=2){const n=[];return this._findConnectedSweeps(e,e,t,n,{},i,0),n}_findConnectedSweeps(e,t,i,n,s,a,o){const r=this.getValidNeighbors(e.id);for(const e of r)if(!s[e.id]){e.position.distanceTo(t.position)<i&&(n.push(e),s[e.id]=!0,o<a&&this._findConnectedSweeps(e,t,i,n,s,a,o+1))}}getValidNeighbors(e,t){let i=this.validNeighbors[e];if(!i){i=[],this.validNeighbors[e]=i;const n=this.sweepData.getSweep(e),s=n.neighbours;for(const a of s){const s=this.sweepData.getSweep(a),o=this.getDistance(e,a);if(!s.enabled)continue;if(o>this.maxNeighborDistance)continue;let r=!0;if(t){const e=s.position.clone().sub(n.position).normalize();r=0===t(n.position,e,o).length}r&&i.push(s)}}return i}filterCloseSweepsFromPath(e,t){const i=[];let n=null,s=!1;for(const a of e)s=n&&a.position.distanceTo(n.position)<t||!1,n&&s||(i.push(a),n=a);return i.length<2?e:(s&&e.length>1&&(i[i.length-1]=e[e.length-1]),i)}getCurveForPath(e){let t=0;const i=[0];for(let n=1;n<e.length;n++)t+=e[n-1].distanceTo(e[n]),i.push(t);const s=[0];for(let n=1;n<e.length;n++)s.push(i[n]/t);const a=new n.CatmullRomCurve3(e,!1);return{curve:new n.CatmullRomCurve3(a.getSpacedPoints(2*t).concat(e[e.length-1])),totalLength:t,sourceDistances:i,normalSourceDistances:s}}buildDistanceMap(){const e={},t=new n.Vector3(0,0,0);this.sweepData.iterate((i=>{const n={},s=i.neighbours;for(const e of s){const s=this.sweepData.getSweep(e);t.copy(i.position).sub(s.position);let a,o=Math.max(0,Math.abs(t.y)-.2),r=Math.sqrt(t.x*t.x+t.z*t.z);o>0?(o=Math.pow(4*o,2),r=Math.pow(r,2),a=Math.sqrt(o*o+r*r)):a=t.length(),n[s.id]=a}e[i.id]=n})),this.distanceMap=e}getDistance(e,t){return this.distanceMap[e][t]}}},49011:(e,t,i)=>{"use strict";i.d(t,{m1:()=>g,Vp:()=>w});var n=i(81396),s=i(77256),a=i.n(s),o=i(62118),r=i.n(o);class d extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tMask.value=e,i.tPinHole.value=t,super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PinMaterial",transparent:!0})}}d.uniforms={tMask:{type:"t",value:null},tPinHole:{type:"t",value:null},pinColor:{type:"c",value:new n.Color},opacity:{type:"f",value:1}};var h=i(87926),l=i(49827),c=i(12529),m=i(15462),u=i(87928);const p=i.p+"images/360_placement_pin_mask.png";class g extends n.Mesh{}let y;const v=()=>y||(y=(0,h.p)(p),y);class w extends u.E{constructor(e,t,i,n){const s=new d(v(),t);super(w.geometry,s),this.layers.mask=n.mask,this.name="PinMesh",this.cameraData=i,this._collider=new g(w.colliderGeometry,w.colliderMaterial),this._collider.name="PinMeshCollider",this._collider.material.visible=!1,this.add(this._collider),this.opacityProgress=0,this.shouldHide=!0,this.uniforms=s.uniforms,this.unhover(),this.selected=0,this.visible=!1,this.position.copy(e),this.renderOrder=c.z.pins360}updatePosition(e){this.position.copy(e)}get collider(){return this._collider}render(e){this.quaternion.copy(this.cameraData.pose.rotation),null===this.uniforms.tPinHole.value?this.opacityProgress=0:!this.shouldHide&&this.opacityProgress<1?this.opacityProgress+=e/w.FADE_DURATION:this.shouldHide&&this.opacityProgress>0&&(this.opacityProgress-=e/w.FADE_DURATION),this.opacityProgress=(0,l.uZ)(this.opacityProgress,0,1),this.uniforms.opacity.value=this.opacityProgress,this.visible=0!==this.opacityProgress}activate(){this.shouldHide=!1}deactivate(){this.shouldHide=!0}dispose(){this.collider.geometry.dispose(),this.collider.material.dispose()}setPinHover(e,t=!0,i=!0){const n=Math.min(Math.max(e,0),1);this.selected!==n&&(i&&this.uniforms.pinColor.value.copy(m.I.WHITE).lerp(m.I.MP_BRAND,n),t&&n>0&&n<=1&&(this.material.depthTest=!1),0===n&&(this.material.depthTest=!0),this.selected=n)}unhover(){this.uniforms.pinColor.value.copy(m.I.WHITE)}}w.FADE_DURATION=500,w.geometry=new n.PlaneGeometry(1.5,1.5),w.colliderGeometry=new n.SphereGeometry(1.5*.65),w.colliderMaterial=new n.MeshBasicMaterial({transparent:!0,opacity:.5,depthWrite:!1,color:16724312})},3054:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>B});var n=i(97542),s=i(92810),a=i(81396),o=i(49011),r=i(98010);class d extends r.v0{constructor(e,t){super(),this.sweepId=e,this.selected=t}}class h extends r.v0{constructor(e,t,i){super(),this.sweepId=e,this.pinIndex=t,this.placed=i}}var l=i(63252),c=i(76609),m=i(98169),u=i(23612),p=i(97998),g=i(35826),y=i(72996);const v=new p.Z("pin-mesh");class w{constructor(e,t,i,n,s,o){this.sweepViewData=e,this.scene=t,this.sweepTextureLoader=i,this.input=n,this.layer=o,this.container=new a.Object3D,this.bindings=[],this.visibilityFilter=()=>!0,this.updatePlacementType=(e,t)=>{this.dataToMeshMap[e.id]||e.placementType!==l.hU.MANUAL?this.dataToMeshMap[e.id]&&e.placementType!==l.hU.MANUAL&&(this.removePinMesh(e),this.engine.broadcast(new h(e.id,t,!1))):(this.createPinMesh(e,this.cameraData),this.engine.broadcast(new h(e.id,t,!0)))},this.hoverSweep=(e,t)=>{this.issueCommand(new g.kR(e,t,0));const i=this.sweepViewData.selectedSweep===e;this.highlightPin(e,t||i)},this.meshes=[],this.meshToDataMap={},this.dataToMeshMap={},this.cameraData=s,e.iterate((t=>{t.alignmentType!==l.z9.ALIGNED&&(t.placementType===l.hU.MANUAL&&this.createPinMesh(t,s),this.bindings.push(t.onChanged((()=>{const i=e.getIndexByAlignment(!1,t.id);this.updatePlacementType(t,i),m.H7(t)&&this.updatePinMeshPosition(t.id,t.position)}))))}))}updatePinMeshPosition(e,t){this.mapSweepToMesh(e).updatePosition(t)}mapSweepToMesh(e){return this.dataToMeshMap[e]}mapColliderToSweep(e){const t=e.hasOwnProperty("collider")?e:e.parent;if(t){const e=this.meshToDataMap[t.id];if(e)return e.sweep}return null}filter(e){this.visibilityFilter=e;for(const e of this.meshes)this.filterMesh(e)}init(){}dispose(){for(const e in this.meshToDataMap){const t=this.meshToDataMap[e];this.removePinMesh(t.sweep)}}render(e){for(const t of this.meshes)t.render(e)}activate(e){this.engine=e,this.issueCommand=e.commandBinder.issueCommand.bind(e.commandBinder),this.bindings.push(this.input.registerMeshHandler(u.z,y.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!0)))),this.bindings.push(this.input.registerMeshHandler(u.A,y.s.isType(o.m1),((e,t)=>this.onHoverEvent(t,!1)))),this.scene.add(this.container)}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}getMeshes(){return this.meshToDataMap}highlightPin(e,t){this.dataToMeshMap[e]&&this.dataToMeshMap[e].setPinHover(t?1:0,!1)}lockSelection(e,t){return t&&(this.engine.broadcast(new d(e.id,!0)),this.hoverSweep(e.id,!0)),!0}createPinMesh(e,t){const i=new o.Vp(e.position,null,t,this.layer);this.meshes.push(i),this.dataToMeshMap[e.id]=i,this.meshToDataMap[i.id]={id:i.id,sweep:e},this.container.add(i),this.filterMesh(i),this.sweepTextureLoader.loadFace(e,c.SL.BASE,1,{flipY:!0}).then((e=>{i.material.uniforms.tPinHole.value=e})).catch((t=>{v.error(`${e.id} failed to load texture: ${t}`)}))}removePinMesh(e){const t=this.dataToMeshMap[e.id],i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.id],t.dispose()}filterMesh(e){const t=this.meshToDataMap[e.id];if(t){const i=t.sweep;this.visibilityFilter(i)?this.activateMesh(e):this.deactivateMesh(e)}}onHoverEvent(e,t){const i=this.mapColliderToSweep(e);i&&this.hoverSweep(i.id,t)}activateMesh(e){this.input.registerMesh(e.collider,!1),e.activate()}deactivateMesh(e){this.input.unregisterMesh(e.collider);const t=this.meshToDataMap[e.id];t&&(this.hoverSweep(t.sweep.id,!1),e.deactivate())}}w.MENU_CLEAR_DEBOUNCE=100;var b=i(66777),f=i(19663);class T extends f.m{constructor(e){super(),this.id="PIN_UNSELECT",this.payload={id:e}}}var D=i(54244),C=i(9037),P=i(23254),A=i(34029),S=i(95882),k=i(79727),I=i(21973),E=i(71161),O=i(56159);class N extends r.v0{constructor(e){super(),this.sweepId=e}}class M extends r.v0{constructor(e){super(),this.sweepId=e}}var x=i(43736);class B extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-mesh",this.onChange=()=>{const e=this.sweepViewData,t=e.selectedSweep,i=e.toolState===E._.ROTATING||e.toolState===E._.ROTATED;this.pinRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(x.s,!0))return!1;if(i&&t===e.id)return!1;if(this.viewmodeData.transition.active&&(0,S.Bw)(this.viewmodeData.transition.to))return!1;const n=!this.nextFloor||this.nextFloor===e.floorId||!e.floorId,s=this.config.showPinsInFloorplanDollhouse||this.applicationData.application===D.Mx.WORKSHOP,a=this.viewmodeData.closestMode===S.Ey.Dollhouse||this.viewmodeData.closestMode===S.Ey.Floorplan;return n&&a&&s}))},this.onSelectedPinChange=()=>{const e=this.sweepViewData.selectedSweep;e&&(this.engine.commandBinder.issueCommand(new g.iF(e,!0,0)),this.pinRenderer.highlightPin(e,!0))}}async init(e,t){var i;[this.model,this.webglRenderer,this.input,this.sweepViewData,this.cameraData,this.settingsData,this.viewmodeData,this.floorsViewData,this.applicationData]=await Promise.all([t.getModuleBySymbol(s.qc),t.getModuleBySymbol(s.Aj),t.getModuleBySymbol(s.PZ),t.market.waitForData(I.D),t.market.waitForData(C.M),t.market.waitForData(A.e),t.market.waitForData(P.O),t.market.waitForData(k.c),t.market.waitForData(D.pu)]);const n=t.claimRenderLayer(this.name),a=this.webglRenderer.getScene().scene;this.config={showPinsInFloorplanDollhouse:null===(i=e&&e.showPinsInFloorplanDollhouse)||void 0===i||i},this.engine=t;const o=new b.Z(this.model.getSignedUrls());this.pinRenderer=new w(this.sweepViewData,a,o,this.input,this.cameraData,n),t.addComponent(this,this.pinRenderer),this.bindings.push(this.applicationData.onPropertyChanged("application",this.onChange),this.settingsData.onPropertyChanged(x.s,this.onChange),this.viewmodeData.onChanged(this.onChange),this.sweepViewData.onSelectedSweepChanged(this.onSelectedPinChange),t.subscribe(O.S,(e=>{this.nextFloor=e.to,this.onChange()})),t.subscribe(N,this.onChange),t.subscribe(M,this.onChange),t.commandBinder.addBinding(T,(async e=>{this.pinRenderer.highlightPin(e.id,!1)}))),this.nextFloor=this.floorsViewData.currentFloorId,this.onChange()}mapColliderToSweep(e){return this.pinRenderer.mapColliderToSweep(e)}selectPinMesh(e,t){return this.pinRenderer.lockSelection(e,t)}highlightPinMesh(e,t){this.pinRenderer.highlightPin(e,t)}mapSweepToMesh(e){return this.pinRenderer.mapSweepToMesh(e)}updatePosition(e,t){this.pinRenderer.updatePinMeshPosition(e,t)}}},39531:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>g});var n=i(97542),s=i(92810),a=i(49011),o=i(38987),r=i(34956),d=i(95882),h=i(64918),l=i(23254),c=i(81396),m=i(86819),u=i(23612),p=i(72996);class g extends n.Y{constructor(){super(...arguments),this.name="sweep-pin-navigation"}async init(e,t){const[i,n,g,y]=await Promise.all([t.getModuleBySymbol(s.i0),t.getModuleBySymbol(s.XT),t.market.waitForData(l.O),t.getModuleBySymbol(s.PZ)]),v=new c.Quaternion;this.bindings.push(y.registerMeshHandler(m.R,p.s.isType(a.m1),((e,t,s)=>{const a=i.mapColliderToSweep(t);return!(!a||g.transition.active)&&(v.set(0,0,0,1).multiply(a.rotation),o=a.id,r=v,g.currentMode&&g.currentMode!==d.Ey.Panorama&&n.switchToMode(d.Ey.Panorama,h.n.FadeToBlack,{sweepID:o,rotation:r}),!0);var o,r})),y.registerMeshHandler(u.z,p.s.isType(a.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(r.C.FINGER))})),y.registerMeshHandler(u.A,p.s.isType(a.m1),((e,n)=>{i.mapColliderToSweep(n)&&t.commandBinder.issueCommand(new o.u(null))})))}}},51159:(e,t,i)=>{"use strict";i.d(t,{p:()=>f,Y:()=>y});var n=i(81396),s=i(35490),a=i.n(s),o=i(8346),r=i.n(o);class d extends n.RawShaderMaterial{constructor(e,t){const i=n.UniformsUtils.clone(d.uniforms);i.tNoHover.value=e,i.tHover.value=t,i.tPortal.value=null,super({vertexShader:a(),fragmentShader:r(),uniforms:i,name:"PortalMaterial",transparent:!0})}}d.uniforms={tNoHover:{type:"t",value:null},tHover:{type:"t",value:null},tPortal:{type:"t",vlaue:null},progress:{type:"f",value:1},opacity:{type:"f",value:1}};var h=i(87926);const l=i.p+"images/exterior.png",c=i.p+"images/exterior_hover.png",m=i.p+"images/interior.png",u=i.p+"images/interior_hover.png";let p;const g={get:()=>p||(p={toExteriorTexture:(0,h.p)(l),toExteriorHoverTexture:(0,h.p)(c),toInteriorTexture:(0,h.p)(m),toInteriorHoverTexture:(0,h.p)(u)},p)};var y,v=i(49827),w=i(12529),b=i(23331);!function(e){e[e.HIDE=0]="HIDE",e[e.SHOW=1]="SHOW",e[e.ONTOP=2]="ONTOP"}(y||(y={}));class f extends n.Mesh{constructor(e,t){const i=new d(g.get().toInteriorTexture,g.get().toInteriorHoverTexture);super(f.geometry,i),this.layers.mask=t.mask,this.uniforms=i.uniforms,this.renderOrder=w.z.portals,this.setState(y.HIDE),this.update(e)}update(e){if(this.portalData=e,this.position.copy(e.position),null!==e.lookDirection){const t=e.lookDirection.clone().add(e.position);this.lookAt(t)}this.hoverProgress=0,this.hovered=!1,e.toExterior?(this.uniforms.tNoHover.value=g.get().toExteriorTexture,this.uniforms.tHover.value=g.get().toExteriorHoverTexture):(this.uniforms.tNoHover.value=g.get().toInteriorTexture,this.uniforms.tHover.value=g.get().toInteriorHoverTexture)}resetMesh(e=0,t=!1,i=!1){this.uniforms.opacity.value=e,this.visible=0!==e,this.material.depthTest=t,this.material.depthWrite=i}setHover(e){this.hovered=e}setState(e){switch(e){case y.HIDE:this.resetMesh(0,!0,!0);break;case y.SHOW:this.resetMesh(1,!0,!0);break;case y.ONTOP:this.resetMesh(1)}}render(e,t){var i;if(this.hovered&&this.hoverProgress<1?this.hoverProgress+=e/300:!this.hovered&&this.hoverProgress>0&&(this.hoverProgress-=e/300),this.hoverProgress=(0,v.uZ)(this.hoverProgress,0,1),this.uniforms.progress.value=this.hoverProgress,null===(i=this.portalData)||void 0===i?void 0:i.billboard){const e=t.pose.position,i=this.position.copy(this.portalData.position),n=e.distanceTo(i);n<b.nm?i.lerpVectors(e,i,b.nm/n):n>b.iz&&i.lerpVectors(e,i,b.iz/n),this.lookAt(t.pose.position)}}updatePortalTexture(e){this.uniforms.tPortal.value=e}raycast(e,t){if(!this.visible)return;const i=[];super.raycast(e,i),i.length>0&&(i[0].distance/=1e4,t.push(i[0]))}}f.geometry=new n.PlaneGeometry(b.vX,b.vX)},9162:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>I});var n=i(97542),s=i(92810),a=i(76609),o=i(81396),r=i(29837),d=i.n(r),h=i(45405),l=i.n(h);class c extends o.RawShaderMaterial{constructor(){const e=o.UniformsUtils.clone(c.uniforms);super({vertexShader:d(),fragmentShader:l(),uniforms:e,name:"PortalViewportMaterial",side:o.BackSide})}updateTexture(e){this.uniforms.tMap.value=e}}c.uniforms={tMap:{type:"t",value:null}};class m{constructor(e,t,i,n){this.tempLookDirection=new o.Vector3,this.worldCamera=n,this.camera=new o.PerspectiveCamera,this.renderSize=i,this.sweepTextureLoader=e,this.textureRenderer=t,this.renderTargets={},this.renderCube=new o.Mesh(new o.BoxGeometry(4,4,4),new c)}async getPortalTexture(e,t,i){const n=this.renderTargets[e.id]||this.textureRenderer.createRenderTarget2D(this.renderSize,this.renderSize),s=await this.sweepTextureLoader.load(e,a.SL.BASE);return this.renderCube.material.updateTexture(s),this.renderCube.quaternion.copy(t),this.camera.projectionMatrix.copy(this.worldCamera.projectionMatrix),this.worldCamera.getWorldPosition(this.tempLookDirection),this.camera.lookAt(this.tempLookDirection.sub(i).negate()),this.textureRenderer.render(n,this.renderCube,this.camera),n.texture}releasePortalTexture(e){const t=this.renderTargets[e];t&&this.textureRenderer.disposeRenderTarget2D(t)}}var u=i(51159),p=i(70903),g=i(23612),y=i(86819),v=i(72996),w=i(48476);class b{constructor(e,t,i,n,s){this.container=new o.Object3D,this.bindings=[],this.visibilityFilter=e=>u.Y.HIDE,this.scene=e,this.input=t,this.layer=n,this.cameraData=s,this.viewportLoader=i,this.meshes=[],this.activeMeshes={},this.meshToDataMap={},this.dataToMeshMap={},this.activeTexturePromises={},this.meshPool=new p.L}addPortal(e){let t;const i=this.meshPool.get();i?(t=i.object,t.update(e)):t=this.meshPool.add(new u.p(e,this.layer)).object,this.meshes.push(t),this.container.add(t),this.meshToDataMap[t.id]=e,this.dataToMeshMap[e.index]=t,this.activateMesh(t,this.visibilityFilter(e))}removePortal(e){const t=this.dataToMeshMap[e.index];if(t){this.meshPool.free(t);const i=this.meshes.findIndex((e=>e.id===t.id));this.meshes.splice(i,1),this.container.remove(t),this.deactivateMesh(t),delete this.meshToDataMap[t.id],delete this.dataToMeshMap[e.index]}}init(){}activate(e){this.broadcast=e.broadcast.bind(e),this.bindings.push(this.input.registerMeshHandler(g.z,v.s.isType(u.p),((e,t)=>{this.onPuckSelect(t)}))),this.bindings.push(this.input.registerMeshHandler(g.A,v.s.isType(u.p),((e,t)=>{this.onPuckDeselect(t)}))),this.bindings.push(this.input.registerMeshHandler(y.R,v.s.isType(u.p),((e,t)=>{this.onPuckClick(t)}))),this.scene.add(this.container)}dispose(){for(const e of Object.keys(this.meshToDataMap)){const t=this.meshToDataMap[e],i=this.dataToMeshMap[t.index];this.removePortal(t),i.material.dispose(),i.geometry.dispose()}}deactivate(e){for(const e of this.bindings)e.cancel();this.bindings.length=0,this.scene.remove(this.container)}render(e){for(const t of this.meshes)t.render(e,this.cameraData)}filter(e){this.visibilityFilter=e;for(const t of this.meshes){const i=e(this.meshToDataMap[t.id]);i===u.Y.HIDE?this.deactivateMesh(t):this.activateMesh(t,i)}}mapSweepToMesh(e){for(const t in this.meshToDataMap){const i=this.meshToDataMap[t];if(i.toSweep.id===e&&i.toExterior&&i.fromInterior)return this.dataToMeshMap[i.index]}return null}activateMesh(e,t=0){this.activeMeshes[e.id]||(this.input.registerMesh(e,!1),this.activeMeshes[e.id]=!0),e.setState(t)}deactivateMesh(e){this.input.unregisterMesh(e),this.activeMeshes[e.id]=!1,this.onPuckDeselect(e),e.setState(u.Y.HIDE)}onPuckClick(e){this.broadcast(new w.K(this.meshToDataMap[e.id]))}onPuckSelect(e){this.broadcast(new w.x(!0));const t=this.meshToDataMap[e.id].toSweep,i=this.viewportLoader.getPortalTexture(t,t.rotation,e.position);this.activeTexturePromises[e.id]=i,i.then((t=>{this.activeTexturePromises.hasOwnProperty(e.id)&&i===this.activeTexturePromises[e.id]&&(e.updatePortalTexture(t),e.setHover(!0))}))}onPuckDeselect(e){this.broadcast(new w.x(!1)),e.setHover(!1),this.viewportLoader.releasePortalTexture(this.meshToDataMap[e.id].toSweep.id),delete this.activeTexturePromises[e.id]}}var f=i(23331),T=i(16769),D=i(53954),C=i(9037),P=i(63252),A=i(66777),S=i(98169),k=i(81248);class I extends n.Y{constructor(){super(...arguments),this.name="sweep-portal-mesh",this.portalCount=0}async init(e,t){const[i,n,a,o,r,d,h]=await Promise.all([t.getModuleBySymbol(s.qc),t.getModuleBySymbol(s.fQ),t.getModuleBySymbol(s.PZ),t.getModuleBySymbol(s.tA),t.getModuleBySymbol(s.Aj),t.market.waitForData(D.Z),t.market.waitForData(C.M)]),l=t.claimRenderLayer(this.name);this.portalData={};const c=r.getScene().camera,u=new A.Z(i.getSignedUrls());this.raycaster=n;const p=new m(u,o,256,c),g=r.getScene().scene;this.portalRenderer=new b(g,a,p,l,h),await Promise.all([t.getModuleBySymbol(s.EX)]);const y=P.hU.MANUAL,v=d.filter((e=>S.H7(e)));d.iterate((e=>{this.portalData[e.id]||(this.portalData[e.id]=[]),S.H7(e)&&this.addPortals(e,this.portalRenderer,d,v);let t=e.placementType;this.bindings.push(e.onPropertyChanged("placementType",(i=>{t!==y&&i===y&&this.addPortals(e,this.portalRenderer,d,v),t===y&&i!==y&&this.removePortals(e.id,this.portalRenderer),t=i}))),this.bindings.push(e.onChanged((()=>{S.H7(e)&&(this.removePortals(e.id,this.portalRenderer),this.addPortals(e,this.portalRenderer,d,v))})))})),t.addComponent(this,this.portalRenderer)}filter(e){this.portalRenderer.filter(e)}getPortalToExterior(e){return this.portalRenderer.mapSweepToMesh(e)}removePortals(e,t){for(const i of this.portalData[e])t.removePortal(i);this.portalData[e]=[]}addPortals(e,t,i,n){const s=this.nearestAlignedSweep(e,i);if(s){const i=this.entryLinks(e,s),a=this.neighborLinks(e,n);this.portalData[e.id]=i.concat(a);for(const i of this.portalData[e.id])t.addPortal(i)}else this.log.debug(`Couldn't find the nearest sweep for a 360 on floor ${e.floorId}; not adding portals`)}nearestAlignedSweep(e,t){const i=[S.ff(e),S._k(),S._T(),S.b1(e)],n=[k.TE(e.position)],s=t.sortByScore(i,n)[0];return s?s.sweep:null}modelIntersection(e,t,i=1/0){const n=(new o.Vector3).copy(e.position).sub(t.position).setY(0).normalize(),s=this.raycaster.picking.pick(t.position,n,T.T0);return{intersect:s&&s.distance<=i?s:null,rayDirection:n}}entryLinks(e,t){const i=[],n=e.position.distanceTo(t.position),s=this.modelIntersection(e,t,n+f.vX);let a,r,d=!1;s.intersect&&s.intersect.face?(a=s.intersect.face.normal.clone().setY(0).normalize(),Math.abs(s.rayDirection.dot(a))<.3&&a.copy(s.rayDirection).multiplyScalar(-1),r=s.intersect.point.clone().addScaledVector(a,f.AF)):(a=null,d=!0,r=e.position.clone()),r.y=t.position.y,i.push({index:this.portalCount++,toSweep:e,fromSweep:t,position:r,lookDirection:a,billboard:d,toExterior:!0,fromInterior:!0});const h=(new o.Vector3).lerpVectors(e.position,t.position,2/n).setY(e.position.y);return i.push({index:this.portalCount++,toSweep:t,fromSweep:e,position:h,lookDirection:a?a.clone().negate():null,billboard:d,toExterior:!1,fromInterior:!1}),i}neighborLinks(e,t){const i=[];for(const n of t)if(e!==n&&n.floorId===e.floorId&&e.position.distanceTo(n.position)<f.M0){const t=e.position.distanceTo(n.position);if(this.modelIntersection(e,n,t).intersect||this.modelIntersection(n,e,t).intersect)continue;const s=e.position.clone().sub(n.position).setY(0).normalize(),a=n.position.clone(),o=f.iz;t>o&&a.addScaledVector(s,t-o),i.push({index:this.portalCount++,toSweep:n,fromSweep:e,position:a,lookDirection:s,billboard:!1,toExterior:!0,fromInterior:!1})}return i}}},48476:(e,t,i)=>{"use strict";i.d(t,{K:()=>s,x:()=>a});var n=i(98010);class s extends n.v0{constructor(e){super(),this.toSweep=e.toSweep,this.toExterior=e.toExterior,this.fromInterior=e.fromInterior,this.meshPosition=e.position}}class a extends n.v0{constructor(e){super(),this.hovered=e}}},23331:(e,t,i)=>{"use strict";i.d(t,{AF:()=>s,M0:()=>n,iz:()=>r,nm:()=>o,vX:()=>a});const n=15,s=.1,a=.3,o=.75,r=4},87295:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>b});const n=(0,i(78283)._F)(20);var s=i(97542),a=i(92810),o=i(63252),r=i(95882),d=i(64918),h=i(9037),l=i(53954),c=i(23254),m=i(51159),u=i(48476),p=i(12039),g=i(34029),y=i(43736),v=i(34956),w=i(38987);class b extends s.Y{constructor(){super(...arguments),this.name="sweep-portal-navigation",this.onChange=()=>{this.portalRenderer.filter((e=>{if(!this.settingsData.tryGetProperty(y.s,!0))return m.Y.HIDE;if(!(0,r.Bw)(this.viewmodeData.closestMode))return m.Y.HIDE;const t=this.sweepData.getSweep(this.sweepData.currentSweep||"");if(t)if(t.alignmentType===o.z9.ALIGNED){if(e.fromInterior&&e.toExterior&&e.position.distanceTo(t.position)<n)return m.Y.SHOW}else if(t.placementType===o.hU.MANUAL&&e.fromSweep.id===t.id)return m.Y.ONTOP;return m.Y.HIDE}))}}async init(e,t){this.engine=t,[this.portalRenderer,this.cameraData,this.viewmodeModule,this.viewmodeData,this.sweepData,this.settingsData]=await Promise.all([t.getModuleBySymbol(a.MI),t.market.waitForData(h.M),t.getModuleBySymbol(a.XT),t.market.waitForData(c.O),t.market.waitForData(l.Z),t.market.waitForData(g.e)]);const i=(e,i)=>{this.viewmodeData.currentMode&&this.cameraData.canTransition()&&(this.viewmodeData.currentMode!==r.Ey.Panorama?this.viewmodeModule.switchToMode(r.Ey.Panorama,d.n.FadeToBlack,{sweepID:e,rotation:i}):t.commandBinder.issueCommand(new p.ju({sweep:e,rotation:i,transition:d.n.FadeToBlack})))};this.settingsData.onPropertyChanged(y.s,this.onChange),this.bindings.push(t.subscribe(u.K,(e=>{i(e.toSweep.id)})),t.subscribe(u.x,(e=>this.onPortalHover(e.hovered))),this.viewmodeData.onChanged(this.onChange),this.sweepData.onChanged(this.onChange)),this.onChange()}onPortalHover(e){const t=e?v.C.FINGER:null;this.engine.commandBinder.issueCommand(new w.u(t))}}},94053:(e,t,i)=>{"use strict";i.r(t),i.d(t,{CancelTagEditsCommand:()=>B.Rj,CloseTagCommand:()=>B.xb,DeleteTagCommand:()=>B.T3,EditTagCommand:()=>B.zt,FilterVisibleTagsCommand:()=>B.Sq,OpenTagCommand:()=>B.lt,SaveCustomTagOrderCommand:()=>B.$B,SaveTagCommand:()=>B.QG,SaveTagVisibilityCommand:()=>B.bg,SetTagOrderByCommand:()=>B.kT,SetTagsModeCommand:()=>B.Li,StartNewTagCommand:()=>B.$J,TagOrderBy:()=>x.D,TagsMode:()=>x.U,TagsToolToggleCommand:()=>B.yU,TagsViewData:()=>pe.n,TagsVisibilityFilterEnabledCommand:()=>B.aI,ToggleDirtyTagStateCommand:()=>B.q4,UpdateOpenTagViewCommand:()=>B.fe,default:()=>Oe});var n=i(81396),s=i(97542),a=i(92810),o=i(23379),r=i(5823),d=i(38399),h=i(39880),l=i(87926);const c=i.p+"images/tagColor.png";var m=i(79728),u=i(635),p=i(64918),g=i(12039),y=i(52528),v=i(74082),w=i(14630),b=i(64773),f=i(47620),T=i(30643),D=i(54244),C=i(89570),P=i(56163),A=i(35221),S=i(43470),k=i(86283),I=i(39689),E=i(62612),O=i(19280);class N extends P.K{constructor(e,t,i,s,a,o,d,h){super(e,t,i),this.containerData=s,this.tag=a,this.tagIconsEnabled=d,this.defaultTagLabel=h,this.id=this.tag.id,this.title=this.tag.label||this.textParser.getPlainText(this.tag.description)||this.defaultTagLabel,this.description=this.tag.label?this.textParser.getPlainText(this.tag.description):"",this.icon=`icon-${(0,I.mg)(E.Er.MATTERTAG,this.tag.icon,this.tagIconsEnabled)}`,this.typeId=r.SF.MATTERTAG,this.floorId=this.tag.floorId,this.roomId=this.tag.roomId||"",this.layerId=this.tag.layerId,this.dateBucket=(0,A.f)(this.tag.created),this.color=function(e){const t=new n.Color(e);return`rgb(${255*t.r}, ${255*t.g}, ${255*t.b})`}(this.tag.color),this.enabled=this.tag.enabled,this.onSelect=async()=>{await this.commandBinder.issueCommand(new S.yL),await this.commandBinder.issueCommand(new g.OR({pinPosition:this.tag,transition:p.n.FadeToBlack})),(0,O.p)(this.containerData.size)?this.commandBinder.issueCommand(new S.bd(this.id,k.J.TAG)):this.commandBinder.issueCommand(new S.oM(this.id,k.J.TAG))},this.textParser=o}supportsLayeredCopyMove(){return!0}supportsBatchDelete(){return!0}}var M=i(59279),x=i(12150),B=i(43037),V=i(71166),R=i(48945);const{TAGS:L}=d.Z.SHOWCASE,F=new y.v({links:!0}),H="0"===(0,M.eY)("mt");function j(e,t,i,n,s,a,o,d){let h=o.application===D.Mx.WORKSHOP;const l=a.tryGetProperty(R.RV,!1),c=(t,a,o,r=[])=>{const c=[];return(i.tagOrder===x.D.ALPHABETICAL?i.getAlphabeticTagViewMapFilter().values:i.getOrderedTagViewMapFilter().values).forEach((i=>{if(!(h||i.enabled&&n.layerToggled(i.layerId)))return;if(i.objectAnnotationId)return;let o=t(i.label,F.getPlainText(i.description));o&&r.length>0&&(o=i.keywords.length>0&&i.keywords.some((e=>r.includes(e)))),o&&c.push(new N(e,n,a,s,i,F,l,d))})),e.issueCommand(new B.Sq(c.map((e=>e.id)))),c},m=t=>{e.issueCommand(new B.aI(!!t))},u=e=>new C.V(i.getOrderedTagViewMapFilter().onChanged(e),i.onPropertyChanged("tagOrder",e)),p={renew:()=>{e.issueCommandWhenBound(new V.c6({id:r.SF.MATTERTAG,groupPhraseKey:L.SEARCH_GROUP_HEADER,getSimpleMatches:c,registerChangeObserver:u,onSearchActivatedChanged:m,getKeywords:t.getTagKeywords.bind(t),groupOrder:20,groupIcon:"toolbar-mattertags",batchSupported:!0}))},cancel:()=>{e.issueCommandWhenBound(new V.Pe(r.SF.MATTERTAG))}},g=e=>{h=e===D.Mx.WORKSHOP;!H||h?p.renew():p.cancel()},y=o.onPropertyChanged("application",g);return g(o.application),new C.V(p,y)}var U,z=i(98010);class G extends z.v0{constructor(e,t,i){super(),this.sid=e,this.position=t,this.distanceFromCamera=i}}class _ extends z.v0{constructor(e,t){super(),this.sid=e,this.removeMethod=t}}class $ extends z.v0{constructor(e,t){super(),this.sid=e,this.characterCount=t}}class K extends z.v0{constructor(e,t,i){super(),this.sid=e,this.characterCount=t,this.tagDescriptionChunks=i}}class W extends z.v0{constructor(e,t,i){super(),this.sid=e,this.mediaType=t,this.mediaSrc=i}}class Z extends z.v0{constructor(e,t,i){super(),this.sid=e,this.property=t,this.value=i}}class q extends z.v0{constructor(e,t,i,n){super(),this.sid=e,this.position=t,this.distanceFromCamera=i,this.distanceMoved=n}}!function(e){e.DISC_COLOR="disc_color",e.STEM_VISIBLE="stem_visible",e.STEM_LENGTH="stem_length",e.TITLE="title",e.DESCRIPTION="description",e.MEDIA="media",e.LINKS="links",e.ENABLED="enabled",e.KEYWORDS="keywords"}(U||(U={}));var J=i(72936),Y=i(60083),Q=i(13132),X=i(16935),ee=i(5604),te=i(76631),ie=i(40964),ne=i(89549),se=i(91380),ae=i(92211),oe=i(24102),re=i(43846),de=i(66338),he=i(25561),le=i(71776),ce=i(19648),me=i(88669),ue=i(85679),pe=i(61774),ge=i(35446),ye=i(21149),ve=i(79727),we=i(53954),be=i(34029),fe=i(23254),Te=i(55318),De=i(9037),Ce=i(76957),Pe=i(80742),Ae=i(28022),Se=i(55502),ke=i(51397),Ie=i(2367);class Ee extends s.Y{constructor(){super(...arguments),this.name="tags-module",this.opening=null,this.activated=!1,this.registered=!1,this.activeBindings=[],this.updatePerSettings=()=>{const e=this.settingsData.tryGetProperty(le.re,!1),t=!this.in360View()&&e;this.engine.commandBinder.issueCommand(new J.qN(E.Er.MATTERTAG,t)),t||this.closeTagBillboard()},this.tagsToolToggled=async e=>{e.opened?this.activateTool():this.deactivateTool()},this.updateViewingControls=()=>{const{openTagView:e}=this.viewData,t=this.toolsData.toolPanelLayout===te.wS.BOTTOM_PANEL,i=!this.activated||!t&&!e;this.engine.broadcast(new ie.ps(i))},this.onCloseTag=async()=>{this.closeTag()},this.pinAddCancelled=e=>{e.pinType===E.Er.MATTERTAG&&this.cancelTagCreation(!1)},this.cancelTagEdits=async()=>{this.viewData.creatingTag?this.cancelTagCreation(!0):this.closeTag()},this.cancelTagCreation=e=>{var t;const i=this.viewData,n=null===(t=i.openTagView)||void 0===t?void 0:t.id;this.cancelAttachmentChanges(),i.setOpenTagView(null),i.creatingTag=!1,i.openTagIsDirty=!1,i.commit(),n&&(e&&this.engine.commandBinder.issueCommand(new J.tT(n,E.Er.MATTERTAG)),this.engine.commandBinder.issueCommand(new S.Aj(n,k.J.TAG)))},this.tagsWereChanged=()=>{this.refreshTagViews(),this.displayTags()},this.refreshTagViews=()=>{this.viewData.refreshTagViews(this.getCustomTagOrder())},this.onTagRemoved=e=>{const t=e.objectAnnotationId?E.Er.OBJECT:E.Er.MATTERTAG;this.engine.commandBinder.issueCommand(new J.OL(e.sid,t))},this.handleModelViewChange=()=>{if(this.viewData.openTagView)if(this.viewData.creatingTag)this.cancelTagCreation(!0);else{this.tagsData.getTag(this.viewData.openTagView.id)||this.closeTag()}},this.onLayersChanged=()=>{this.closeTagBillboard(),this.displayTags()},this.onOpenTagViewChanged=()=>{const e=this.viewData.openTagView;e&&this.updateTagPin(e)},this.startTagCreation=async()=>{const e=this.viewData;e.setTagsMode(x.U.DEFAULT),await this.closeTag();let t=(0,h.O1)(11);for(;this.tagsData.getTag(t);)t=(0,h.O1)(11);const i=new me.U;i.sid=t,i.floorId=this.floorsViewData.getHighestVisibleFloor().id,i.layerId=this.layersData.activeLayerId;const n=e.createTagView(i);e.creatingTag=!0,e.commit(),e.setOpenTagView(n),this.engine.commandBinder.issueCommand(new J.fM(n.id,this.getPinUpdate(n),E.Er.MATTERTAG,n.backgroundTexture))},this.saveTag=async e=>{const{id:t,properties:i,pendingAttachments:n,removedAttachments:s,embed:a}=e,o=this.viewData,{openTagView:r,creatingTag:d}=o;if(!r)return void this.log.debug("No open tag");const h=Object.assign({},r,i);this.trackChanges(t,h,a),d?(o.creatingTag=!1,o.openTagIsDirty=!1,o.commit(),await this.engine.commandBinder.issueCommand(new ce.Mm(t,h,n,a))):await this.engine.commandBinder.issueCommand(new ce.qq(t,h,n,s,a)),h.objectAnnotationId||this.selectPin(t,!0),await this.engine.commandBinder.issueCommand(new ge.x9),this.closeTag()},this.saveTagVisibility=async e=>{const{id:t,visible:i}=e,n=this.tagsData.getTag(t);if(!n)throw new Error("Tag not found!");this.engine.commandBinder.issueCommand(new J.ik(t,E.Er.MATTERTAG,this.getTagVisibility(t,n.layerId,i)));const s={enabled:i};return this.trackChanges(t,s),i||this.closeTag(),this.engine.commandBinder.issueCommand(new ce.qq(t,s))},this.onDeleteTag=async e=>{const t=e.id;this.tagsData.getTag(t)?(this.toggleTagDirty(!1),this.engine.commandBinder.issueCommand(new ae.r),this.engine.broadcast(new _(t,e.removalMethod)),this.engine.commandBinder.issueCommand(new ce.Gn(t)).then((()=>{this.saveTags().then((()=>{this.engine.commandBinder.issueCommand(new J.OL(t,E.Er.MATTERTAG));const e=this.viewData.openTagView;e&&e.id===t&&this.closeTag()}))})),this.engine.commandBinder.issueCommand(new ge.x9)):this.log.debug("Cannot delete a non-existent tag")},this.onEditTag=async e=>{const{tagId:t}=e;this.tagsData.getTag(t)?(await this.engine.commandBinder.issueCommand(new ge.x9),await this.openTag(t,p.n.FadeToBlack,!0),this.openAnnotation(t,!0),this.selectPin(t,!0)):this.log.debug("Cannot edit a non-existent tag")},this.updateOpenTagView=async e=>{const{updates:t}=e,i=this.viewData.openTagView;if(i){this.viewData.setOpenTagView(Object.assign(Object.assign({},i),t));const e=i.objectAnnotationId||i.id,n=i.objectAnnotationId?E.Er.OBJECT:E.Er.MATTERTAG;await this.engine.commandBinder.issueCommand(new J.tE(e,n,t))}else this.log.debug("No open tag to update")},this.onSaveCustomTagOrder=async e=>{const{ids:t}=e,i=t.map((e=>({id:e,type:oe.l.TAG})));await this.engine.commandBinder.issueCommand(new re.wg(he.q,i)),this.viewData.refreshTagViews(t)},this.pinMoved=e=>{const{id:t,pinType:i,pinPos:n,previousPos:s}=e,a=this.viewData.openTagView;if(a&&i===E.Er.MATTERTAG&&t===a.id){if(this.tagsData.getTag(t)){const{anchorPosition:e,stemNormal:i,floorId:a,roomId:o}=n,r={position:e,normal:i,floorId:a,roomId:o};this.engine.broadcast(new q(t,r.position,r.position.distanceTo(this.cameraData.pose.position),s?r.position.distanceTo(s.anchorPosition):0)),this.engine.commandBinder.issueCommand(new ce.qq(t,r))}else this.log.debug("Cannot move a non-existent tag")}},this.pinPlaced=e=>{const{openTagView:t}=this.viewData;t&&e.pinType===E.Er.MATTERTAG&&e.id===t.id&&(Object.assign(t,e.pinPos),this.openAnnotation(t.id,!0))},this.handlePinFocusChange=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t)return;const{commandBinder:i}=this.engine,{focusedPin:n,selectedPinId:s}=this.pinsViewData,{billboardAnnotation:a}=this.annotationsViewData;if(!n)return void(a&&a.annotationType===k.J.TAG&&a.id!==s&&await i.issueCommand(new S.Aj(a.id,k.J.TAG)));const o=this.getSelectedTag(),r=o&&(null==o?void 0:o.id)===(null==e?void 0:e.id),d=e&&(null==e?void 0:e.id)===(null==n?void 0:n.id);if(e&&r&&!d&&this.closeTag(),n.pinType===E.Er.MATTERTAG){const t=this.viewData.getTagView(n.id);if(!t)return void this.log.debug("Focused pin changed, but no tag view.");t.id!==(null==e?void 0:e.id)&&(i.issueCommand(new S.Kw(t.id,k.J.TAG)),this.engine.broadcast(new Se.dJ(t.id,ke.V.HOVER)))}},this.handlePinSelectionChange=async()=>{const{openTagView:e,openTagIsDirty:t}=this.viewData,{selectedPinId:i}=this.pinsViewData;if(t||(null==e?void 0:e.id)===i)return;const n=i?this.pinsViewData.getPin(i):null,s=this.appData.application===D.Mx.WORKSHOP;if(e&&!n)!s&&this.activated?await this.engine.commandBinder.issueCommand(new ne.CH(te.w1.TAGS)):this.closeTag();else if(n&&n.pinType===E.Er.MATTERTAG){(0,O.p)(this.containerData.size)&&await this.engine.commandBinder.issueCommand(new S.bd(n.id,k.J.TAG));const e=this.isTagDocked()||!!this.getSelectedTag(),t=s&&e;this.engine.commandBinder.issueCommand(new J.ic(n.id,t)),this.engine.broadcast(new Se.dJ(n.id,ke.V.OPEN));const i=this.isDocking();await this.openTag(n.id,p.n.Interpolate,i),this.openAnnotation(n.id,i)}},this.isDocking=()=>(0,O.p)(this.containerData.size)||this.activated&&this.isTagDocked(),this.handleAnnotationsChanged=async()=>{const{openTagView:e,creatingTag:t}=this.viewData;if(t||this.opening)return;const i=this.getDockedTag(),n=this.getSelectedTag(),s=i||n,a=!!i,{dockedAnnotation:o}=this.annotationsViewData;e&&!s&&(null==o?void 0:o.annotationType)!==k.J.OBJECT?this.closeTag():s&&s.id!==(null==e?void 0:e.id)&&(this.engine.broadcast(new Se.dJ(s.id,ke.V.OPEN)),await this.openTag(s.id,p.n.Interpolate,a),await this.selectPin(s.id,a)),a?(this.activated||await this.engine.commandBinder.issueCommand(new ne.z2(te.w1.TAGS,!0)),s&&await this.selectPin(s.id,a)):this.activated&&this.toolsData.softOpening&&await this.engine.commandBinder.issueCommand(new ne.CH(te.w1.TAGS))},this.handleViewingAttachment=e=>{const{annotationType:t,id:i,attachmentId:n}=e;if(t!==k.J.TAG)return;const s=this.viewData.getTagView(i);if(!s)return void this.log.debug("Cannot view attachment for a non-existent tag");const a=s.attachments,o=a.find((e=>e.id===n));if(o&&(0,ye.lV)(o)){const e=a.filter((e=>(0,ye.lV)(e)));this.engine.commandBinder.issueCommand(new ge.xW(!0,e,n))}},this.onOpenTag=async e=>{const{tagId:t,dock:i,transition:n,objectTag:s,forceOpen:a}=e;this.toggleTagDirty(!1);const o=this.annotationsViewData.getCapabilities(t).dock,r=!(!i||!o),d=null===i&&this.isTagDocked()&&o,h=r||d||!(!i||!a);h&&s?this.dockObjectTag(t):(await this.openTag(t,n,h),this.openAnnotation(t,h,a),this.selectPin(t,h))},this.filterVisibleTags=async e=>{const{idVisibility:t}=this.viewData;t.clear(),e.ids.forEach((e=>t.add(e))),this.viewData.commit(),this.displayTags()},this.tagVisbilityFilterEnabled=async e=>{this.viewData.idVisibilityEnabled=e.enabled,this.viewData.commit(),this.displayTags()},this.setTagOrderBy=async({order:e})=>{e!==this.viewData.tagOrder&&(this.viewData.tagOrder=e,this.viewData.commit())},this.setTagsMode=async({mode:e})=>{e===x.U.REORDERING&&this.closeTag(),this.viewData.setTagsMode(e)}}async init(e,t){const[i,n,s,r,h,m,u,p,g,f,T,C,P]=await Promise.all([t.market.waitForData(De.M),t.market.waitForData(ue.n),t.market.waitForData(se.t),t.market.waitForData(we.Z),t.market.waitForData(be.e),t.market.waitForData(fe.O),t.market.waitForData(X.A),t.market.waitForData(D.pu),t.market.waitForData(ve.c),t.market.waitForData(de.W),t.market.waitForData(Pe.R),t.market.waitForData(Ie.V),t.getModuleBySymbol(a.e9)]),[A,S,k]=await Promise.all([t.market.waitForData(Ce.i),t.market.waitForData(Te.O),t.getModuleBySymbol(o.DeepLinksModuleKey)]);this.cameraData=i,this.tagsData=n,this.toolsData=s,this.sweepData=r,this.settingsData=h,this.viewmodeData=m,this.annotationsViewData=u,this.appData=p,this.floorsViewData=g,this.orderedListData=f,this.layersData=T,this.containerData=C,this.engine=t,this.backgroundTexture=(0,l.p)(c),this.descriptionParser=new v.$({supportLinks:!0,keepLinkLabels:!0});const I=new y.v({links:!0,hashtags:!1}),E=this.getCustomTagOrder(),O=P.t(d.Z.WORKSHOP.MATTERTAGS.DEFAULT_TAG_TITLE);this.viewData=new pe.n(this.tagsData,A,S,E,I,k,O,this.backgroundTexture,e.objectTagsEnabled),this.pinsViewData=await t.market.waitForData(Y.B),this.bindings.push(h.onPropertyChanged(le.re,this.updatePerSettings),t.commandBinder.addBinding(B.yU,this.tagsToolToggled),t.subscribe(ee.q,this.handleViewingAttachment),t.subscribe(w.Z,this.updatePerSettings),t.subscribe(b.m,this.updatePerSettings),m.makeModeChangeSubscription(this.updatePerSettings),t.commandBinder.addBinding(B.xb,this.onCloseTag),t.commandBinder.addBinding(B.lt,this.onOpenTag),t.commandBinder.addBinding(B.Li,this.setTagsMode),t.commandBinder.addBinding(B.kT,this.setTagOrderBy),t.commandBinder.addBinding(B.QG,this.saveTag),t.commandBinder.addBinding(B.q4,(async e=>this.toggleTagDirty(e.dirty))),t.commandBinder.addBinding(B.T3,this.onDeleteTag),t.commandBinder.addBinding(B.bg,this.saveTagVisibility),t.commandBinder.addBinding(B.zt,this.onEditTag),t.commandBinder.addBinding(B.fe,this.updateOpenTagView),this.pinsViewData.onSelectedPinChanged(this.handlePinSelectionChange),this.pinsViewData.onFocusedPinChanged(this.handlePinFocusChange),this.annotationsViewData.onChanged(this.handleAnnotationsChanged),this.viewData.onOpenTagViewChanged(this.onOpenTagViewChanged),this.orderedListData.onChanged(this.refreshTagViews),this.tagsData.onChanged(this.tagsWereChanged),this.tagsData.collection.onElementChanged({onRemoved:this.onTagRemoved}),this.appData.onChanged((()=>this.displayTags())),this.layersData.onCurrentLayersChanged(this.onLayersChanged),this.layersData.onPropertyChanged("activeLayerId",(()=>this.updatePendingTag())),t.commandBinder.addBinding(B.Sq,this.filterVisibleTags),t.commandBinder.addBinding(B.aI,this.tagVisbilityFilterEnabled),t.subscribe(Ae.YB,this.handleModelViewChange)),t.market.register(this,pe.n,this.viewData),this.updatePerSettings(),this.displayTags();const N=j(t.commandBinder,this.tagsData,this.viewData,this.layersData,C,this.settingsData,this.appData,O);this.bindings.push(N)}dispose(e){this.deactivateTool(!0),this.bindings.forEach((e=>{e.cancel()})),this.bindings=[],this.activeBindings=[],this.engine.commandBinder.issueCommand(new J.zM(E.Er.MATTERTAG)),this.backgroundTexture.dispose(),super.dispose(e)}onUpdate(){}activateTool(){this.activated||(this.engine.commandBinder.issueCommand(new S.yL(k.J.TAG)),this.engine.commandBinder.issueCommand(new J.Ki(!0)),this.registered?this.activeBindings.forEach((e=>{e.renew()})):this.registerHandlers(),this.activated=!0,this.updateViewingControls())}deactivateTool(e){if(!this.activated)return;this.activated=!1;const{creatingTag:t,openTagView:i,tagsMode:n}=this.viewData;n!==x.U.DEFAULT&&this.viewData.setTagsMode(x.U.DEFAULT),t?this.cancelTagCreation(!0):i&&this.closeTag(),this.engine.commandBinder.issueCommand(new J.iK),this.engine.commandBinder.issueCommand(new J.Ki(!1)),this.activeBindings.forEach((e=>{e.cancel()})),this.updateViewingControls(),this.engine.commandBinder.issueCommand(new ge.x9)}registerHandlers(){const e=this.engine.commandBinder;this.activeBindings.push(this.engine.subscribe(Q.b0,this.pinPlaced),this.engine.subscribe(Q.bV,this.pinMoved),this.engine.subscribe(Q.hu,this.pinAddCancelled),e.addBinding(B.$J,this.startTagCreation),e.addBinding(B.Rj,this.cancelTagEdits),e.addBinding(B.$B,this.onSaveCustomTagOrder),this.viewData.onOpenTagViewChanged(this.updateViewingControls),this.viewData.onPropertyChanged("creatingTag",this.updateViewingControls),this.viewData.onPropertyChanged("tagsMode",(()=>this.displayTags()))),this.registered=!0}closeTagBillboard(){const{billboardAnnotation:e}=this.annotationsViewData;e&&e.annotationType===k.J.TAG&&this.engine.commandBinder.issueCommand(new S.Aj(e.id,k.J.TAG))}in360View(){const e=this.sweepData.currentSweep?this.sweepData.currentSweep:"";return this.viewmodeData.isInside()&&this.sweepData.isSweepUnaligned(e)}async closeTag(){const{commandBinder:e}=this.engine,t=this.viewData,{openTagView:i}=t;if(this.toggleTagDirty(!1),i){const{id:n,layerId:s,enabled:a}=i;t.setOpenTagView(null),this.cancelAttachmentChanges(),e.issueCommand(new V.IL(null)),e.issueCommand(new ge.xW(!1));const o=this.tagsData.getTag(n);o&&(e.issueCommand(new J.RH(n,E.Er.MATTERTAG)),o.objectAnnotationId?e.issueCommand(new J.OL(n,E.Er.MATTERTAG)):(e.issueCommand(new J.ik(n,E.Er.MATTERTAG,this.getTagVisibility(n,s,a))),e.issueCommand(new J.tE(n,E.Er.MATTERTAG,o.getPin())))),await e.issueCommand(new S.Aj(n,k.J.TAG))}this.engine.commandBinder.issueCommand(new ge.x9)}getTagVisibility(e,t,i){const{openTagView:n,idVisibilityEnabled:s,idVisibility:a,tagsMode:o}=this.viewData,r=this.appData.application===D.Mx.WORKSHOP||this.layersData.layerToggled(t),d=this.layersData.layerVisible(t),h=o===x.U.REORDERING,l=!s||a.has(e),c=(null==n?void 0:n.id)===e;return r&&(c||i&&h||i&&l&&d)}displayTags(){const e=[];this.viewData.getOrderedTags(!1).forEach((t=>{if(!t.objectAnnotationId){const i=this.getPinUpdate(t);e.push(i)}})),this.engine.commandBinder.issueCommand(new J.mE(e))}updateTagPin(e){if(!e.objectAnnotationId){const t=this.getPinUpdate(e);this.engine.commandBinder.issueCommand(new J.mE([t]))}}getPinUpdate(e){const{openTagView:t}=this.viewData,i=t&&t.id===e.id?t:e,{id:n,layerId:s,enabled:a,anchorPosition:o,color:r,icon:d,stemEnabled:h,floorId:l,roomId:c,stemNormal:m,stemLength:u}=i;return{id:n,anchorPosition:o,color:r,floorId:l,roomId:c,stemEnabled:h,stemNormal:m,stemLength:u,pinType:E.Er.MATTERTAG,backgroundTexture:this.backgroundTexture,icon:d,visible:this.getTagVisibility(n,s,a)}}updatePendingTag(){const{creatingTag:e,openTagView:t}=this.viewData;e&&t&&(this.layersData.isInMemoryLayer(t.layerId)||(t.layerId=this.layersData.activeLayerId))}async cancelAttachmentChanges(){return this.engine.commandBinder.issueCommand(new ge.Ze)}toggleTagDirty(e){this.viewData.openTagIsDirty=e,this.viewData.commit()}getCustomTagOrder(){const e=this.orderedListData.getOrderedList(he.q);return e?e.entries.map((e=>e.id)):[]}async saveTags(){this.engine.commandBinder.issueCommand(new u.V({dataTypes:[m.g.MATTERTAGS]}))}openAnnotation(e,t,i=!1){const n=this.annotationsViewData.getCapabilities(e);t?(n.dock||i)&&this.engine.commandBinder.issueCommand(new S.bd(e,k.J.TAG,i)):(n.preview||i)&&this.engine.commandBinder.issueCommand(new S.oM(e,k.J.TAG,i))}async selectPin(e,t=!1){const i=t&&this.activated&&this.appData.application===D.Mx.WORKSHOP;t?this.engine.broadcast(new Se.dJ(e,ke.V.DOCKED)):this.engine.broadcast(new Se.dJ(e,ke.V.OPEN)),await this.engine.commandBinder.issueCommand(new J.Ar(e,E.Er.MATTERTAG,i))}dockObjectTag(e){const t=this.viewData.getTagView(e);t?(this.engine.commandBinder.issueCommand(new S.bd(e,k.J.OBJECT)),this.viewData.setOpenTagView(Object.assign({},t)),this.selectPin(e,!0),this.toolsData.toolCollapsed&&this.engine.commandBinder.issueCommand(new ne.Fg(!1))):this.log.debug("Cannot dock a non-existent tag")}async openTag(e,t,i){const n=this.viewData,s=n.getTagView(e);if(s){const{openTagView:a,tagsMode:o}=this.viewData,{commandBinder:d}=this.engine,{dockedAnnotation:h,selectedAnnotation:l}=this.annotationsViewData;i&&o===x.U.REORDERING&&n.setTagsMode(x.U.DEFAULT),i&&this.toolsData.toolCollapsed&&this.activated&&d.issueCommand(new ne.Fg(!1));const c=(null==a?void 0:a.id)===e;if(c&&this.activated===i)return void this.log.debug("Tag is already open and "+(i?"docked":"undocked"));if(i!==!!h){const t=this.annotationsViewData.getCapabilities(e);i?t.dock&&!this.activated&&await this.engine.commandBinder.issueCommand(new ne.z2(te.w1.TAGS,!0)):h&&await this.engine.commandBinder.issueCommand(new S.Aj(h.id,h.annotationType))}if(!c&&this.opening!==e){this.opening=e,d.issueCommand(new ae.r),l&&l.id!==e&&await this.engine.commandBinder.issueCommand(new S.Aj(l.id,l.annotationType)),n.setOpenTagView(Object.assign({},s));const i=n.getCapabilities(e);null!==t&&i.focus&&await this.engine.commandBinder.issueCommand(new g.OR({pinPosition:s,transition:t})).then((()=>{this.engine.broadcast(new Se.QY(s.id))})),this.engine.commandBinder.issueCommand(new V.IL(s.id,r.SF.MATTERTAG)),setTimeout((()=>{this.opening=null}),0)}}else this.log.debug("Cannot open a non-existent tag")}isTagDocked(){const{dockedAnnotation:e}=this.annotationsViewData;return(null==e?void 0:e.annotationType)===k.J.TAG}getDockedTag(){const{dockedAnnotation:e}=this.annotationsViewData;return e&&e.annotationType===k.J.TAG?this.viewData.getTagView(e.id):null}getSelectedTag(){const{billboardAnnotation:e,billboardSelected:t}=this.annotationsViewData;return e&&t&&e.annotationType===k.J.TAG||(null==e?void 0:e.annotationType)===k.J.OBJECT?this.viewData.getTagView(e.id):null}trackChanges(e,t,i){const s=this.tagsData.getTag(e),{position:a,color:o,description:r,label:d,stemHeight:h,stemVisible:l,enabled:c,keywords:m}=t;if(!s&&a)return void this.engine.broadcast(new G(e,a,a.distanceTo(this.cameraData.pose.position)));if(void 0!==c&&s.enabled!==c&&this.engine.broadcast(new Z(e,U.ENABLED,c)),o){const t=new n.Color(o.r,o.g,o.b).getHexString();s.color.getHexString()!==t&&this.engine.broadcast(new Z(e,U.DISC_COLOR,`#${t}`))}if(void 0!==h&&s.stemHeight!==h&&this.engine.broadcast(new Z(e,U.STEM_LENGTH,h)),void 0!==l&&s.stemVisible!==l&&this.engine.broadcast(new Z(e,U.STEM_VISIBLE,l)),void 0!==d&&s.label!==d&&(this.engine.broadcast(new Z(e,U.TITLE,d.length)),this.engine.broadcast(new $(e,d.length))),void 0!==r&&s.description!==r){this.engine.broadcast(new Z(e,U.DESCRIPTION,r.length));const t=this.descriptionParser.parse(r,this.layersData.getNonworkshopViewId());this.engine.broadcast(new K(e,r.length,t));const i=v.$.getNumLinks(t);v.$.getNumLinks(s.parsedDescription)!==i&&this.engine.broadcast(new Z(e,U.LINKS,i))}if(i){const t=i?i.src:"",n=i?(0,f.F5)(i.mediaType):T.z.none;s.mediaSrc===t&&s.mediaType===n||(this.engine.broadcast(new Z(e,U.MEDIA,n)),this.engine.broadcast(new W(e,n,t)))}const u=s.keywords.every((e=>m&&m.includes(e)));if((null==m?void 0:m.length)!==s.keywords.length||!u){const t=(null==m?void 0:m.length)||0;this.engine.broadcast(new Z(e,U.KEYWORDS,t))}}}const Oe=Ee},70903:(e,t,i)=>{"use strict";i.d(t,{L:()=>n});class n{constructor(e){this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e){const t=this.createObjectDescriptor(e);return t.object=e,t.inUse=!0,this.addObjectDescriptorToPool(t),t}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}free(e){for(const t of this.poolArray)if(t.object===e)return t.inUse=!1,!0;return!1}all(){return this.poolArray}remove(e){const t=this.poolArray.findIndex((t=>t.object===e));return-1!==t&&(this.poolArray.splice(t,1),!0)}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},87928:(e,t,i)=>{"use strict";i.d(t,{E:()=>s});var n=i(81396);class s extends n.Mesh{constructor(e,t){super(e,t)}}},69984:(e,t,i)=>{"use strict";i.d(t,{D5:()=>h,Ex:()=>l,G1:()=>r,rn:()=>d});var n=i(81396),s=i(39880);const a=()=>Math.random(),o={},r=(e,t=a())=>(o[t]||(o[t]=new n.Vector4(a(),a(),a(),e)),o[t]),d=()=>new n.Color(a(),a(),a()),h=e=>e instanceof Object&&"r"in e&&"g"in e&&"b"in e;function l(e){return`#${(0,s.Q_)(255*e.r,2,"0",16)}${(0,s.Q_)(255*e.g,2,"0",16)}${(0,s.Q_)(255*e.b,2,"0",16)}`}},62118:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform sampler2D tMask;uniform sampler2D tPinHole;uniform vec3 pinColor;uniform float opacity;void main(){vec4 maskColor=texture2D(tMask,vUv);vec4 pinHoleColor=vec4(texture2D(tPinHole,vec2(vUv.x,vUv.y-0.11)).xyz,1.);float redness=maskColor.r-maskColor.b;vec4 mixedPinColor=mix(vec4(pinColor,1.),pinHoleColor,redness);mixedPinColor.a=min(mixedPinColor.a,maskColor.a)*opacity;gl_FragColor=mixedPinColor;}"},77256:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},45405:e=>{e.exports="precision highp float;precision highp int;uniform samplerCube tMap;varying vec3 vUvw;void main(){vec4 color=textureCube(tMap,vec3(-vUvw.x,vUvw.yz));gl_FragColor=vec4(color.rgb,1.);}"},29837:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;varying vec3 vUvw;void main(){vUvw=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},8346:e=>{e.exports="precision highp float;precision highp int;varying vec2 vUv;uniform float progress;uniform float opacity;uniform sampler2D tNoHover;uniform sampler2D tHover;uniform sampler2D tPortal;void main(){vec4 noHoverColor=texture2D(tNoHover,vUv);vec4 hoverColor=texture2D(tHover,vUv);vec4 portalColor=texture2D(tPortal,vUv);float xToCtr=2.*vUv.x-1.;float yToCtr=2.*vUv.y-1.;float withinRadius=step(xToCtr*xToCtr+yToCtr*yToCtr,0.9);vec4 mixedPortalColor=mix(hoverColor,portalColor,withinRadius);mixedPortalColor=mix(mixedPortalColor,hoverColor,hoverColor.a);mixedPortalColor=mix(noHoverColor,mixedPortalColor,progress);mixedPortalColor.a=min(mixedPortalColor.a,opacity);gl_FragColor=mixedPortalColor;}"},35490:e=>{e.exports="precision highp float;precision highp int;uniform mat4 modelViewMatrix;uniform mat4 projectionMatrix;attribute vec3 position;attribute vec2 uv;varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}"},44602:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"FileAttachments"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"fileAttachmentsByModelId"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"results"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteFileAttachment"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"id"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteFileAttachment"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"id"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"FileAttachmentDetails"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"FileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"filename"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"url"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"validUntil"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"bytes"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"mimeType"},arguments:[],directives:[]},{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ImageFileAttachment"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"imageWidth"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"imageHeight"},arguments:[],directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"UploadFileAttachmentToModel"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"organizationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"contents"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"FileUpload"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"filename"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"String"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"uploadFileAttachmentToModel"},arguments:[{kind:"Argument",name:{kind:"Name",value:"organizationId"},value:{kind:"Variable",name:{kind:"Name",value:"organizationId"}}},{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"contents"},value:{kind:"Variable",name:{kind:"Name",value:"contents"}}},{kind:"Argument",name:{kind:"Name",value:"filename"},value:{kind:"Variable",name:{kind:"Name",value:"filename"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"FileAttachmentDetails"},directives:[]}]}}]}}],loc:{start:0,end:757}};t.loc.source={body:"# read all attachments for the specified model\nquery FileAttachments($modelId: ID!) {\n  fileAttachmentsByModelId(modelId: $modelId) {\n    results { ...FileAttachmentDetails }\n  }\n}\n\nmutation DeleteFileAttachment($id: ID!) {\n  deleteFileAttachment(id: $id)\n}\n\nfragment FileAttachmentDetails on FileAttachment {\n  id\n  created\n  filename\n  url\n  validUntil\n  bytes\n  mimeType\n  ...on ImageFileAttachment {\n      imageWidth\n      imageHeight\n  }\n}\n\nmutation UploadFileAttachmentToModel($organizationId: ID!, $modelId: ID!, $contents: FileUpload!, $filename: String!) {\n  uploadFileAttachmentToModel(organizationId: $organizationId, modelId: $modelId,\n                              contents: $contents, filename: $filename) {\n    ...FileAttachmentDetails\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.FileAttachments=a(t,"FileAttachments"),e.exports.DeleteFileAttachment=a(t,"DeleteFileAttachment"),e.exports.FileAttachmentDetails=a(t,"FileAttachmentDetails"),e.exports.UploadFileAttachmentToModel=a(t,"UploadFileAttachmentToModel")},69665:e=>{var t={kind:"Document",definitions:[{kind:"OperationDefinition",operation:"query",name:{kind:"Name",value:"GetObjectAnnotations"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}},type:{kind:"NamedType",name:{kind:"Name",value:"Float"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"ids"}},type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}},type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"model"},arguments:[{kind:"Argument",name:{kind:"Name",value:"id"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"objectAnnotations"},arguments:[{kind:"Argument",name:{kind:"Name",value:"inferenceEvents"},value:{kind:"Variable",name:{kind:"Name",value:"inferenceEvents"}}},{kind:"Argument",name:{kind:"Name",value:"minimumConfidenceOverride"},value:{kind:"Variable",name:{kind:"Name",value:"minConfidence"}}},{kind:"Argument",name:{kind:"Name",value:"ids"},value:{kind:"Variable",name:{kind:"Name",value:"ids"}}},{kind:"Argument",name:{kind:"Name",value:"includeDisabled"},value:{kind:"Variable",name:{kind:"Name",value:"includeDisabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"AddObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationDetails"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"addObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotation"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotation"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"PatchObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"data"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotationPatch"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patchObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}},{kind:"Argument",name:{kind:"Name",value:"patch"},value:{kind:"Variable",name:{kind:"Name",value:"data"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"SetBulkObjectAnnotationsEnabled"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}},type:{kind:"NonNullType",type:{kind:"ListType",type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"Boolean"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"setBulkObjectAnnotationsEnabled"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationIds"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationIds"}}},{kind:"Argument",name:{kind:"Name",value:"setEnabled"},value:{kind:"Variable",name:{kind:"Name",value:"setEnabled"}}}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"FragmentSpread",name:{kind:"Name",value:"ObjectAnnotationInfo"},directives:[]}]}}]}},{kind:"OperationDefinition",operation:"mutation",name:{kind:"Name",value:"DeleteObjectAnnotation"},variableDefinitions:[{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"modelId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]},{kind:"VariableDefinition",variable:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}},type:{kind:"NonNullType",type:{kind:"NamedType",name:{kind:"Name",value:"ID"}}},directives:[]}],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"deleteObjectAnnotation"},arguments:[{kind:"Argument",name:{kind:"Name",value:"modelId"},value:{kind:"Variable",name:{kind:"Name",value:"modelId"}}},{kind:"Argument",name:{kind:"Name",value:"objectAnnotationId"},value:{kind:"Variable",name:{kind:"Name",value:"objectAnnotationId"}}}],directives:[]}]}},{kind:"FragmentDefinition",name:{kind:"Name",value:"ObjectAnnotationInfo"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"ObjectAnnotation"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"created"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"modified"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"model"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"floor"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"room"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"layer"},arguments:[],directives:[{kind:"Directive",name:{kind:"Name",value:"include"},arguments:[{kind:"Argument",name:{kind:"Name",value:"if"},value:{kind:"Variable",name:{kind:"Name",value:"includeLayers"}}}]}],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"enabled"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"confidence"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"region"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"InlineFragment",typeCondition:{kind:"NamedType",name:{kind:"Name",value:"VectorRegion"}},directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"anchorPosition"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemNormal"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"x"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"y"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"z"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"stemLength"},arguments:[],directives:[]}]}}]}},{kind:"Field",name:{kind:"Name",value:"tag"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]}]}},{kind:"Field",name:{kind:"Name",value:"keywords"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"classification"},arguments:[],directives:[],selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"label"},arguments:[],directives:[]},{kind:"Field",name:{kind:"Name",value:"defaultKeywords"},arguments:[],directives:[]}]}}]}}],loc:{start:0,end:1990}};t.loc.source={body:"# Object Tag Suggestions\n# Reference: https://matterport-confluence.atlassian.net/wiki/spaces/PP/pages/2678521926/Datafication+Object+Detection+Schema+Proposal\n\nquery GetObjectAnnotations($modelId: ID!, $inferenceEvents: [ID!], $minConfidence: Float, $ids: [ID!], $includeDisabled: Boolean, $includeLayers: Boolean!) {\n  model(id: $modelId) {\n    objectAnnotations(inferenceEvents: $inferenceEvents, minimumConfidenceOverride: $minConfidence, ids: $ids, includeDisabled: $includeDisabled) {\n      ...ObjectAnnotationInfo\n    }\n  }\n}\n\nmutation AddObjectAnnotation($modelId: ID!, $objectAnnotation: ObjectAnnotationDetails!, $includeLayers: Boolean!) {\n  addObjectAnnotation(modelId: $modelId, objectAnnotation: $objectAnnotation) {\n    ...ObjectAnnotationInfo\n  }\n}\n\n# Update a single object annotation\nmutation PatchObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!, $data: ObjectAnnotationPatch!, $includeLayers: Boolean!) {\n  patchObjectAnnotation(modelId: $modelId, , objectAnnotationId: $objectAnnotationId, patch: $data) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation SetBulkObjectAnnotationsEnabled($modelId: ID! $objectAnnotationIds:[ID!]!, $setEnabled: Boolean!, $includeLayers: Boolean!) {\n  setBulkObjectAnnotationsEnabled(modelId: $modelId, objectAnnotationIds: $objectAnnotationIds, setEnabled: $setEnabled) {\n    ...ObjectAnnotationInfo\n  }\n}\n\nmutation DeleteObjectAnnotation($modelId: ID!, $objectAnnotationId: ID!) {\n  deleteObjectAnnotation(modelId: $modelId, objectAnnotationId: $objectAnnotationId)\n}\n\nfragment ObjectAnnotationInfo on ObjectAnnotation {\n  id\n  created\n  modified\n  model {\n    id\n  }\n  floor {\n    id\n  }\n  room {\n    id\n  }\n  layer @include(if: $includeLayers) { id } \n  enabled\n  label\n  confidence\n  region {\n    ... on VectorRegion {\n      anchorPosition {\n        x, y, z\n      }\n      stemNormal {\n        x, y, z\n      }\n      stemLength\n    }\n  }\n  tag {\n    id\n  }\n  keywords\n  classification {\n    id,\n    label,\n    defaultKeywords\n  }\n}\n",name:"GraphQL request",locationOffset:{line:1,column:1}};function i(e,t){if("FragmentSpread"===e.kind)t.add(e.name.value);else if("VariableDefinition"===e.kind){var n=e.type;"NamedType"===n.kind&&t.add(n.name.value)}e.selectionSet&&e.selectionSet.selections.forEach((function(e){i(e,t)})),e.variableDefinitions&&e.variableDefinitions.forEach((function(e){i(e,t)})),e.definitions&&e.definitions.forEach((function(e){i(e,t)}))}var n={};function s(e,t){for(var i=0;i<e.definitions.length;i++){var n=e.definitions[i];if(n.name&&n.name.value==t)return n}}function a(e,t){var i={kind:e.kind,definitions:[s(e,t)]};e.hasOwnProperty("loc")&&(i.loc=e.loc);var a=n[t]||new Set,o=new Set,r=new Set;for(a.forEach((function(e){r.add(e)}));r.size>0;){var d=r;r=new Set,d.forEach((function(e){o.has(e)||(o.add(e),(n[e]||new Set).forEach((function(e){r.add(e)})))}))}return o.forEach((function(t){var n=s(e,t);n&&i.definitions.push(n)})),i}t.definitions.forEach((function(e){if(e.name){var t=new Set;i(e,t),n[e.name.value]=t}})),e.exports=t,e.exports.GetObjectAnnotations=a(t,"GetObjectAnnotations"),e.exports.AddObjectAnnotation=a(t,"AddObjectAnnotation"),e.exports.PatchObjectAnnotation=a(t,"PatchObjectAnnotation"),e.exports.SetBulkObjectAnnotationsEnabled=a(t,"SetBulkObjectAnnotationsEnabled"),e.exports.DeleteObjectAnnotation=a(t,"DeleteObjectAnnotation"),e.exports.ObjectAnnotationInfo=a(t,"ObjectAnnotationInfo")}}]);